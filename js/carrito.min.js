/**
 * Archivo: carrito.min.js
 *
 * Version: 1.0.3
 * Fecha  : 03/02/2024
 *
 * © Manuel Sánchez (www.elmaestroweb.es)
 *
*/
var carrito_domicilio = { direccion: "", complementario: "", cod_postal: "", poblacion: "", provincia: "", envio: "0", minimo: "0" },
    carrito_invitado = { tratamiento: "1", nombre: "", apellidos: "", fecha_nacimiento: "", telefono: "", email: "", publicidad: "0" },
    carritohtml = "",
    carritoSubtotal = 0,
    carritoBase = 0,
    carritoIva = 0,
    
    totalItemCarrito = 0,
    miLocalStorage = window.localStorage;
if (window.localStorage.getItem("carrito_invitado")!=null) {
    carrito_invitado=JSON.parse(miLocalStorage.getItem("carrito_invitado"  ));
    
}


var carrito = [];


//carritoEdad = new Date(),
if (window.localStorage.getItem("carritoEdad")!=null) {
    var carritoEdad=localStorage.getItem("carritoEdad"  );
}
else {
    var carritoEdad = new Date();
    localStorage.setItem("carritoEdad", carritoEdad );
}




miLocalStorage.setItem("carrito_invitado", JSON.stringify(carrito_invitado));
cargarCarritoDeLocalStorage();
calcularTotal();
renderizarCarrito();

var totalItemCarrito = calcularTotal();

function muestraCarrito() {
    navegar('#view-carrito');
    $("#carrito-page").html(carritohtml);
    
    //$("#panel-cart").html(carritohtml), app.panel.get(".panel-right").open();
}
function guardarCarritoEnLocalStorage() {
    miLocalStorage.setItem("carrito", JSON.stringify(carrito));
    console.log(reglamaximo);
}
function cargarCarritoDeLocalStorage() {
    null !== miLocalStorage.getItem("carrito") && (carrito = JSON.parse(miLocalStorage.getItem("carrito")));
    
    for (var j=0;j<reglamaximo.length;j++){
        reglamaximo[j]['cantidad']=0;
    }

    for (var x=0;x<carrito.length;x++) {
        for (var j=0;j<reglamaximo.length;j++){
            if (reglamaximo[j]['tipo']==1){
                if (carrito[x]['id']==reglamaximo[j]['id']){
                    reglamaximo[j]['cantidad']+=carrito[x]['cantidad'];
                }
            }
            else {
                if (carrito[x]['categoria']==reglamaximo[j]['id']){
                    reglamaximo[j]['cantidad']+=carrito[x]['cantidad'];
                }
            }
        }
    }
    
}




function renderizarCarrito() {
    
    // carrito.push({id:id,nombre:nombre,precio:precio,cantidad:1,iva:iva,img:img});
    
    var txt='';
    //console.log(carrito);
    var txt_menu='';
    var ver_menu='';
    for (var x=0;x<carrito.length;x++) {
        
            if (carrito[x]['menu']<2) {
                //if (x>0){
                    txt+='<hr>';
                //}
            }

        var extras="";
        if (carrito[x]['menu']==0) {
            if (typeof carrito[x]['modificadores'] !== "undefined") {
                var modis=carrito[x]['modificadores'];     
                if (modis.length>0){   
                    for (y=0;y<modis.length;y++){
                        extras+=modis[y]['nombre']+', ';
                    }    
                    extras=extras.slice(0, -2);
                }
            }
            
        }
        if (extras!=""){
            extras='<br><span style="font-size:.9em;">'+
                extras+'</span>';
        }


    

        var sumar='<div class="text-align-center" onclick="addCarrito2('+x+');" data-id="'+carrito[x]['id']+'" style="width:10%;"><i class="icon f7-icons size-26 color-green">plus_circle</i></div>';
        if (carrito[x]['menu']==1){
            sumar='<div class="text-align-center" onclick="addCarritoMenu2('+x+',1);" data-id="'+carrito[x]['id']+'" style="width:10%;"><i class="icon f7-icons size-26 color-green">plus_circle</i></div>';
        }
        var restar='<div class="text-align-center"  style="width:10%;"></div>';;
        var borrar='<div class="text-align-center" onclick="borrarItemCarrito('+x+');" data-id="'+carrito[x]['id']+'" style="width:10%;"><i class="icon f7-icons color-red size-26">trash</i></div>';
        if (carrito[x]['menu']!=1) {
            txt_menu='';
            ver_menu='';
        }
        else {
            txt_menu='<i class="icons material-icons size-16">restaurant</i> ';
            //ver_menu=' <i class="icons f7-icons size-16 '+carrito[x]['elmentMenu']+'" onclick="verItemsMenu(\''+carrito[x]['elmentMenu']+'\');">chevron_down</i>';
        }
        if (carrito[x]['menu']==0) { //no son elementos del menu
            if (carrito[x]['cantidad']>1){

                restar='<div class="text-align-center" onclick="restarCarrito('+x+');" data-id="'+carrito[x]['id']+'" style="width:10%;"><i class="icon f7-icons size-26 color-red">minus_circle</i></div>';
            }
            
        }
        if (carrito[x]['menu']==1) { //no son elementos del menu
            if (carrito[x]['cantidad']>1){

                restar='<div class="text-align-center" onclick="addCarritoMenu2('+x+',-1);" data-id="'+carrito[x]['id']+'" style="width:10%;"><i class="icon f7-icons size-26 color-red">minus_circle</i></div>';
            }
            
        }
        
        

        
        
        txt+='<div style="display: flex;">'+
                '<div class="" style="width:10%;><span style="font-size:1.3em;">'+
                carrito[x]['cantidad']+'</span></div>'+
                '<div class="" style="width:60%;"><span style="font-size: 1.2em;font-weight: 600;">'+txt_menu+carrito[x]['nombre']+ver_menu+'</span>'+
                extras+'<br><span class="text-color-primary" style="font-size:1.2em;">'+parseFloat(carrito[x]['precio']).toFixed(2)+'€</span><br><span class="text-color-primary" style="font-size:.9em;font-style: italic;">'+carrito[x]['comentario']+'</span></div>'+ 
            
                restar+ 
                sumar+ 
                borrar+'</div>';
        //(carrito[x]['cantidad']*parseFloat(carrito[x]['precio'])).toFixed(2) Total=carritoSubtotal
        if (carrito[x]['menu']==1) {
            var elem=carrito[x]['elmentosMenu'];  
            
            for (j=0;j<elem.length;j++){
                txt+='<div style="display: flex;">'+
                '<div class="text-align-center" style="width:10%;"></div><div style="width:10%;><span style="">'+
                elem[j]['cantidad']+'</span></div>'+
                '<div class="" style="width:60%;"><span style="font-size: 1.1em;font-weight: 400;">'+elem[j]['nombre']+'</span></div>'+ 
                '<div class="text-align-center" style="width:10%;"></div>'+ 
                '<div class="text-align-center" style="width:10%;"></div>'+'</div>';                      
            }
            
        }
 
    }


    txt+='<hr><br>'+
        '<button class="button button-outline button-round" style="margin: auto;width: 60%;font-size: 1.2em!important;">Total&nbsp; &nbsp; <span style="font-weight: 800;">'+carritoSubtotal.toFixed(2)+'€</span></button>';

    // Ver limite de compra
    txt_seguir='<br><div class="" style="display: flex;">'+
                '<div class="text-align-center" style="width:60%;margin:auto;"><button class="button button-fill button-round" style="font-size:.9em;height: 35px;" onclick="seguir();">Seguir comprando</button></div>';
    txt_finalizar='<div class="text-align-center" style="width:5%;"></div>'+
                '<div class="text-align-center" style="width:35%;"><button class="button button-fill button-round"  onclick="terminar();" style="font-size:.9em;height: 35px;">Finalizar</button></div>'+
            '</div>';  
    txt_vaciar='<br><div class=""><div class="text-align-center" style="margin:auto;width:60%;"><button class="button button-fill button-round text-align-center" style="font-size:.9em;background-color: '+colorsecundario+';" onclick="vaciar();"><i class="icon f7-icons if-not-md size-20">trash</i> ¿Vaciar carrito?</button></div></div>';
    carritohtml=txt+txt_seguir+txt_finalizar+txt_vaciar;

    if (carrito.length==0){
        carritohtml='<p>Carrito vacío</p>'+txt_seguir;
    }
     $("#carrito-page").html('<div class="block-title block-title-medium"> Tu pedido</div>'+carritohtml);
}

function addCarritoMenu2(x,cantidad){
    var elementos=0;
    for (var j=0;j<reglamaximo.length;j++) {
        if (reglamaximo[j]['tipo']==1){
            if (carrito[x]['id']==reglamaximo[j]['id']){
               if ((reglamaximo[j]['cantidad']+cantidad)>reglamaximo[j]['max']) {
                  //error 
                   app.dialog.alert('El máximo de <b>'+reglamaximo[j]['nombre']+'</b> para el carro es de <b>'+reglamaximo[j]['max']+'</b>.<br>Hay <b>'+reglamaximo[j]['cantidad']+ '</b> en el carro.');
                   return;
               }
               reglamaximo[j]['cantidad']+=cantidad;
                
                
            }
        }
        else {
            if (carrito[x]['categoria']==reglamaximo[j]['id']){
               if ((reglamaximo[j]['cantidad']+cantidad)>reglamaximo[j]['max']) {
                  //error 
                   
                   app.dialog.alert('El máximo de <b>'+reglamaximo[j]['nombre']+'</b> para el carro es de <b>'+reglamaximo[j]['max']+'</b>.<br>Hay <b>'+reglamaximo[j]['cantidad']+ '</b> en el carro.');
                   return;
               }
               reglamaximo[j]['cantidad']+=cantidad; 
            }
        }
        
    }
    
    
    if (cantidad>0){
        for (var y=0;y<carrito.length;y++) {
            elementos+=carrito[y]['cantidad'];
        }

        
        if (elementos>maximocarrito){
            app.dialog.alert('El máximo de artículos para el carrto es de <b>'+maximocarrito+'</b> productos');
            return;
        }
    }
    var hay=carrito[x]['cantidad'];
    var ahora=0;
    carrito[x]['cantidad']=carrito[x]['cantidad']+cantidad;
    var ahora=carrito[x]['cantidad'];
    elem=carrito[x]['elmentosMenu']; 

    for (j=0;j<elem.length;j++){
        elem[j]['cantidad']=(elem[j]['cantidad']/hay)*ahora;
        
    }
    calcularTotal();
    guardarCarritoEnLocalStorage();
    renderizarCarrito();

}


if ( ((Date.parse(new Date())-Date.parse(carritoEdad))/1000)> (12 * 60 * 60 )){
    // (24 * 60 * 60 )=1 día
    vaciarCarrito();
}

function seguir() {
    //app.panel.close();
    navegar('#view-catalog');
}

function vaciar(){
    app.dialog.confirm('¿Desea vacia el carrito?', function () {
        carrito=[];
          calcularTotal();
    guardarCarritoEnLocalStorage();
    renderizarCarrito();
        });
    
}


function addCarrito (e, cantidad=1,comentario) {
    var elementos=0;
    

    //e.getAttribute('data-id')
    for (var x=0;x<reglamaximo.length;x++) {
        if (reglamaximo[x]['tipo']==1){
            if (e.getAttribute('data-id')==reglamaximo[x]['id']){
               if ((reglamaximo[x]['cantidad']+cantidad)>reglamaximo[x]['max']) {
                  //error 
                   app.dialog.alert('El máximo de <b>'+reglamaximo[x]['nombre']+'</b> para el carro es de <b>'+reglamaximo[x]['max']+'</b>.<br>Hay <b>'+reglamaximo[x]['cantidad']+ '</b> en el carro.');
                   return;
               }
               reglamaximo[x]['cantidad']+=cantidad;
               
                
            }
        }
        else {
            if (e.getAttribute('data-categoria')==reglamaximo[x]['id']){
               if ((reglamaximo[x]['cantidad']+cantidad)>reglamaximo[x]['max']) {
                  //error 
                   
                   app.dialog.alert('El máximo de <b>'+reglamaximo[x]['nombre']+'</b> para el carro es de <b>'+reglamaximo[x]['max']+'</b>.<br>Hay <b>'+reglamaximo[x]['cantidad']+ '</b> en el carro.');
                   return;
               }
               reglamaximo[x]['cantidad']+=cantidad; 
            }
        }
        
    }
    
    
    for (var x=0;x<carrito.length;x++) {
        elementos+=carrito[x]['cantidad'];
        
        
    }
    
    

    
    //elementos+=cantidad;
    var ahora=new Date();
    if ((elementos+cantidad)>maximocarrito){
        app.dialog.alert('El máximo de artículos para el carro es de <b>'+maximocarrito+'</b> productos.<br>Hay <b>'+elementos+ '</b> en el carro.');
        return;
    }
    
    carritoEdad=ahora;
    localStorage.setItem("carritoEdad", carritoEdad );
    //console.log(carritoEdad);
    var id=e.getAttribute('data-id');
    var nombre=e.getAttribute('data-nombre');
    var precio=e.getAttribute('data-precio');
    var precio_sin=e.getAttribute('data-sin');
    var iva=e.getAttribute('data-iva');
    var img=e.getAttribute('data-img');
    var mod=e.getAttribute('data-modificadores');
    var cat=e.getAttribute('data-categoria');
    //console.log(mod);
    const obj = JSON.parse(mod);
    //console.log(obj);
    var nuevoA=Array();
    for (var clave in obj) {
        if(obj[clave]==""){
         delete obj[clave] //eliminamos solo las claves vacias
        }
        else {
            //console.log(obj[clave]);
            var elem=obj[clave];
            if (Array.isArray(elem)){
                for (x=0;x< elem.length;x++) {
                    var split=elem[x].split('#');
                    nuevoA.push({id:split[0],nombre:split[2], precio:split[1]});
                }
                
            }
            else {
                var split=elem.split('#')
                nuevoA.push({id:split[0],nombre:split[2], precio:split[1]});
            }
            //var split=obj[clave].split('#')
            //nuevoA.push({id:split[0],nombre:split[0], precio:split[1]});
        }
      }
    //console.log(nuevoA);
    //console.log(comentario);
    var existe='no';
    for (var x=0;x<carrito.length;x++) {
        
        if ((carrito[x]['id']==id)&&(carrito[x]['menu']==0)){
            if (comentario!='') {
                //console.log('hay comentario, nuevo');
                existe='no';
                break;

            }
            
            if (nuevoA.length>0){
                //console.log('hay mod, nuevo');
                existe='no';
                break;
            }
            if ((carrito[x]['id']==id)&&(carrito[x]['menu']==0)){
            //existe sumamos
                //console.log('existe');
                if (carrito[x]['modificadores'].length>0) {
                    existe='no';
                    break;
                    
                }
                if (carrito[x]['comentario']!=''){
                    //console.log('Tenia comentario, nuevo');
                    existe='no';
                    break;
                }
                else {
                    //console.log('sin comentario, añadir');
                    existe='si';
                    carrito[x]['cantidad']+=cantidad;
                    break;
                }
                
            }
        }

    }
    if (existe=='no'){
        carrito.push({id:id,nombre:nombre,precio:precio, precio_sin:precio_sin,cantidad:cantidad,iva:iva,img:img,menu:0,elmentMenu:0,comentario:comentario,modificadores:nuevoA,categoria:cat});
    }    
    //carrito.push({id:id,nombre:nombre,precio:precio,cantidad:1});
    
    /*
    var extras="";
        if (mod!=null){
            var elecciones=JSON.parse(mod);
            var cant=Object.values(elecciones).length;
            var valores = Object.values(elecciones);
            
            for (y=0;y<cant;y++){
                var tipo=elecciones['tipo_'+y];
                
                if(Array.isArray(tipo)){
                    for (j=0;j<tipo.length;j++){
                        var split=tipo[j].split('#')
                        extras+=split[2]+', ';
                    }           
                }
                else {           
                    var split=tipo.split('#')
                    extras+=split[2]+', ';
                }                   
            }
            extras=extras.slice(0, -2);           
        }   
    */
    app.toolbar.show('.toolbar-bottom');
    var href = $('#link-volver-producto').attr('href');
    //$('#boton-menu-principal').show();
    //var cart = $('.i-carrito');
  // find the img of that card which button is clicked by user
    //bloque-producto
    
    
  
   
        //Select item image and pass to the function
        $('#add-to-cart').hide();
    $('.toolbar-bottom').show();
    


    
    
        var cart = $('.i-carrito');
    
        var imgtodrag = $("#img-prod");
    var eltoDrag = $("#img-prod");
    var target=$('.i-carrito');
    
    
 
          var imgclone = eltoDrag.clone()
                .offset({
                top: eltoDrag.offset().top,
                left: eltoDrag.offset().left
            })
                .css({
                    'opacity': '0.7',
                    'position': 'absolute',
                    'height': eltoDrag.height() /2,
                    'width': eltoDrag.width() /2,
                    'z-index': '999999'
                    //,'border-radius':'50%'
            })
                .appendTo($('#app'))
                .animate({
                    'top': target.offset().top - 10,
                    'left': target.offset().left - 15,
                    'height': eltoDrag.height() /3,
                    'width': eltoDrag.width() /3
            }, 1000);
            


    
            imgclone.animate({
                'width': 0,
                'height': 0
            }, function () {
                $(this).detach()
            });
      
      

    setTimeout(function(){
        calcularTotal();
    guardarCarritoEnLocalStorage();
    renderizarCarrito();
      eval(href);
    }, 1500);
    
    
    
    
    
    
    
    var anchobadage=$('.badage-cart').css('width');
    var leftbadage=$('.badage-cart').css('left');
    var altobadage=$('.badage-cart').css('height');
    var sizebadage=$('.badage-cart').css('font-size');
    var pesobadage=$('.badage-cart').css('font-weight');
    var textobadage=$('.badage-cart').html();
    
    /*
    app.popover.open('.popover-cart');
    $('.popover-cart').css('top','initial');
    $('.popover-cart').css('left','initial');
    
    setTimeout(function(){
        app.popover.close();
    }, 2000);    
    */
      
    
    
    
    cancelarcompra2();
}

function addCarrito2 (e, cantidad=1) {
    var elementos=0;
    
    for (var x=0;x<reglamaximo.length;x++) {
        if (reglamaximo[x]['tipo']==1){
            if (carrito[e]['id']==reglamaximo[x]['id']){
               if ((reglamaximo[x]['cantidad']+cantidad)>reglamaximo[x]['max']) {
                  //error 
                   app.dialog.alert('El máximo de <b>'+reglamaximo[x]['nombre']+'</b> para el carro es de <b>'+reglamaximo[x]['max']+'</b>.<br>Hay <b>'+reglamaximo[x]['cantidad']+ '</b> en el carro.');
                   return;
               }
               reglamaximo[x]['cantidad']+=cantidad;
                
                
            }
        }
        else {
            if (carrito[e]['categoria']==reglamaximo[x]['id']){
               if ((reglamaximo[x]['cantidad']+cantidad)>reglamaximo[x]['max']) {
                  //error 
                   
                   app.dialog.alert('El máximo de <b>'+reglamaximo[x]['nombre']+'</b> para el carro es de <b>'+reglamaximo[x]['max']+'</b>.<br>Hay <b>'+reglamaximo[x]['cantidad']+ '</b> en el carro.');
                   return;
               }
               reglamaximo[x]['cantidad']+=cantidad; 
            }
        }
        
    }
    
    
    for (var x=0;x<carrito.length;x++) {
        elementos+=carrito[x]['cantidad'];
        
    }

    
    var ahora=new Date();
    if (elementos>=maximocarrito){
        app.dialog.alert('El máximo de artículos para el carrto es de <b>'+maximocarrito+'</b> productos');
        return;
    }
    
    
    // carritoEdad
    //console.log(ahora);
    
    carritoEdad=ahora;
    localStorage.setItem("carritoEdad", carritoEdad );
    
    //var id=e.getAttribute('data-id');
    
    var hay=1;
    var padre='';
    for (var x=0;x<carrito.length;x++) {
        if (x==e){
            
            //existe sumamos
            existe='si';
            hay=carrito[x]['cantidad'];
            padre=carrito[x]['elmentMenu'];
            carrito[x]['cantidad']+=cantidad;
        }
        if ((carrito[x]['padre']==padre)&&(padre!=0)){
            
            var sumar=carrito[x]['cantidad']/hay;
            carrito[x]['cantidad']+=sumar;
        }
    }
      
    //carrito.push({id:id,nombre:nombre,precio:precio,cantidad:1});
    calcularTotal();
    guardarCarritoEnLocalStorage();
    renderizarCarrito();
    cancelarcompra2();
    
}

function restarCarrito (e, cantidad=1) {
    var ahora=new Date();
    // carritoEdad
    //console.log(ahora);
    var edad = ((Date.parse(ahora)-Date.parse(carritoEdad))/1000);
    //console.log(edad);
    //(24 * 60 * 60 * 1000)
    if (edad>(24 * 60 * 60 )) {
        //borrar carrito edad>43200
        vaciarCarrito();
        //muestraMensaje('Los artículos del carrito se borraron por inactividad',titulo='',subtitulo='Atención');
       //console.log('carrito vacio'); 
        
    }
    carritoEdad=ahora;
    localStorage.setItem("carritoEdad", carritoEdad );
    
    
    for (var x=0;x<reglamaximo.length;x++) {
        if (reglamaximo[x]['tipo']==1){
            if (carrito[e]['id']==reglamaximo[x]['id']){
                reglamaximo[x]['cantidad']-=cantidad;   
            }
        }
        else {
            if (carrito[e]['categoria']==reglamaximo[x]['id']){
                reglamaximo[x]['cantidad']-=cantidad;
            }
        }
        
    }
    
    
    //var id=e.getAttribute('data-id');
    var hay=1;
    var existe='no';
    var padre='';
    for (var x=0;x<carrito.length;x++) {
        
        if (x==e){
            //existe sumamos
            existe='si';
            hay=carrito[x]['cantidad'];
            carrito[x]['cantidad']-=cantidad;
            
            padre=carrito[x]['elmentMenu'];
            if (carrito[x]['cantidad']==0){
                borrarItemCarrito(e);
                
            }
            
        }
        if ((carrito[x]['padre']==padre)&&(padre!=0)){
            //console.log('padre: '+hay);
            //console.log('Producto: '+carrito[x]['nombre']);
            //console.log('hay: '+carrito[x]['cantidad']);
            var borrar=carrito[x]['cantidad']/hay;
            //console.log('a borrar: '+borrar);
            carrito[x]['cantidad']-=borrar;
            //console.log('quedan: '+carrito[x]['cantidad']);
        }
    }
    
    //carrito.push({id:id,nombre:nombre,precio:precio,cantidad:1});
    calcularTotal();
    guardarCarritoEnLocalStorage();
    renderizarCarrito();
    cancelarcompra2();
     
}

function borrarItemCarrito(e) {
    var idaborrar=e;
    var temp=[];
    var padre='';
    
    for (var x=0;x<reglamaximo.length;x++) {
        if (reglamaximo[x]['tipo']==1){
            if (carrito[idaborrar]['id']==reglamaximo[x]['id']){
                reglamaximo[x]['cantidad']-=carrito[idaborrar]['cantidad'];   
            }
        }
        else {
            if (carrito[idaborrar]['categoria']==reglamaximo[x]['id']){
                reglamaximo[x]['cantidad']-=carrito[idaborrar]['cantidad']; 
            }
        }
        
    }
    
    for (var x=0;x<carrito.length;x++) {
        if (x==e){
            padre=carrito[x]['elmentMenu'];
            
        }
        
        
        if (x!=e){ 
            if ((carrito[x]['padre']!=padre)||(carrito[x]['menu']<2)){ 
                temp.push(carrito[x]);
                //temp.push({id:carrito[x]['id'],nombre:carrito[x]['nombre'],precio:carrito[x]['precio'],cantidad:carrito[x]['cantidad'],iva:carrito[x]['iva'],img:carrito[x]['img'],mod:carrito[x]['mod'],comentario:carrito[x]['comentario'],menu:carrito[x]['menu'],padre:carrito[x]['padre'],elmentMenu:carrito[x]['elmentMenu']});
            }
        }
    }
    carrito=temp;
    calcularTotal();
    guardarCarritoEnLocalStorage();
    renderizarCarrito();
    if (carritoSubtotal==0){
        app.panel.close();
        cancelarcompra2();
    }
}

function cancelarcompra2(){
    carrito_domicilio['direccion'] = "";
    carrito_domicilio['complementario'] = "";
    carrito_domicilio['cod_postal'] = "";
    carrito_domicilio['poblacion'] = "";
    carrito_domicilio['provincia'] = "";
    carrito_domicilio['envio'] = "0";
    descuento=0;
    
    /*
    $('.subnavbar').show();
    $('#search').show();
    
    $('#buy-page').hide();     
    $('#catalog-page').show();
    muestragrupos();
    */

    
}

function calcularTotal() {
    for (var r = 0, a = 0, t = 0, i = 0, o = 0; o < carrito.length; o++) {
        var c = parseFloat(carrito[o].precio) * carrito[o].cantidad,
            e = (c / (parseFloat(carrito[o].iva) + 100)) * 100;
        (i += (e * parseFloat(carrito[o].iva)) / 100), (t += e), (a += c), (r += carrito[o].cantidad);
    }
    return (
        (totalItemCarrito = r),
        guardarCarritoEnLocalStorage(),
        (carritoSubtotal = a),
        (carritoBase = t),
        (carritoIva = i),
        $(".badage-cart").html(totalItemCarrito),
        $("#badage_cart").html(totalItemCarrito),
        $("#badage_cart2").html(totalItemCarrito),
        totalItemCarrito > 0 ? ($(".badage-cart").show(), $("#badage_cart").show(), $("#badage_cart2").show()) : ($(".badage-cart").hide(), $("#badage_cart").hide(), $("#badage_cart2").hide()),
        totalItemCarrito
    );
}

function vaciarCarrito() {
    (carrito = []), renderizarCarrito(), calcularTotal(), localStorage.removeItem("carrito");
}


function guardarConExpiracion(key, value) {
    const data = { 'data': value, 'fecha': new Date() };
    localStorage.setItem(key, data)
}

function buscarConExpiracion(key) {
   const data = localStorage.getItem(key);
   const fecha = new Date();
    if (window.localStorage.getItem(key)!=null) {
       if (fecha - data.fecha > (24 * 60 * 60 * 1000)) { // un dia en ms
         localStorage.removeItem(key);
           guardarConExpiracion('carritoEdad', false);
         return null;
       } else {
        return data.data;
       }
    }
    else {
        return null;
    }
}
/*
$(".popover-cart").on("popover:open", function (r) {
    0 == totalItemCarrito ? $("#popover-cart").html("<p>Carrito vac\xedo</p>") : (app.popover.close(".popover-cart"), muestraCarrito());
});
*/







function flyToElement(flyer, flyingTo) {
    var $func = $(this);
    var divider = 3;
    var flyerClone = $(flyer).clone();
    $(flyerClone).css({position: 'absolute', top: $(flyer).offset().top + "px", left: $(flyer).offset().left + "px", opacity: 1, 'z-index': 1000});
    $('body').append($(flyerClone));
    var gotoX = $(flyingTo).offset().left + ($(flyingTo).width() / 2) - ($(flyer).width()/divider)/2;
    var gotoY = $(flyingTo).offset().top + ($(flyingTo).height() / 2) - ($(flyer).height()/divider)/2;
     
    $(flyerClone).animate({
        opacity: 0.4,
        left: gotoX,
        top: gotoY,
        width: $(flyer).width()/divider,
        height: $(flyer).height()/divider
    }, 700,
    function () {
        $(flyingTo).fadeOut('fast', function () {
            $(flyingTo).fadeIn('fast', function () {
                $(flyerClone).fadeOut('fast', function () {
                    $(flyerClone).remove();
                });
            });
        });
    });
}
