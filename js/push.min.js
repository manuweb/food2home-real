
/**
 * Archivo: push.js
 *
 * Version: 1.0.1
 * Fecha  : 02/10/2023
 *
 * © Manuel Sánchez (www.elmaestroweb.es)
 *
*/

function registro_telefono(idtel,plataforma,version,fabricante, modelo){
    /*
      app.dialog.alert("Idtel:"+idtel);
      console.log("Idtel:"+idtel);
                  app.dialog.alert("Servidor:"+server);
            
      */
    var server=servidor+'includesapp/registro_telefono.php';
    var user=0;
    if ("user" in localStorage) {
      user=window.localStorage.getItem("user");
   
    }
    var push=verificasipush();
    window.localStorage.setItem("estado_push",push);
    
    app.request.postJSON(server, { idtel:idtel, plataforma:plataforma, version:version, fabricante:fabricante, modelo:modelo, user:user,push:push},
        function (data) {
            app.dialog.close();
            var obj=Object(data);
            if (obj.valid==true){
                window.localStorage.setItem("telefono_registrado","si");
                telefono_registrado='si';
                //app.dialog.alert("Su telefono se ha registrado en la app");
            }
            else {
                //app.dialog.alert("Su telefono no se ha podido registrar en la app");
            }
                               
        },
        function (xhr, status) {

    });

}

function verificasipush()  {
    PushNotification.hasPermission(function(data) {
        console.log("Permitido Push:"+data.isEnabled);
       

        var ponerPush='<i class="icon f7-icons ">bell_slash</i><i class="icon f7-icons color-red icon-tooltip if-ios">info_fill</i> <i class="icon material-icons color-red icon-tooltip if-md">info</i>';
        if (data.isEnabled) {
            ponerPush='<i class="icon f7-icons">bell</i><i class="icon f7-icons color-green">checkmark</i>';
        }
        $('#span-estado-push').html(ponerPush);
        var iconTooltip = app.tooltip.create({
          targetEl: '.icon-tooltip',
          text: textoTolltipPush,
        });
        return data.isEnabled;
        
    });
       
}

//////////// Push
function setupPush() {
    var estado_push=verificasipush();

    console.log('calling push init');
    var push = PushNotification.init({
        "android": {
            "senderID": "1082641118846"
        },
        "browser": {},
        "ios": {
            "sound": true,
            "vibration": true,
            "badge": true
        },
        "windows": {}
    });

    console.log('after init');
    
    // verificasipush();

    push.on('registration', function(data) {
        
        //app.dialog.alert('registration event: ' + data.registrationId);
        console.log('registration event: ' + data.registrationId);
        //window.localStorage.setItem("quieropush", 'si');
        window.localStorage.setItem("idtel", data.registrationId);
        //window.localStorage.setItem("registrado","si");
        var fabricante = device.manufacturer;
        var modelo = device.model;
        var plataforma = device.platform;
        var version = device.version;
        var idtel=data.registrationId;
        
        
        //// ---> REGISTRO
        var server=servidor+'includesapp/registro_telefono.php';
        
        if (window.localStorage.getItem("telefono_registrado")!=null) {
            telefono_registrado=window.localStorage.getItem("telefono_registrado");
        }
        else {
            window.localStorage.setItem("telefono_registrado","no");
                
        }
        var estado_push=verificasipush();
        window.localStorage.setItem("estado_push",estado_push);
        window.localStorage.setItem("idtel",idtel);
            
        var user=0;
        if ("user" in localStorage) {
          user=window.localStorage.getItem("user");

        }

        app.request.postJSON(server, { idtel:idtel, plataforma:plataforma, version:version, fabricante:fabricante, modelo:modelo, user:user, push:window.localStorage.getItem("estado_push")},
            function (data) {
                app.dialog.close();
                var obj=Object(data);
                if (obj.valid==true){
                    window.localStorage.setItem("telefono_registrado","si");
                }

            },
            function (xhr, status) {

        });
          

       // console.log('Telefono registrado');
        
    });

    push.on('error', function(e) {
        console.log("push error = " + e.message);
                                            
        //alert("push error = " + e.message);

    });

    push.on('notification', function(data) {
        console.log('notification event');


        
       cordova.plugins.notification.badge.set(0);
        
        var json = JSON.parse(JSON.stringify(data.additionalData));
        // aqui puedo hacer tipos en función de json.key o json.loquesea
        
        //app.dialog.alert('<b>'+data.title+'</b>.<br>'+data.message, 'Mensaje recibido');



        //console.log(data);
        var body="";
        if (data.message){
            body=data.message;
         }
         else {
            body=data.body;
         }
        //console.log(data);
        var img="";
        if (device.platform=='iOS') {
            navigator.vibrate(1000);

            if (json.data['attachment-url']){
                img=json.data['attachment-url'];
                 body+='<br><br><div style="text-align:center;"><img src="'+img+'" width="90%" height="auto"></div>';

            }
         }
        else {
            var sound=new Audio("sound/note.mp3");
            sound.play();
            if ( data.image){
                img=data.image;
                body+='<br><br><div style="text-align:center;"><img src="'+img+'" width="90%" height="auto"></div>';
            }
        }

        if (json.key.substring(0,1)=='2'){
            // ver articulo

        }
        // json.key -> valor 1-Normal, 2- Mensaje de amigo, 3-añadido amigo, json.key.substring(0,1)=="4" - Evento, json.key.substring(0,1)=="5" - caseta,



        var not=app.notification.create({
                   // myApp.alert('<b>'+data.title+'</b>.<br>'+data.message, 'Atención');

            icon: '<img src="img/icon.png" width="22px" height="auto">',
            title: app.name,
            subtitle: data.title,
            titleRightText: 'ahora',
            //subtitle: 'Notificación con cierre con clic',
            text: body,
            closeOnClick: true,
            closeTimeout:6000,
            on: {
                close: function () {


                    not.$el.remove();

              //app.dialog.alert('Notificación cerrada');
                },
                click: function () {
                if (json.key.substring(0,1)=='2'){
                        // ver articulo
                        var arti=json.key.split('-');
                        navegar('#view-catalog');
                        muestraproductoinicio(arti[1]);

                    }

                    not.$el.remove();
            }
            },

        });
        not.open();
 
        
        //alert(data.title+":"+data.message);

   });
}



const firebaseConfig = {
  apiKey: "AIzaSyDTJEP4N_vrLGeCL6UNEugYVC3VxhnCLJc",
  authDomain: "food2home-de837.firebaseapp.com",
  projectId: "food2home-de837",
  storageBucket: "food2home-de837.appspot.com",
  messagingSenderId: "225977212904",
  appId: "1:225977212904:web:a1261548a05f7e7f328e5d"
};


// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const messaging = firebase.messaging();


if(isApp==false){  
    
        if(getBrowserInfo()=='safari'){
            
        }
        else {
            pedirPermiso();
        }
        if (getBrowserInfo()=='firefox'){
            pedirPermiso();
        }
        
        let enableForegroundNotification=true;
        messaging.onMessage(function(payload){


            if(enableForegroundNotification){
                //console.log(payload.data.notification);
                try {
                    const trimmedNotification = payload.data.notification.trim();
                    const notificationData = JSON.parse(trimmedNotification);
                    const {title, ...options}=notificationData;
                    
                    navigator.serviceWorker.getRegistrations().then( registration =>{
                        registration[0].showNotification(title, options);
                    });
                    
                    // Resto del código para mostrar la notificación
                } catch (error) {
                    console.error('Error al parsear JSON:', error);
                }
                
            }   

        });

}

var token=window.localStorage.getItem("token");




function pedirPermiso(){
    
    messaging.requestPermission()
    .then(function(){
        //console.log("Se han haceptado las notificaciones");
        //push-status
        $('#push-status').attr('checked','checked');
        return messaging.getToken();
        //console.log('Token:'+messaging.getToken());
    }).then(function(token){
        //console.log('Token:'+token);
        window.localStorage.setItem("token", token);
        guardaToken(token);
        
        
    }).catch(function(err){
        //console.log('No se ha recibido el permiso');
        $('#push-status').prop('checked',false);
        
         
    });
}

$('#push-status').click(function(){
    var estado=$('#push-status').prop('checked');
    if (getBrowserInfo()=='firefox'){
        if (estado==true){
            //$('#push-status').prop('checked',false);
            pedirPermiso();
        }
    }  
});

function guardaToken(token) {
    //console.log('Token guardado:'+token);
    
    var usuario=0;
    if (window.localStorage.getItem('user') !== undefined
        && window.localStorage.getItem('user')
      ) {
        usuario=window.localStorage.getItem("user");
    }
    if (usuario!=""){
        usuario=desencripta(usuario);
    }
    
    if (token==''){
        return;
    }
    
    //console.log('usuario:'+usuario);
    var server=servidor+'includes/registro_token.php';
    $.ajax({
        url: server,
        data:{token:token, usuario:usuario},
        method: "post",
        dataType:"json",
        success: function(data){ 
            var obj=Object(data);
            if (obj.valid==true){
            }
        },
                error: function (xhr, ajaxOptions, thrownError){
                    console.log(xhr.status);
                    console.log(thrownError);
                  }
    });
}

function getBrowserInfo() {
    var usrAg = navigator.userAgent;    
    usrAg = usrAg.toLowerCase();  
    switch (true){
        
        case (/Edge/.test(navigator.userAgent)):
            naveg = "edge";
            break;

        case (/Google Inc/.test(navigator.vendor)):
            naveg = "chrome";
            break;        
        case (usrAg.indexOf("opr") > -1):
            naveg = "opera";
            break;
        case (typeof InstallTrigger !== 'undefined'):
            naveg = "firefox";
            break;
        case (/Safari/.test(navigator.userAgent)):
            naveg = "safari";
            break;
        defaul:
           naveg = "Desconocido"
    }
    return naveg
};