/**
 * Archivo: tienda.min.js
 *
 * Version: 1.0.6
 * Fecha  : 13/07/2023
 *
 * © Manuel Sánchez (www.elmaestroweb.es)
 *
*/

function muestraproductoinicio(id) {
    var tienda=0;
    if (localStorage.getItem("tiendaSeleccionada") != null) {
        tienda=desencripta(localStorage.getItem("tiendaSeleccionada"));
    }
    var server=servidor+'includes/leeproductossearch.php';
    $.ajax({
        type: "POST",
        url: server,
        data: {isapp:isApp,id:id,tienda:tienda},
        dataType:"json",
        success: function(data){
            var obj=Object(data);
            
            if (obj.valid==true){

                
                var id=obj.id[0];
                var nombre=obj.nombre[0];
                var precio=obj.precio_web[0];
                if (isApp){
                    var precio=obj.precio_app[0];
                }
                var cat_id=obj.cat_id[0];
                var gru_id=obj.gru_id[0];
                var cat_nombre=obj.cat_nombre[0];
                var gru_nombre=obj.gru_nombre[0];
                var modifierCategories=obj.modifier_category_id[0];
                var modifierGroups=obj.modifier_group_id[0];
                var iva=obj.iva[0];
                muestraelproducto(id,nombre,gru_id,gru_nombre,cat_id,cat_nombre,modifierCategories,iva);
            }
           
            else{
                muestraMensaje('No se pudo leer los productos',titulo='',subtitulo='Error');
            }
          
        },
        error: function (xhr, ajaxOptions, thrownError) {
            console.log(xhr.status);
            console.log(thrownError);
        }
    });
}
        
function muestraproductossearch() {
    var tienda=0;
    if (localStorage.getItem("tiendaSeleccionada") != null) {
        tienda=desencripta(localStorage.getItem("tiendaSeleccionada"));
    }
        
    var server=servidor+'includes/leeproductossearch.php';
     $.ajax({
        type: "POST",
        url: server,
        data: {isapp:isApp, tienda:tienda},
        dataType:"json",
        success: function(data){
            var obj=Object(data);
            if (obj.valid==true){
                var id=obj.id;
                var nombre=obj.nombre;
                var precio=obj.precio_web;
                if (isApp){
                    var precio=obj.precio_app;
                }
                var cat_id=obj.cat_id;
                var gru_id=obj.gru_id;
                var cat_nombre=obj.cat_nombre;
                var gru_nombre=obj.gru_nombre;
                var modifierCategories=obj.modifier_category_id;
                var modifierGroups=obj.modifier_group_id;
                var iva=obj.iva;
                var txt='<ul>';
                for(x=0;x<nombre.length;x++){
                    var txt_1='<li class="item-content">'+
                        '<div class="item-inner">'+
                          '<div class="item-title" onclick="muestraproductoelegido(\''+id[x]+'\',\''+nombre[x]+'\',\''+gru_id[x]+'\',\''+gru_nombre[x]+'\',\''+cat_id[x]+'\',\''+cat_nombre[x]+'\',\''+modifierCategories[x]+'\',\''+iva[x]+'\');">'+nombre[x]+'</div>'+
                        '</div>'+
                      '</li>';
                    txt+=txt_1;
                }
                txt+='</ul>';
                $('#lista-productos').html(txt);
            }
            else{
                muestraMensaje('No se pudo leer los productos',titulo='',subtitulo='Error');
            }
        },
        error: function (xhr, ajaxOptions, thrownError) {
            console.log(xhr.status);
            console.log(thrownError);
        }
     });   
}

function muestraproductoelegido (id,nombre,idgrupo,nombregrupo,idcategoria,nombrecategoria,modifierCategories,iva){
    //alert(nombre);
    app.searchbar.toggle();
    muestraelproducto(id,nombre,idgrupo,nombregrupo,idcategoria,nombrecategoria,modifierCategories,iva) ; 
     
}

var txt_sel_tienda='';

function muestragrupos() {  
    //app.toolbar.show('.toolbar-bottom');
    //$('#boton-menu-principal').show();
    $('.toolbar-bottom').show();
    if (localStorage.getItem("miLat") === null) {
        
        
    }
    var txt_tienda='';
    //console.log(tiendas);

    if (tiendas.length>1){
        txt_sel_tienda='<div class="block-title">Seleccione tu <b>'+app.name+'</b></div>'+
                '<div class="list list-outline-ios list-strong-ios list-dividers-ios media-list">'+
                    '<ul>';
        var distancia=0;
        //console.log(tiendas);
        for (x=0;x<tiendas.length;x++){

            
            distancia=calcularDistanciaEntreDosCoordenadas(tiendas[x]['lat'],tiendas[x]['lng'],localStorage.getItem("miPosLat"),localStorage.getItem("miPosLng")).toFixed(2);
            tiendas[x]['distancia']=distancia;
        }
    
        tiendas=tiendas.sort(function(a,b){
            if (a['distancia']===b['distancia']) {
                return 0;
            }
            else {
                return (a['distancia']<b['distancia'])?1:-1;
            }
        });
        //console.log(tiendas);
        
        for (x=0;x<tiendas.length;x++){
            //distancia=(distancia/1000).toFixed(2);
            //console.log('Lat '+tiendas[x]['alias']+' - '+parseFloat(tiendas[x]['lat']));
            //console.log('Lng '+tiendas[x]['alias']+' - '+parseFloat(tiendas[x]['lng']));
            txt_sel_tienda+='<li>'+
                '<div class="item-content" onclick="seleccionaTienda('+tiendas[x]['id']+')">'+
                    '<div class="item-media"><img style="border-radius: 8px" src="img/icon.png" width="40" />'+
                    '</div>'+
                    '<div class="item-inner">'+
                        '<div class="item-title-row">'+
                            '<div class="item-title" style="color:'+colorsecundario+';">'+tiendas[x]['alias']+'</div>'+
                '<div class="item-after" style="font-size: 14px;"> <i class="icon f7-icons size-14" style="top: 3px;">location_fill</i> '+tiendas[x]['distancia']+' Km</div>'+
                        '</div>'+
                        '<div class="item-subtitle">'+tiendas[x]['domicilio']+'</div>'+
                    '</div>'+
                '</div>'+
            '</li>';

        }
        txt_sel_tienda+='</ul></div>';
        

        if (localStorage.getItem("tiendaSeleccionada") === null) {

            
            $('#catalog-page').html(txt_sel_tienda);
            return;

            
        }
        else {
            var latienda=desencripta(localStorage.getItem("tiendaSeleccionada"));

            var pos = tiendas.map(e => e.id).indexOf(latienda);

            txt_tienda='<div id="seleccion-tienda"><div class="block-title block-title-medium">Tu <span style="color:'+colorprimario+';"><b>'+app.name+'</b></span>:</div>';
            
            txt_tienda+='<div class="list list-outline-ios list-strong-ios list-dividers-ios media-list" style="margin-bottom: 12px;">'+
                    '<ul><li><a class="item-link item-content" onclick="cambiaTienda();">';
            txt_tienda+='<div class="item-media"><img style="border-radius: 8px" src="img/icon.png" width="40" />'+
                        '</div>'+
                        '<div class="item-inner">'+
                            '<div class="item-title-row">'+
                                '<div class="item-title" style="color:'+colorsecundario+';">'+tiendas[pos]['alias']+'</div>'+
                            '</div>'+
                            '<div class="item-subtitle">'+tiendas[pos]['domicilio']+'</div>'+
                        '</div>'+
 
                '</a></li>';
            txt_tienda+='</ul></div></div>';
            
            
        }
    }
    var tienda=0;
    if (localStorage.getItem("tiendaSeleccionada") != null) {
        tienda=desencripta(localStorage.getItem("tiendaSeleccionada"));
    }
    
    //console.log('Tienda:'+desencripta(localStorage.getItem("tiendaSeleccionada")));
    
    muestraproductossearch();

    var server=servidor+'includes/leegrupo.php';
    $.ajax({
        type: "POST",
        url: server,
        data: {id:'',isapp:isApp,colorprimario:colorprimario, tienda:tienda},
        dataType:"json",
        success: function(data){
            var obj=Object(data);
            if (obj.valid==true){

                var id=obj.id;
                var nombre=obj.nombre;
                var imagen=obj.imagen;
                var texto=obj.texto;
                var imagen_app=obj.imagen_app;
                var cartaMenu="";
                columna=0;
                var imgUsar="";
                var txt="</p>";

                var searchbar = app.searchbar.create({
                    el: '.searchbar',
                    searchContainer: '#lista-productos',
                    searchIn: '.item-title',
                    on: {
                        search(sb, query, previousQuery) {
                        },
                        disable(){
                            $('#lista-productos').hide();
                            $('#no-encontrado').hide();
                        }
                    },

                });

                $('#catalog-page').html(txt_tienda+texto);
                
                if (id.length==1){
                    muestracategorias(id[0],nombre[0]);
                }
                
                //destacados();
                $('#catalog-page').show();
                $('#buy-page').hide();
                $('#icon-back').hide();
                $('#titulo-menus').html('Menús');
                destacadosinicio('catalog-page','catalogo');
                

            }
            else{
                muestraMensaje('No se pudo leer el grupo de productos', titulo='', subtitulo='Error');
            }                           
        },
        error: function (xhr, ajaxOptions, thrownError) {
            console.log(xhr.status);
            console.log(thrownError);
        }
    });     
  
 
}

function seleccionaTienda(x){
    localStorage.setItem("tiendaSeleccionada",encripta(x));
    muestragrupos();
}

function cambiaTienda(){
    //seleccion-tienda
    $('#seleccion-tienda').html(txt_sel_tienda);
}

/*
function destacados() {

    //console.log('pongo destacado');
    var server=servidor+'includesapp/leedestacados.php';
    app.request.postJSON(server, {isapp:isApp}, 
        function (data) {
            var obj=Object(data);
            if (obj.valid==true){
                if (document.getElementById("prod-destacados") !== null) {
                        return;
                }

                $('#catalog-page').prepend("<p class='block-title'>Destacados</p><div id='prod-destacados'></div>");
                
                var id=obj.id;
                var producto=obj.producto;
                var nombre=obj.nombre;
                var cat=obj.cat;
                var gru=obj.gru;
                var idcat=obj.idcat;
                var idgru=obj.idgru;
                var imagen=obj.imagen;
                var txt=''+
                '<div data-space-between="10" data-slides-per-view="auto" data-centered-slides="true" class="swiper swiper-init" style="display: flex;justify-content: center;align-items: center;">'+
                    '<div class="swiper-pagination"></div>'+
                    '<div class="swiper-wrapper">';
                for (x=0;x<id.length;x++){
                    var lin= "'"+producto[x]+"','"+nombre[x]+"','"+idgru[x]+"','"+gru[x]+"','"+idcat[x]+"','"+cat[x]+"',' ',0";

                    txt+=''+
                        '<div class="swiper-slide" onclick="muestraelproducto('+lin+');">'+
                            '<img src="'+imagen[x]+'" width="200px" height="auto" style="border-radius:10px;"><br>'+nombre[x]+'<br><span style="color: gray; font-size: 11px;">'+gru[x]+' - '+cat[x]+'</span></div>';
                }
                txt+=''+
                    '</div>'+
                '</div><br>';
                $('#prod-destacados').html(txt);
                app.swiper.create('.swiper', {
					allowTouchMove:true,
					//pagination: {
					//	  el: '.swiper-pagination',
					//	  type: 'bullets',
					//	},
                    width:210,
                    loop:true,
                    autoplay: {
                       delay: 3000,
                     },
					}
				);
                
                
            }
   
        },
        function (xhr, status) {   
            
    });      
    
}
*/

function muestracategorias(idgrupo,nombregrupo) { 
    //app.toolbar.show('.toolbar-bottom');
    //$('#boton-menu-principal').show();
    //console.log('mostrando categorias');
    $('.toolbar-bottom').show();
    var tienda=0;
    if (localStorage.getItem("tiendaSeleccionada") != null) {
        tienda=desencripta(localStorage.getItem("tiendaSeleccionada"));
    }
    var server=servidor+'includes/leecategorias.php';
    $.ajax({
        type: "POST",
        url: server,
        data: {grupo:idgrupo,nombregrupo:nombregrupo,isapp:isApp,colorprimario:colorprimario,tienda:tienda},
        dataType:"json",
        success: function(data){
            var obj=Object(data);
            if (obj.valid==true){
                var id=obj.id;
                var nombre=obj.nombre;
                var imagen=obj.imagen;
                var imagen_app=obj.imagen_app;
                var texto=obj.texto;
                var columna=0;
                var imgUsar="";
                var txt='<p><span style="font-size:1.2em;"><a href="javascript:muestragrupos();" class="item-link">'+nameBreadcum+'</a> / '+nombregrupo.charAt(0).toUpperCase()+nombregrupo.slice(1).toLocaleLowerCase()+"</span></p>";
                
                
                // breadcums
                if (breadcrumbs==0){
                    txt='';
                    
                }
                //destacados();
                $('#titulo-menus').html(nombregrupo);
                $('#icon-back').show();
                 document.getElementById("link-volver").href = 'javascript:muestragrupos();';
                
                $('#catalog-page').html(txt+texto);
                destacadosinicio('catalog-page','catalogo');
                if (obj.id.length==1){
                    muestraproductos(idgrupo,nombregrupo,obj.id[0],obj.nombre[0],1);
                }
                
                
                
            }
            else{
                
                muestraMensaje('No se pudo leer el grupo de productos', titulo='', subtitulo='Error');
            }
        },
        error: function (e){
            console.log('error');
        }
    });     
    
}

function muestraproductos(idgrupo,nombregrupo,idcategoria,nombrecategoria,volver=0) {
    //app.dialog.alert('leido productos');
    //app.toolbar.show('.toolbar-bottom');
    //$('#boton-menu-principal').show();
    $('.toolbar-bottom').show();
    var tienda=0;
    if (localStorage.getItem("tiendaSeleccionada") != null) {
        tienda=desencripta(localStorage.getItem("tiendaSeleccionada"));
    }
    var server=servidor+'includes/leeproductos.php';
    $.ajax({
        type: "POST",
        url: server,
        data: {idcategoria:idcategoria,isapp:isApp,idgrupo:idgrupo,nombregrupo:nombregrupo,nombrecategoria:nombrecategoria,colorprimario:colorprimario,tienda:tienda},
        dataType:"json",
        success: function(data){
            var obj=Object(data);
            if (obj.valid==true){

                var id=obj.id;
                var nombre=obj.nombre;
                var precio=obj.precio_web;
                if (isApp){
                    var precio=obj.precio_app;
                }
                var modifierCategories=obj.modifier_category_id;
                var modifi=obj.modifi;
                var modifierGroups=obj.modifier_group_id;
                var iva=obj.iva;
                var imagen=obj.imagen;
                var imagen_app1=obj.imagen_app1;
                var texto=obj.texto;
                var totCategorias=obj.totCategorias;
                var txt='<p><span style="font-size:1.2em;"><a href="javascript:muestragrupos();" class="item-link">'+nameBreadcum+'</a> / <a href="javascript:muestracategorias(\''+idgrupo+'\',\''+nombregrupo+'\');" class="item-link">'+nombregrupo.charAt(0).toUpperCase()+nombregrupo.slice(1).toLocaleLowerCase()+"</a> / "+nombrecategoria.charAt(0).toUpperCase()+nombrecategoria.slice(1).toLocaleLowerCase()+"</span></p>";
                
                // breadcums
                if (breadcrumbs==0){
                    txt='';
                    
                }
                $('#catalog-page').html(txt+texto);
                
                $('#titulo-menus').html(nombrecategoria);
                $('#icon-back').show();
                
                document.getElementById("link-volver").href = 'javascript:muestracategorias("'+idgrupo+'","'+nombregrupo+'");';
                
                
                if ((volver==1)||(totCategorias==1)){
                    document.getElementById("link-volver").href = 'javascript:muestragrupos();';
                }
            }
            else{
                console.log(obj);
                muestraMensaje('No se pudo leer los productos',titulo='',subtitulo='Error');
            }
        },
        error: function (xhr, ajaxOptions, thrownError) {
            console.log(xhr.status);
            console.log(thrownError);
        }
    }); 
}

function muestraelproducto(id,nombre,idgrupo,nombregrupo,idcategoria,nombrecategoria,modifierCategories="", iva ) {

    
    //app.dialog.alert('Producto:'+nombre);
    var tienda=0;
    if (localStorage.getItem("tiendaSeleccionada") != null) {
        tienda=desencripta(localStorage.getItem("tiendaSeleccionada"));
    }
    var server=servidor+'includes/leeproducto.php';
    $.ajax({
        type: "POST",
        url: server,
        data: {id:id,idgrupo:idgrupo,nombregrupo:nombregrupo,idcategoria:idcategoria,nombrecategoria:nombrecategoria, anchopantalla:screen.width,isapp:isApp,colorprimario:colorprimario,colorsecundario:colorsecundario, tienda:tienda},
        dataType:"json",
        success: function(data){
            var obj=Object(data);
            if (obj.valid==true){
                
                var imagen=obj.imagen;
                var texto=obj.texto;
                var modifierCategories=obj.modifierCategories;
                var modifiers=obj.modifiers;
                var modifi=obj.modifi;
                var precio=obj.precio;
                var background=obj.background;
                var link_volver=obj.link_volver;
                var alergenos=obj.txt_aler;
                var esMenu=obj.esMenu;
                
                
                app.tab.show("#view-producto");
                
                $("#pagina-producto").html(texto);
                document.getElementById("link-volver-producto").href = 'javascript:app.tab.show("#view-catalog");muestraproductos("'+idgrupo+'","'+nombregrupo+'",'+idcategoria+',"'+nombrecategoria+'");';
                
                
                var alerTooltip = app.tooltip.create({
                    targetEl: '.tip-alergenos',
                    text: alergenos
                });
                $('.tabbar-icons').hide();
                
                //app.toolbar.hide('.toolbar-bottom');
                //$('#boton-menu-principal').hide();
                //$('#stepper-producto').hide();
                //app.dialog.alert('Categoria:'+idcategoria+' - '+nombrecategoria);
                document.getElementById('add-to-cart').setAttribute('data-categoria',idcategoria);
                
                if (modifierCategories!=null){
                    
                   
                    if (modifi=='1'){
                        modifierCategories=new Array;
                        document.getElementById('add-to-cart').setAttribute('data-modificadores','{&quot;forzoso&quot;:&quot;0&quot;}');
                    }
                    //console.log('Modificadores:');
                    //console.log(modifierCategories);    
                    cambiamodificador(precio,modifierCategories.length,id);
                    
                }
                else {
                    $('#add-to-cart').removeClass('button-fill');
                    $('#add-to-cart').removeClass('disabled');
                    $('#add-to-cart').removeClass('color-white');
                    $('#add-to-cart').addClass('button-fill');
                    $('#stepper-producto').show();
                    
                }
                if (carrito.length>0){
                    $(".badage-cart").show();
                    $(".badage-cart").html(totalItemCarrito);
                }
                if (esMenu==1){
                    $('#stepper-producto').hide();
                    $('#add-to-cart').removeClass('button-fill');
                    $('#add-to-cart').addClass('disabled');
                }
                if (background=='si'){
                    /*
                    $("#pagina-producto").css('background-image','url('+imagen+')');
                    $("#pagina-producto").css('background-repeat','no-repeat');
                    $("#pagina-producto").css('background-attachment','fixed');
                    $("#pagina-producto").css('background-size','100% auto');
                    
                    var w = screen.width; 
                    var ancho_app=$("#app").css('width');
                    //console.log('ancho pantalla:'+ancho_app);
                    getBackgroundImageSize($('#pagina-producto'))
                        .then(function(size) {
                        bgImgHeight=size.height;
                            bgImgWidth = size.width;
                            var h=parseInt(ancho_app)*bgImgHeight/bgImgWidth;
                        //console.log(h);
                            $("#pagina-producto").css('padding-top',(h-65)+'px');
                            
                        
                        })

                        .fail(function() {
                            console.log('error'+bgImgHeight);
                    });
                    */
                    
                    //$('#view-producto navbar').css('z-index')
                
                }
            }
            else{
                muestraMensaje('No se pudo leer el producto',titulo='',subtitulo='Error');
            }
        },
        error: function (xhr, ajaxOptions, thrownError) {
            console.log(xhr.status);
            console.log(thrownError);
        }
    });
  
}

var getBackgroundImageSize = function(el) {
    var imageUrl = $(el).css('background-image').match(/^url\(["']?(.+?)["']?\)$/);
    var dfd = new $.Deferred();

    if (imageUrl) {
        var image = new Image();
        image.onload = dfd.resolve;
        image.onerror = dfd.reject;
        image.src = imageUrl[1];
    } else {
        dfd.reject();
    }

    return dfd.then(function() {
        return { width: this.width, height: this.height };
    });
};

function miraMaximoElegible(e, o) {
    var r = $("#opciones-multiples-" + e + " :selected").length;
    if (o > 0 && r > o) {
        document.getElementById("opciones-multiples-" + e).options;
        var t = app.smartSelect.get("#smart-multiples-" + e);
        muestraMensaje("Elija máximo " + o + " opciones", (titulo = ""), (subtitulo = "Por favor")),
            t.unsetValue(),
            t.close(),
            $("#item-after-multiples-" + e).remove(),
            $("#item-title-multiples-" + e).after('<div  class="item-after" id="item-after-multiples-' + e + '"></div>');
    }
}

function muestramodificador(e, x){
    //console.log(e.value);
    //console.log('x:'+x);
    if ($('#but-mod-'+x).attr('data-forzoso')=='1'){
        var valor=$('#from-producto input[name=forzoso]').val();
        $('#from-producto input[name=forzoso]').val(valor-1);
    }
    
    $('#but-mod-'+x).html('<i class="icon f7-icons size-22" style="    float: right;color: '+colorprimario+';font-weight:800;">checkmark</i>');
    var elecciones=JSON.parse(JSON.stringify(app.form.convertToData('#from-producto')));
    //console.log(elecciones);
    if ($('#from-producto input[name=forzoso]').val()=='0'){
        $('#add-to-cart').removeClass('button-fill');
        $('#add-to-cart').removeClass('disabled');
        $('#add-to-cart').removeClass('color-white');
        $('#add-to-cart').addClass('button-fill');
        $('#stepper-producto').show();
    }
    
}

function cambiamodificador(precio,cant,idProd){
    //console.log(cant);
    
    var modificadores="";
    var cantidad=1;
    if ($('#cantidadProducto').html()!=''){
        cantidad=parseInt($('#cantidadProducto').html());
    }
    var valor=0;   
    //console.log(app.form.convertToData('#from-producto'));
    var elecciones=JSON.parse(JSON.stringify(app.form.convertToData('#from-producto')));
    //console.log(elecciones);
    for (x=0;x<cant;x++){
        
        var tipo=elecciones['tipo_'+x];
        //console.log(tipo);
        if(Array.isArray(tipo)){

            for (j=0;j<tipo.length;j++){

                var split=tipo[j].split('#')
                valor+=parseFloat(split[1]);    
                //console.log('aumenta:'+parseFloat(split[1]));
                modificadores+=split+'-';    
            }           
        }
        else { 
            if (tipo!=undefined) {
            var split=tipo.split('#')
            valor+=parseFloat(split[1]);
            modificadores+=split+'-';    
            $('#tipo_'+x).html((split[2]));   
            }
        } 
    }

    modificadores=modificadores.slice(0, -1);
    var precioaMostrar=cantidad*(parseFloat(precio)+valor);
    $('#precio-producto').html(precioaMostrar.toFixed(2)+'€');

    //document.getElementById('add-to-cart').setAttribute('data-id',idProd+'-'+modificadores);
    document.getElementById('add-to-cart').setAttribute('data-id',idProd);
    document.getElementById('add-to-cart').setAttribute('data-precio',(parseFloat(precio)+valor).toFixed(2));
    document.getElementById('add-to-cart').setAttribute('data-modificadores',JSON.stringify(app.form.convertToData('#from-producto')));
    
}

function SumaUno() {
    var cantidad=parseInt($('#cantidadProducto').val());
    var partes=$('#precio-producto').html().split("€");
    var precio=parseFloat(partes)/cantidad;
    var nuevo=(cantidad+1)*precio;
    if (cantidad<98) {
        $('#cantidadProducto').val(cantidad+1);
        $('#precio-producto').html(nuevo.toFixed(2)+'€');      
    }
}

function RestaUno() {
    var cantidad=parseInt($('#cantidadProducto').val());  
    var partes=$('#precio-producto').html().split("€");
    var precio=parseFloat(partes)/cantidad;
    var nuevo=(cantidad-1)*precio;
    if (cantidad>1) {
        $('#cantidadProducto').val(cantidad-1);
        $('#precio-producto').html(nuevo.toFixed(2)+'€');
    }
}

function addCarritodesdeproducto(e) {

    //app.toolbar.show('.toolbar-bottom'); 
    
    var precio=$('#add-to-cart').attr('data-precio');
    var esMenu=$('#add-to-cart').attr('data-esmenu');
    if (esMenu==5){
       
        var nombre=$('#nombre-para-tarjeta').val();
        var email=$('#email-para-tarjeta').val();
        if(!validarEmail(email) && email!='') {
            txt='Email erroneo';
            if (multiIdioma==1){
                txt=traducciones[findIdioma('error-email')]['texto'];
            }
             muestraMensaje(txt,titulo='',subtitulo='ERROR'); 
            $('#email-para-tarjeta').val('')
            return;
          
        }
        if (email!='' && nombre==''){
            txt='Ponga nombre de la tarjeta';
            
             muestraMensaje(txt,titulo='',subtitulo='ERROR'); 
            return;
        }
        $('#add-to-cart').attr('data-nombre-tarjeta',nombre);
        $('#add-to-cart').attr('data-email-tarjeta',email)
    }
    
    var comentario=$('#comentario-prod').val();
    var cantidad=parseInt($('#cantidadProducto').val()); 
    
    //console.log(e)
    var modificadores=$('#add-to-cart').attr('data-modificadores');

    //modificadores.replace('"forzoso":"0"', "");
    const obj = JSON.parse(modificadores);

    delete obj.forzoso;
    
    modificadores=JSON.stringify(obj);
    $('#add-to-cart').attr('data-modificadores',modificadores)
    addCarrito(e,cantidad,comentario);
    $('#cantidadProducto').val('1');
    $('#precio-producto').html(precio);
    
    
}

function evaluatextomsgprod() {  
    $('#caracteres').css('color',colorprimario); 
    var texto=document.getElementById("comentario-prod").value;
     document.getElementById("caracteres").innerHTML=(140-texto.length);
    if(texto.length>140){
        document.getElementById("comentario-prod").value=texto.substring(0,texto.length-1);
        document.getElementById("caracteres").innerHTML='0';
    }
}


