/**
 * Archivo: comprar.min.js
 *
 * Version: 1.1.1
 * Fecha  : 29/01/2024
 *
 * © Manuel Sánchez (www.elmaestroweb.es)
 *
*/

var descuento=0;
var tipo_descuento="";
var cupon_usado="";
var monedero_a_usar=0;
var metodosdepago=new Array();
var diasreparto=new Array();
var diascocina=new Array();
var disponiblereparto=new Array();
var disponiblecocina=new Array();
var tipo_envio=1;
var hora_envio='';
var fecha_pedido='';


//leemetodospago();
//leehorariosreparto();
/*
app.tab.show('#view-checkout');
    app.toolbar.hide('.toolbar-bottom');
    $('#boton-menu-principal').hide();
*/
function terminar() {
    app.tab.show('#view-checkout');
    $('.toolbar-bottom').hide();

    $('#boton-menu-principal').hide();
    
    $('#checkout-page').html('');
    leemetodospago();
    leehorariosreparto();

    checkout_1();
    
}

function checkout_1(){
    var txt=progresscheckout(1);
    var txtcarro=mostrarcarrito();
    var txt_descuento='';
    var txt_monedero='';
    var cantidad='1 artículo';
    $('#icon-back-checkout').hide(); 
    document.getElementById("link-volver-checkout").href = "#";
    if (carrito.length>1){
        cantidad=carrito.length+' artículos';
    }
    /*
    if (descuento>0){
        
        txt_descuento='<span class="text-color-red">Descuento<span style="float:right;">-'+(descuento).toFixed(2)+'€</span></span><br>';
    }
    if (monedero_a_usar>0){
        var subtotal=carritoSubtotal-descuento+parseFloat(carrito_domicilio['envio']);
        if(monedero_a_usar>subtotal) {
            monedero_a_usar=subtotal;
            console.log('cambio valor');
            $('#valor-monedero-usar').html(monedero_a_usar.toFixed(2));
            
        }
        txt_monedero='<span class="text-color-red">Fidelización<span style="float:right;">-'+(monedero_a_usar).toFixed(2)+'€</span></span><br>';
    }
    /*
    var cart='<span><b>Total (impuestos inc.)</b><span style="float:right;font-size: 1.3em;"><b>'+
    (carritoSubtotal+parseFloat(carrito_domicilio['envio'])-descuento-monedero_a_usar).toFixed(2)+'€</b></span></span><br><br>';
    */
    var cart='<span><b>Total (impuestos inc.)</b><span style="float:right;font-size: 1.3em;"><b>'+
    (carritoSubtotal).toFixed(2)+'€</b></span></span><br><br>';
    txt_boton1='<button class="button button-fill button-round"  onclick="checkout_2();" id="boton-checkout" style="font-size:.9em;width:80%;margin:auto;height: 35px;" >CONTINUAR</button><br>';
    txt_botoncancelar='<button class="button button-fill button-round"  onclick="cancelacheckout();" style="font-size:.9em;width:60%;margin:auto;background-color: '+colorsecundario+';" >Volver al carrito</button>';
    
    $('#checkout-page').html(txt+txtcarro+cart+txt_boton1+txt_botoncancelar);
    var minimo=window.localStorage.getItem("pedido_minimo");
    //app.dialog.alert('checkout');
    
    
    if (parseFloat(carritoSubtotal)<parseFloat(minimo)){
        muestraMensaje('El importe no llega al mínimo ('+minimo+' €)',titulo='',subtitulo='Importe mínimo');
        $("#boton-checkout").hide();
        return;
    }   
    
}

function checkout_2(){

    var txt=progresscheckout(2);
    $('#checkout-page').html(txt);
    
    $('#icon-back-checkout').show(); 
    document.getElementById("link-volver-checkout").href = "javascript:checkout_1();";
    
    
    var txt_1='<div id="usuario-compras" style="font-size:16px;">';  

    if (window.localStorage.getItem("username")!=""){
        
        txt_1+='<p>Nombre completo:</p>'+
            '<p><b>'+$('#my-form-usu input[name*="nombre"]').val()+' '+$('#my-form-usu input[name*="apellidos"]').val()+'</b></p>'+
            '<p>Email:</p>'+
            '<p><b>'+desencripta(window.localStorage.getItem("username"))+'</b></p>';
         txt_1+='<div class="grid grid-cols-2 grid-gap"><div class="button button-raised button-round" onclick="cierrasesioncompra();" style="font-size:11px;height: 35px;"><i class="f7-icons ">power</i>Cerrar sesión</div> <div class="button button-fill button-round" onclick="checkout_3();" style="height: 35px;">Continuar</div></div>'; 
       
    }
    else {
        txt_1+=iniciosesioncompra();
        /*
        txt_1+='<div class="row"><div class="col">¿Tiene cuenta?</div><div class="col"> <button class="button button-fill button-round" onclick="iniciosesioncompra();">Iniciar Sesión</buton></div></div><br>';
        txt_1+=txt_compra_form;  
        */
    }
    txt_1+='</div>';
    var txt_botoncancelar='<br><button class="button button-fill color-red button-round"  onclick="cancelacheckout();" style="font-size:.8em;width:60%;margin:auto;background-color: '+colorsecundario+';" >Volver al carrito</button>';
    
    $('#checkout-page').html(txt+txt_1+txt_botoncancelar);
    if (window.localStorage.getItem("username")==""){
        
        var start=new Date();
        start.setFullYear(start.getFullYear()-18);
        calendarNacimientoCompras = app.calendar.create({
            inputEl: '#nacimiento-compras',
            value: [start],
            openIn: 'customModal',
            //header: true,
            closeOnSelect:true,
            dateFormat: 'dd/mm/yyyy'
            //footer: true,
        });

        
        if(carrito_invitado['tratamiento']=='1'){
            $('#tratamiento-sr').attr('checked', true); 

        }
        
        else {
            $('#tratamiento-sra').attr('checked', true); 

        }
        

        $('#my-form-usu-compra input[name*="nombre"]').val(carrito_invitado['nombre']);
        $('#my-form-usu-compra input[name*="apellidos"]').val(carrito_invitado['apellidos']);
        $('#my-form-usu-compra input[name*="nacimiento"]').val(carrito_invitado['fecha_nacimiento']);
        $('#my-form-usu-compra input[name*="telefono"]').val(carrito_invitado['telefono']);
        $('#my-form-usu-compra input[name*="email"]').val(carrito_invitado['email']);
        if(carrito_invitado['publicidad']=='1'){
            $('#my-form-usu-compra input[name*="publi-checkbox"]').prop('checked', true); 
            
        }


    }
    //console.log('usuario-compras PUESTO')
}

function continuainvitado(tipo){
    var txt_1='';
    txt_1+=txt_compra_form;  
    $('#usuario-compras').html(txt_1);
    if (tipo==0){
        $('#crear-cuenta-nuevo').hide();
        $('#titulo-nuevo-usu-compras').html('Nuevo usuario');
    }
    else {
        $("#pass-nuevo-usu").hide();
        $('#crear-cuenta-nuevo').hide();
        $('#titulo-nuevo-usu-compras').html('Invitado');
    }
    carrito_domicilio = {direccion:'',complementario:'',cod_postal:'',poblacion:'',provincia:'',coordenadas:{lat:0,lng:0}, envio:'0', minimo:'0'};

    window.localStorage.setItem("registrado",encripta("no"));
    window.localStorage.setItem("username",''); 
    window.localStorage.setItem("mi_monedero",encripta('0')); 
    window.localStorage.setItem("porcentaje_fidelizacion",encripta('0')); 
    window.localStorage.setItem("user",''); 
    $('#login-inicio').show();
    $('#usu-inicio').hide(); 
    
    var start=new Date();
    start.setFullYear(start.getFullYear()-18);
    calendarNacimientoCompras = app.calendar.create({
        inputEl: '#nacimiento-compras',
        value: [start],
        openIn: 'customModal',
        //header: true,
        closeOnSelect:true,
        dateFormat: 'dd/mm/yyyy'
        //footer: true,
    });


    if(carrito_invitado['tratamiento']=='1'){
        $('#tratamiento-sr').attr('checked', true); 

    }

    else {
        $('#tratamiento-sra').attr('checked', true); 

    }


    $('#my-form-usu-compra input[name*="nombre"]').val(carrito_invitado['nombre']);
    $('#my-form-usu-compra input[name*="apellidos"]').val(carrito_invitado['apellidos']);
    $('#my-form-usu-compra input[name*="nacimiento"]').val(carrito_invitado['fecha_nacimiento']);
    $('#my-form-usu-compra input[name*="telefono"]').val(carrito_invitado['telefono']);
    $('#my-form-usu-compra input[name*="email"]').val(carrito_invitado['email']);
    if(carrito_invitado['publicidad']=='1'){
        $('#my-form-usu-compra input[name*="publi-checkbox"]').prop('checked', true); 

    }
    
    $('#privacidad-checkbox').change(function () {
        var estado=$(this).prop( "checked");
        if (estado){
            $('#boton-continuar-nuevo-usuario').removeClass('button-outline');
            $('#boton-continuar-nuevo-usuario').addClass('button-fill');
            $('#boton-continuar-nuevo-usuario').attr('onclick','nuevoUsuCompra();');
        }
        else {
            $('#boton-continuar-nuevo-usuario').attr('onclick','');
            $('#boton-continuar-nuevo-usuario').removeClass('button-fill');
            $('#boton-continuar-nuevo-usuario').addClass('button-outline');
        }
        
    });
}

function cierrasesioncompra(){
    //console.log('cierra sesion');
    //var txt_1='<div class="row"><div class="col">¿Tiene cuenta?</div><div class="col"> <button class="button button-fill button-round" onclick="iniciosesioncompra();">Iniciar Sesión</buton></div></div><br>';
    window.localStorage.setItem("registrado",encripta("no"));

    
    window.localStorage.setItem("username",''); 
    window.localStorage.setItem("mi_monedero",encripta('0')); 
    window.localStorage.setItem("porcentaje_fidelizacion",encripta(por_fidelizacion)); 
    window.localStorage.setItem("user",''); 
    $('#login-inicio').show();
    $('#usu-inicio').hide(); 
    
    
    checkout_2();
}

function iniciosesioncompra(){
    //console.log('inicio sesion');
    var txt_1='<div class="login-screen-content" id="my-login-screen2">'+
            //'<div class="login-screen-title">Acceso</div>'+
            '<div class="list login-screen-content">'+
                '<ul>'+
                    '<li class="item-content item-input">'+
                      '<div class="item-inner">'+
                        '<div class="item-title item-label">Usuario</div>'+
                        '<div class="item-input-wrap">'+
                          '<input type="text" name="username" placeholder="Email"/>'+
                        '</div>'+
                      '</div>'+
                    '</li>'+
                    '<li class="item-content item-input">'+
                      '<div class="item-inner">'+
                        '<div class="item-title item-label">Contraseña</div>'+
        
                        '<div class="item-input-wrap">'+
                            '<input type="password" name="password" id="campo-clave7" placeholder="Contraseña" style="margin-bottom: -25px;"/>'+
                            '<div style="float:right;position: relative;top:-15px;right:10px;;"><i class="f7-icons size-22 campo-clave7" onclick="muestraOcultaClave(\'campo-clave7\');">eye_slash</i></div>'+
                        '</div>'+
                      '</div>'+
                    '</li>'+
                  '</ul>'+
                '</div>'+
                '<div class="list" style="margin-top:-15px;">'+
                  '<ul>'+
                    '<li>'+
                      '<button class="button button-fill button-round" style="width:50%;margin: auto;" onclick="accederdesdecompras();">Acceder</button>'+
                    '</li>'+
                  '</ul>'+
                 '</div>'  +  
                '<div class="block-footer text-color-red" id="error-login-compras" style="display:none;">Error en usuario y contraseña</div>'+
                  '<div class="block-footer"><a href="javascript:RecuperarClave();">¿Olvidó su contraseña?</a><br></div>'+
        '<div class="block-footer" style="font-size:18px;">No tengo cuenta, <a href="#" onclick="continuainvitado(0);" class="button button-fill button-round" style="margin:auto;width: 50%;"><b>crearme una.</b></a></div>'+
                '<hr><br>'+
                '<div class="block-footer "><button class="button button-fill button-round" style="width:70%;margin: auto;height: 35px;" onclick="continuainvitado(1);">Continuar como invitado</button></div>'+
            '</div>';
    return txt_1;
    //$('#usuario-compras').html(txt_1);
}

function accederdesdecompras() {
    //console.log('accede desde compra');
    var username = $('#my-login-screen2 [name="username"]').val();
    var password = $('#my-login-screen2 [name="password"]').val();
    var server=servidor+'includes/login.php';
    $.ajax({
        url: server,
        data:{username:username, password: password},
        method: "post",
        dataType:"json",
        success: function(data){ 
            var obj=Object(data);
            
            if (obj.valid==true){
                window.localStorage.setItem("registrado",encripta("si)"));
                window.localStorage.setItem("username",encripta(username));
                window.localStorage.setItem("mi_monedero",encripta(obj.monedero));
                
                
                if (obj.monedero_activo=='1'){
                    window.localStorage.setItem("porcentaje_fidelizacion",encripta(obj.porcentaje));
                    
                    
                }
                
                
                
                var id=obj.id;

                $('#my-form-usu input[name*="id"]').val(id);
                window.localStorage.setItem("user",encripta(id));
                $('#my-form-usu input[name*="nombre"]').val(obj.nombre);
                $('#my-form-usu input[name*="apellidos"]').val(obj.apellidos);
                $('#my-form-usu input[name*="nacimiento1"]').val(obj.nacimiento);
                //$('#my-form-usu input[name*="tratamiento"]').attr('checked', false);
                $('#my-form-usu input[name*="tratamiento"][value="'+obj.tratamiento+'"]').attr('checked', true);
                if(obj.publicidad=='1'){
                   $('#my-form-usu input[name*="publi-checkbox"]').attr('checked', true); 
                }
                $('#my-form-usu input[name*="email"]').val(username);
                $('#my-form-usu input[name*="telefono"]').val(obj.telefono);
                $('#my-form-usu input[name*="pass"]').val('');
                $('#my-form-usu input[name*="pass2"]').val('');
                calendarNacimiento1 = app.calendar.create({
                    inputEl: '#calendar-nacimiento-user',
                    value: [new Date(obj.nacimiento.substr(6,4), parseInt(obj.nacimiento.substr(3,2))-1, obj.nacimiento.substr(0,2))],
                    openIn: 'customModal',
                    //header: true,
                    closeOnSelect:true,
                    dateFormat: 'dd/mm/yyyy'
                    //footer: true,
                });
                //location.href='index.html';
                //app.accordion.close('.descripcion');
                
                
                //$('#ver-info-usu').show();
                //$('#usu-inicio').show();   
                
                

                if(isApp==true){                
                    var server=servidor+'includesapp/actualizacion_telefono.php';  
                    var fabricante = device.manufacturer;
                    var modelo = device.model;
                    var plataforma = device.platform;
                    var version = device.version;
                    var idtel=window.localStorage.getItem("idtel");
                    app.request.postJSON(server, { idtel:idtel, plataforma:plataforma, version:version, fabricante:fabricante, modelo:modelo, user:obj.id, push:window.localStorage.getItem("estado_push")}, 
                        function (data) {
                            
                            var obj=Object(data);
                            if (obj.valid==true){
                                window.localStorage.setItem("telefono_registrado","si");	
                            }
                        },
                        function (xhr, status) {
                    });                         
                } 
                
                //location.href='index.html';
                $('#usu-inicio').show(); 
                $('#login-inicio').hide();
                $('#nombre-usu').html(obj.nombre);
                
                if(fidelizacion==1){
                    $('#mi-monedero').show();
                    $('#importe-mi-monedero').html('<b>'+obj.monedero+'</b> €');            
                }
                mostrarMasDatos();
                //console.log('sesión iniciada:'+obj.nombre);
                txt_1='<p>Nombre completo:</p>'+
                '<p><b>'+$('#my-form-usu input[name*="nombre"]').val()+' '+$('#my-form-usu input[name*="apellidos"]').val()+'</b></p>'+
                '<p>Email:</p>'+
                '<p><b>'+desencripta(window.localStorage.getItem("username"))+'</b></p>';
                txt_1+='<div class="grid grid-cols-2 grid-gap"><div class="button button-raised button-round" onclick="cierrasesioncompra();" style="font-size:11px;height: 35px;"><i class="f7-icons ">power</i>Cerrar sesión</div> <div class="button button-fill button-round" onclick="checkout_3();" style="height: 35px;">Continuar</div></div>'; 
                $('#usuario-compras').html(txt_1);
                
                
            }
            else{
                $('#error-login-compras').show();
            }
        }
    });

}



function nuevoUsuCompra() {
    var estadopass=$('#pass-nuevo-usu').css('display');
   
    
    if (estadopass=='none'){
        pass='';
    }
    
    var formData = app.form.convertToData('#my-form-usu-compra');
    var id=formData['id'];
    var tratamiento=formData['tratamiento'];
    var nombre=formData['nombre'];
    var apellidos=formData['apellidos'];
    var nacimiento=formData['nacimiento'];
    
    var usuario=formData['email'];
    var telefono=formData['telefono'];
    var pass=formData['pass'];
    
    var publi=formData['publi-checkbox'];
    if (publi!='1'){
        publi='0';  
    }
    else{
        publi='1';
    }
    var acepto=formData['privacidad-checkbox'];
    var errores="";
    if (nombre==''){
        errores+='Nombre, ';
    }
    if (apellidos==''){
        errores+='Apellidos, ';
    }
    if (usuario==''){
        errores+='email, ';
    }
    if (telefono==''){
        errores+='Teléfono, ';
    }
    if (acepto==''){
        errores+='aceptar la Política de privacidad, ';
    }
    
    if (estadopass=='list-item') {
        if (pass==''){
            errores+='Contraseña, ';
        }
    }
    
    if (errores!=''){
        errores = 'Debe completar '+errores.substring(0, errores.length - 2)+'.';
        app.dialog.alert(errores);
    }
    
    else {
        
        if (estadopass=='none'){
            pass='';
        }
        if (pass!='') {
            //nuevo usuario
            
            var server=servidor+'includes/guardausuario.php';
            $.ajax({
                url: server,
                data:{nombre:nombre, apellidos:apellidos, telefono:telefono, usuario:usuario, pass:pass, publi:parseInt(publi), tratamiento:tratamiento, nacimiento:nacimiento},
                method: "post",
                dataType:"json",
                success: function(data){    
                    var obj=Object(data);
                    if (obj.valid==true){
                        window.localStorage.setItem("registrado",encripta("si"));
                        window.localStorage.setItem("username",encripta(usuario));
                        window.localStorage.setItem("user",encripta(obj.id));
                        $('#usu-nuevo').hide();
                        $('#login-inicio').hide();
                        $('#usu-inicio').show();  

                        $('#my-form-usu input[name*="id"]').val(obj.id);
                        $('#my-form-usu input[name*="nombre"]').val(nombre);
                        $('#my-form-usu input[name*="apellidos"]').val(apellidos);
                        $('#my-form-usu input[name*="telefono"]').val(telefono);
                        //$('#my-form-usu input[name*="tratamiento"]').attr('checked', false);

                        $('#my-form-usu input[name*="tratamiento"][value="'+obj.tratamiento+'"]').attr('checked', true);
                        if(publi=='1'){
                           $('#my-form-usu input[name*="publi-checkbox"]').attr('checked', true); 
                        }
                        $('#my-form-usu input[name*="email"]').val(usuario);
                        $('#my-form-usu input[name*="pass"]').val('');
                        $('#my-form-usu input[name*="pass2"]').val('');
                        
                        enviaemail('nuevo',usuario);
                        if(isApp==true){                
                            var server=servidor+'includesapp/actualizacion_telefono.php';  
                            var fabricante = device.manufacturer;
                            var modelo = device.model;
                            var plataforma = device.platform;
                            var version = device.version;
                            var idtel=window.localStorage.getItem("idtel");

                            app.request.postJSON(server, { idtel:idtel, plataforma:plataforma, version:version, fabricante:fabricante, modelo:modelo, user:obj.id, push:window.localStorage.getItem("estado_push")}, 
                                function (data) {

                                    var obj=Object(data);
                                    if (obj.valid==true){
                                        window.localStorage.setItem("telefono_registrado","si");	
                                    }

                                },
                                function (xhr, status) {
                            });                         
                        }   
                        $('#usu-inicio').show(); 
                        $('#nombre-usu').html(nombre);
                        mostrarMasDatos();
                        if (fidelizacion==1){
                           window.localStorage.setItem("porcentaje_fidelizacion",encripta(por_fidelizacion)); 
                        }
                        
                        checkout_3();                    
                        
                    }
                    else{
                        if (obj.existe==true){
                            
                            muestraMensaje('Ya existe usuario con ese email.',titulo='',subtitulo='Error');
                        }
                        else {
                            muestraMensaje('No se pudo crear usuario.',titulo='',subtitulo='Error');
                        }
                    }
                },
                error: function (xhr, ajaxOptions, thrownError){
                    console.log(xhr.status);
                    console.log(thrownError);
                }
            });        
            
        }
        else{
            
            //miLocalStorage.setItem('status', 'invitado');
            carrito_invitado = { tratamiento: tratamiento, nombre: nombre, apellidos: apellidos, fecha_nacimiento: nacimiento, telefono: telefono, email: usuario, publicidad: publi };
            checkout_3();
            
            miLocalStorage.setItem("carrito_invitado", JSON.stringify(carrito_invitado));
            //
              
        }
    }
}

function ponehorasdehoy(fecha) {

    var hoy=new Date();

    
    var minutos=parseInt(tiempoenvio);
    var d = fecha;

    d.setMinutes(d.getMinutes()+minutos);

    var day = fecha.getDay();
     //var dia=fecha;

    // cambios hechos hoy
    fecha.setHours(fecha.getHours() + 2);
    var dutc=(fecha).toUTCString();
    var horaN= dutc.substr(17,2);
    var minN= dutc.substr(20,2);
    fecha.setHours(parseInt(horaN));
    fecha.setMinutes(parseInt(minN));

    // cambios hoy 25/7

    hoy.setHours(fecha.getHours() + 2);
    dutc=(hoy).toUTCString();
    var horaN= dutc.substr(17,2);
    var minN= dutc.substr(20,2);
    hoy.setHours(parseInt(horaN));
    hoy.setMinutes(parseInt(minN));
    
    var dia=fecha;
    
    
    //console.log('fecha:'+fecha);
    //console.log('dia:'+dia);

    
    var day_hoy = hoy.getDay();


    var mil=d.getTime();
 
    var horario;
    var horariococina;
    if (day==1){
        horario=diasreparto['lunes'];
        horariococina=diascocina['lunes'];
    }
    if (day==2){
        horario=diasreparto['martes'];
        horariococina=diascocina['martes'];
    }
    if (day==3){
        horario=diasreparto['miercoles'];
        horariococina=diascocina['miercoles'];
    }
    if (day==4){
        horario=diasreparto['jueves'];
        horariococina=diascocina['jueves'];
    }
    if (day==5){
        horario=diasreparto['viernes'];
        horariococina=diascocina['viernes'];
        
    }
    if (day==6){
        horario=diasreparto['sabado'];
        horariococina=diascocina['sabado'];
    }
    
    
    if (day==0){
        horario=diasreparto['domingo'];
        horariococina=diascocina['domingo'];
    } 
    
    

    disponiblereparto=new Array();
    var h=0;
    disponiblecocina=new Array();
    var j=0;

    for (x=0;x<horario.length;x++){
        var hhmm=horario[x].split(':');
        
        dia.setHours(parseInt(hhmm[0]));
        dia.setMinutes(parseInt(hhmm[1]));  
        var mil2=dia.getTime();  
        if (day==day_hoy){
            if (mil <= mil2){


                disponiblereparto[h]=horario[x];
                h++;
            }
        }
        else {
             disponiblereparto[h]=horario[x];
                h++;
        }
    }
    
    
   
    for (x=0;x<horariococina.length;x++){
        var hhmm=horariococina[x].split(':');
        dia.setHours(parseInt(hhmm[0]));
        dia.setMinutes(parseInt(hhmm[1]));  
        var mil2=dia.getTime(); 
        if (day==day_hoy){
            if (mil <= mil2){
                disponiblecocina[j]=horariococina[x];
                j++;
            }   
        }
        else {
            disponiblecocina[j]=horariococina[x];
            j++;
        }
    }
    
    
    
    //console.log(fecha);
    if (horario.length>0){
        //console.log('disponible envio');
        //console.log(disponiblereparto);
    }
    if (horariococina.length>0){
        //console.log('disponible cocina');
        //console.log(disponiblecocina);
    }
//console.log('Busco pedidos:'+diaCastellano(d.getDate()) + "/" + mesCastellano(d.getMonth()) + "/" + d.getFullYear());
    mirasihaypedidosoy(diaCastellano(d.getDate()) + "/" + mesCastellano(d.getMonth()) + "/" + d.getFullYear());
    

    /*
    console.log('disponible envio');
    console.log(horario);
    console.log(disponiblereparto);
    console.log('disponible cocina');
    console.log(horariococina)
    console.log(disponiblecocina);
    */
    
    //cambiametodoenvio();
}

function checkout_3(){
    
    $('#icon-back-checkout').show(); 
    document.getElementById("link-volver-checkout").href = "javascript:checkout_2();";
    if (window.localStorage.getItem("username")!=""){
        //registrado
    }
    var txt=progresscheckout(3);
    //var minutos=parseInt(tiempoenvio);
    var d = new Date();
    //d.setMinutes(d.getMinutes()+minutos);
    //var day = d.getDay();
    //var dia=new Date();
    //var mil=d.getTime();
    //console.log('tiempoenvio:'+tiempoenvio);
    var hoy = diaCastellano(d.getDate()) + "/" + mesCastellano(d.getMonth()) + "/" + d.getFullYear();  
    
    fecha_pedido=hoy;
    ponehorasdehoy(d);
    
    
    /*
    console.log('disponible envio');
    console.log(disponiblereparto);
    console.log('disponible cocina');
    console.log(disponiblecocina);
    */
    //console.log('Busco pedidos:'+fecha_pedido);
    mirasihaypedidosoy(hoy);


}

function mirasihaypedidosoy(fecha){
    //alert(fecha);
    var opcionescocina='';
    var chk_cocina="";
    var hay_reparto=false;
    var hay_cocina=false;
    

    var server=servidor+'includes/mirapedidoshoy.php';
    //console.log(fecha_pedido);
    //console.log(disponiblereparto);
                //console.log(disponiblecocina);
    $.ajax({
        url: server,
        data:{horario:disponiblereparto, horariococina: disponiblecocina,fecha:fecha},
        method: "post",
        dataType:"json",
        success: function(data){ 
            var obj=Object(data);
            if (obj.valid==true){

                disponiblereparto=obj.horario;
                disponiblecocina=obj.horariococina;
                
                
                var opcionescocina='';
                if (disponiblecocina!=null){
                    hay_cocina=true;
                    /*
                    for (x=0;x<disponiblecocina.length;x++){
                        if (x==0){
                            chk_cocina=' checked';
                        }
                           if (cortesia>0){ hora=parseInt(disponiblecocina[x].substr(0,2));
                            minutos=parseInt(disponiblecocina[x].substr(3,2));
                            minutos+=cortesia;
                            if (minutos>=60){
                                minutos-=cortesia;
                                hora+=1;

                            }
                            if (hora>=24){
                                hora=0;
                            }
                            if (minutos<=9){
                                minutos='0'+minutos;
                            }
                            if (hora<=9){
                                hora='0'+hora;
                            }
                            txt_hora_cortesia='-'+hora+':'+minutos;
                        }
                        opcionescocina+='<option value="'+disponiblecocina[x]+'" '+chk_cocina+'>'+disponiblecocina[x]+txt_hora_cortesia+'</option>';
                    }
                    */
                }
                else {
                    hay_cocina=false;
                }
                
                var opcionesreparto='';
                txt_hora_cortesia='';
                if (disponiblereparto!=null){
                    hay_reparto=true;
                   /*
                    for (x=0;x<disponiblereparto.length;x++){
                       if (cortesia>0){
                            hora=parseInt(disponiblereparto[x].substr(0,2));
                            minutos=parseInt(disponiblereparto[x].substr(3,2));
                            minutos+=cortesia;
                            if (minutos>=60){
                                minutos-=cortesia;
                                hora+=1;

                            }
                            if (hora>=24){
                                hora=0;
                            }
                            if (minutos<=9){
                                minutos='0'+minutos;
                            }
                            if (hora<=9){
                                hora='0'+hora;
                            }
                           txt_hora_cortesia='-'+hora+':'+minutos;
                       } 
                        opcionesreparto+='<option value="'+disponiblereparto[x]+'">'+disponiblereparto[x]+txt_hora_cortesia+'</option>';
                    }
                    */
                }
                else {
                    hay_reparto=false;
                }
                
                
                //console.log('Para Reparto:');
                //console.log(disponiblereparto);
                //console.log('Para Cocina:');
                //console.log(disponiblecocina);
                //console.log('hay_cocina:'+hay_cocina);
                //console.log('hay_reparto:'+hay_reparto);
                
                
                //cambiametodoenvio();
                //ponehorasdehoy(d);
                ponebotonesmetodo(0,hay_reparto,hay_cocina);
                //console.log(hay_reparto);
                //console.log(hay_cocina);
                
                ponelashoras(hay_reparto,hay_cocina);
                
                
                
                
                
            }
            else {
                muestraMensaje('Error leyendo horarios',titulo='',subtitulo='Horarios');
                    checkout_2();
                //console.log('error leyendo horas');
            }
        },
        error: function (xhr, ajaxOptions, thrownError){
            console.log(xhr.status);
            console.log(thrownError);
            }
    });
}

function mesCastellano(mes){
    var devuelve=mes;
    devuelve++;
    if (devuelve<=9){
        devuelve='0'+devuelve;
    }
    return devuelve
}

function diaCastellano(dia){
    var devuelve=dia;
    if (devuelve<=9){
        devuelve='0'+devuelve;
    }
    return devuelve
}

function llenafechaspedido(dias){
    var diasSemana = [
      'domingo',
      'lunes',
      'martes',
      'miércoles',
      'jueves',
      'viernes',
      'sábado'
    ];
    var seleccionado=fecha_pedido;
    var f = new Date();
    var txt='<p>Seleccione fecha pedido: <b><span id="la-fecha-pedido" style="color:'+colorprimario+';">'+fecha_pedido+'</span></b></p><p class="grid grid-cols-2 grid-gap">';
    losdias=new Array();
    var primero="button-fill";
    var txt_prim='HOY';
    for (j=0;j<dias;j++){
        
        
        losdias[j]=diaCastellano(f.getDate()) + "/" + mesCastellano(f.getMonth()) + "/" + f.getFullYear();
        txt_prim=losdias[j];
        if (j==0){
            txt_prim='HOY';
        }
        if (j==1){
            txt_prim='MAÑANA';
        }
        if (j>1){
            txt_prim=diasSemana[f.getDay()];
        }
        if (losdias[j]!=fecha_pedido){
            primero="button-raised";
        }
        else {
            primero="button-fill";
        }
        txt+='<button class="button-fecha-reparto button button-large '+primero+'" data-fecha="'+losdias[j]+'" style="line-height: 18px;" onclick="cambiaDiaEnvio(this);"><p><b>'+txt_prim+'</b><br><span style="font-size:14px;">'+losdias[j]+'</span></p></button>';
        f.setDate(f.getDate()+1);
        primero="button-raised";
        if (j>3){
            txt+='<button class="button-fecha-reparto button button-large button-raised" data-fecha="" id="calendario-para-otro-dia" onclick="cambiaDiaEnvioCalendar();"><i class="f7-icons">calendar</i>&nbsp; otro día</button>'
            break;
        }
    }
    txt+='</p><input type="hidden" id="fecha_pedido" value="'+fecha_pedido+'">';
    //$('#la-fecha-pedido').html(fecha_pedido);
    return txt;
    
    
}

function cambiaDiaEnvioCalendar(){
    $('.button-fecha-reparto').removeClass('button-fill');
    $('.button-fecha-reparto').addClass('button-raised');
    $('#calendario-para-otro-dia').removeClass('button-raised');
    $('#calendario-para-otro-dia').addClass('button-fill');
    var inicio=new Date();
    var fin=new Date();
    fin.setDate(fin.getDate()+parseInt(dias_vista));
    inicio.setDate(inicio.getDate()+5);
    
    var maxD = new Date(8640000000000000);
    var minD = new Date(-8640000000000000);
    inicio.setDate(inicio.getDate() - 1);
    var primi=new Date();
    primi.setDate(primi.getDate() + 5);
    
    var calendarDateTime = app.calendar.create({
        inputEl: '#fecha_pedido',
        value: [primi ],
        disabled: [
          {
            from: minD,
            to: inicio,
          },
          {
            from: fin   ,
            to: maxD
          }
        ],
        on:{

            close: function(){
                var dia=this.getValue();
                var fecha=diaCastellano(dia[0].getDate()) + "/" + mesCastellano(dia[0].getMonth()) + "/" + dia[0].getFullYear();
                //console.log(fecha);
                cambiaDiaEnviodesdeCalendario(fecha);
                

            }
        },
        openIn: 'customModal',
        //header: true,
        closeOnSelect:true,
        dateFormat: 'dd/mm/yyyy'
        //footer: true,
    });
    
    calendarDateTime.open();
    
}

function ponelashoras(hay_reparto,hay_cocina){
    //alert(fecha_pedido);
    var f = new Date();
    var hoy = diaCastellano(f.getDate()) + "/" + mesCastellano(f.getMonth()) + "/" + f.getFullYear();  
    var txt_fecha_pedido='';
    var elegido_metodo='no';
    var metodo=1;
    if (dias_vista>1){
        txt_fecha_pedido=llenafechaspedido(dias_vista);
        
        
    }
    else {
        txt_fecha_pedido='<p>Fecha pedido: <span style="color:'+colorprimario+';"><b>HOY</b></span></p>';
        fecha_pedido=hoy;
    }
    
    
        
    var txt=progresscheckout(3);
    txt+='<div id="metodo-de-envio" style="font-size: 16px;">';
    txt+=txt_fecha_pedido;
    
    txt+='<p >Seleccione opción</p>';
    txt+='<div class="grid grid-cols-2" id="button-envio">'+ 
        '</div>';
    txt+='</div><br>'+
        '<div id="las-horas" class="grid grid-cols-2">'+ 
        '</div>';
    txt+='<br><div class="row"><button id="compra-paso-2"  onclick="eligedomicilio();" class="col-60 button  button-round button-raised"  style="margin:auto;height: 35px;width: 60%;" disabled>Continuar</button></div></div>';
    //console.log('disponiblecocina');
    //console.log(disponiblecocina);
    //console.log('hay_cocina');
    //console.log(hay_cocina);
    //console.log('hay_reparto');
    //console.log(hay_reparto);
    
    if ((!hay_cocina)&&(!hay_reparto)) {
        //if (dias_vista==1){
            muestraMensaje(norepartomensaje,titulo='',subtitulo='Horario reparto');
            checkout_2();
        //}
        // compra-paso-2 quitar 
        $('#compra-paso-2').removeClass('button-fill');
        $('#compra-paso-2').addClass('button-raised');
        $('#compra-paso-2').prop("disabled",true);
        
        
    }
    
    $('.button-envio').each(function() {
        if ($(this).hasClass("button-fill")){
            elegido_metodo='si';
            metodo=$(this).attr('data-metodo');
        }
    });
    if (elegido_metodo=='no'){
        $('#checkout-page').html(txt);
        ponebotonesmetodo(0,hay_reparto,hay_cocina);
        return;
    }
    
    
    
    $('#checkout-page').html(txt);
    ponebotonesmetodo(1,hay_reparto,hay_cocina);
    
    //alert ('metodo:'+metodo);
    ponelashorassegundia(metodo,hay_reparto,hay_cocina);
    /*
    return;
    
    var opcionescocina='';
    if (disponiblecocina!=null){
        hay_cocina=true;
        if (tipo_seleccion_horas==1){
            for (x=0;x<disponiblecocina.length;x++){
                if (x==0){
                    chk_cocina=' checked';
                }

                opcionescocina+='<option value="'+disponiblecocina[x]+'" '+chk_cocina+'>'+disponiblecocina[x]+txtCortesia(disponiblecocina[x])+'</option>';
            }
        }
        if (tipo_seleccion_horas==2){
            for (x=0;x<disponiblecocina.length;x++){
                opcionescocina+='<button class="button-horario button button-large button-raised" data-hora="'+disponiblecocina[x]+'">'+disponiblecocina[x]+txtCortesia(disponiblecocina[x])+'</button>';
            }
        }
    }
    else {
        hay_cocina=false;
    }

    var opcionesreparto='';
    
    if (disponiblereparto!=null){
        hay_reparto=true;
        if (tipo_seleccion_horas==1){
            for (x=0;x<disponiblereparto.length;x++){

                opcionesreparto+='<option value="'+disponiblereparto[x]+'">'+disponiblereparto[x]+txtCortesia(disponiblereparto[x])+'</option>';
            }
        }
        if (tipo_seleccion_horas==2){
            for (x=0;x<disponiblereparto.length;x++){
                opcionesreparto+='<button class="button-horario button button-large button-raised" data-hora="'+disponiblereparto[x]+'">'+disponiblereparto[x]+txtCortesia(disponiblereparto[x])+'</button>';
            }
        }
        
    }
    else {
        hay_reparto=false;
    }
    
    txt+='<div id="metodo-de-envio" style="font-size: 16px;">';
    txt+=txt_fecha_pedido;;
    
    //txt+='<p class="grid grid-cols-2 grid-gap">'+txt_fecha_pedido+'</p>'
    
    
    txt+='<p id="seleccion-envio">Seleccione opción de envío:</p>';
    
    var checked='';
    
    
    if (hay_cocina){
        if (disponiblecocina.length!=0){
            txt+='<p><label class="radio"><input type="radio" onclick="cambiametodoenvio();" name="metodo_envio" value="2" checked/><i class="icon-radio"></i></label> Recogida en local</p>';
        }
        if (tipo_seleccion_horas==0){
            txt+='<input id="hora-recogida" type="hidden" value="'+disponiblecocina[0]+'"><p>Hora: <b>'+disponiblecocina[0]+'</b></p>';
        }

    }

    if (hay_reparto){
        if (disponiblereparto.length!=0){

            if (!hay_cocina){
                checked='checked';
                //console.log('solo reparto');
            }
            txt+='<p><label class="radio"><input type="radio" onclick="cambiametodoenvio();" name="metodo_envio" value="1" '+checked+'/><i class="icon-radio" ></i></label> Entrega en mi domicilio</p>';
            if (tipo_seleccion_horas==0){
                txt+='<input id="hora-reparto" type="hidden" value="'+disponiblereparto[0]+'"><p>Hora: <b>'+disponiblereparto[0]+'</b></p>';
            }
            if (tipo_seleccion_horas==2){
                
                //txt+='<p>Seleccione hora:</p><p class="grid grid-cols-2 grid-gap">'+opcionesreparto+'</p>';
            }
        }
    }
    
    txt+='<div class="text-color-primary" style="font-size:16px;" id="horas-entrega"></div>'+
        '<br><div class="row"><button id="compra-paso-2"  onclick="eligedomicilio();" class="col-60 button button-fill button-round" style="margin:auto;height: 35px;width: 60%;">Continuar</button></div></div>';

    $('#checkout-page').html(txt);
    var entrega='';
    if (tipo_seleccion_horas==1){
        entrega='Seleccione hora de recogida: <i class="f7-icons size-22">hand_point_right_fill</i> '+
        '<span style="display: inline-block;"><select id="hora-reparto" style="height:20px;font-size:16px;">'+opcionescocina+' </select></span>';
    }
    if (tipo_seleccion_horas==2){
        entrega='<p>Seleccione hora:</p><p class="grid grid-cols-2 grid-gap">'+opcionescocina+'</p>';
    }
    
    if (tipo_seleccion_horas==0){
        //entrega='<p>Hora: <b>'+disponiblecocina[0]+'</b></p>';
    }
    //$('#horas-entrega').html(entrega);

    if ((!hay_cocina)&&(!hay_reparto)) {
        if (dias_vista==1){
            muestraMensaje(norepartomensaje,titulo='',subtitulo='Horario reparto');
            checkout_2();
        }
        // compra-paso-2 quitar 
        $('#compra-paso-2').removeClass('button-fill');
        $('#compra-paso-2').addClass('button-raised');
        $('#compra-paso-2').prop("disabled",true);
        
    }

    if ((!hay_reparto)&&(!hay_cocina)){
        if (dias_vista==1){
            muestraMensaje(norepartomensaje,titulo='',subtitulo='Horario reparto');
        }
        else {
            entrega='<span style="color: '+colorsecundario+'; font-size: 20px;text-align: center;display: block;">No hay horas disponibles.</span>';
        }


     }
    else {

        if ((hay_reparto)&&(!hay_cocina)){
            if (tipo_seleccion_horas==1){
                entrega='Seleccione hora de reparto: <i class="f7-icons size-22">hand_point_right_fill</i> '+
                '<span style="display: inline-block;"><select id="hora-reparto" style="height:20px;font-size:16px;">'+opcionesreparto+'</select></span>';
            //metodo_envio
                $('input:radio[name="metodo_envio"]').filter('[value="1"]').attr('checked', true);
            }
            if (tipo_seleccion_horas==0){
                entrega='<input id="hora-reparto" type="hidden" value="'+disponiblereparto[0]+'">';
            }
            if (tipo_seleccion_horas==2){
                entrega='<p>Seleccione hora:</p><p class="grid grid-cols-2 grid-gap">'+opcionesreparto+'</p>';
                
            }
        }

    }
    


    $('#horas-entrega').html(entrega);
    
    // detección clic
    $('.button-horario').on( "click", function() {
        var elemento=$(this);
        var hora=elemento.attr('data-hora');
        //console.log(hora);
        hora_envio=hora;
        $('.button-horario').removeClass('button-fill');
        elemento.addClass('button-fill');
        $('#compra-paso-2').addClass('button-fill');
        $('#compra-paso-2').removeClass('button-raised');
        $('#compra-paso-2').prop("disabled",false);
        
    });
    if (tipo_seleccion_horas==2){
        $('#compra-paso-2').removeClass('button-fill');
        $('#compra-paso-2').addClass('button-raised');
        $('#compra-paso-2').prop("disabled",true);
        $('#horas-entrega').removeClass('text-color-primary');
        
    }
    */
    
    //console.log('tipo_envio:'+tipo_envio);
}

function ponelashorassegundia(metodo,hay_reparto,hay_cocina){

    
    var txt_metodo='';
    if (metodo==1){
        //envio
        if (!hay_reparto){
            $('#las-horas').removeClass('grid-cols-2');
            $('#las-horas').html('<span style="color:#f35605;font-size:18px;text-align: center;">NO HAY HORAS DISPONIBLE</span>');
            $('#las-horas').removeClass('grid-cols-2');
            return
        }
        if (disponiblereparto!=null){
            
            if (tipo_seleccion_horas==1){
                txt_metodo+='<span style="font-size:18px;color:'+colorprimario+';">Seleccione hora de reparto: <i class="f7-icons size-22">hand_point_right_fill</i> </span>'+
                '<span style="display: inline-block;"><select id="hora-reparto" style="height:20px;font-size:18px;">';
                for (x=0;x<disponiblereparto.length;x++){
                    if (x==0){
                        chk_cocina=' checked';
                    }

                    txt_metodo+='<option value="'+disponiblereparto[x]+'" >'+disponiblereparto[x]+txtCortesia(disponiblereparto[x])+'</option>';
                }
                txt_metodo+='</select></span>';
                $('#las-horas').removeClass('grid-cols-2');
                $('#las-horas').removeClass('grid');
                $('#las-horas').html(txt_metodo);
                $('#compra-paso-2').addClass('button-fill');
                $('#compra-paso-2').removeClass('button-raised');
                $('#compra-paso-2').prop("disabled",false);
            }
            if (tipo_seleccion_horas==2){
                for (x=0;x<disponiblereparto.length;x++){
                    txt_metodo+='<button class="button-horario button button-large button-raised" data-hora="'+disponiblereparto[x]+'">'+disponiblereparto[x]+txtCortesia(disponiblereparto[x])+'</button>';
                }
                $('#las-horas').addClass('grid-cols-2');
                $('#las-horas').html(txt_metodo);
            }
            
        }
        else {
            $('#las-horas').removeClass('grid-cols-2');
            $('#las-horas').html('<span style="color:#f35605;font-size:18px;text-align: center;">NO HAY HORAS DISPONIBLE</span>');
            //ponebotonesmetodo(0,hay_reparto,hay_cocina);
        }
        
        
    }
    else {
        if (!hay_cocina){
            $('#las-horas').removeClass('grid-cols-2');
            $('#las-horas').html('<span style="color:#f35605;font-size:18px;text-align: center;">NO HAY HORAS DISPONIBLE</span>');
            return
        }
        if (disponiblecocina!=null){
            hay_cocina=true;
            if (tipo_seleccion_horas==1){
                txt_metodo+='<span style="font-size:18px;color:'+colorprimario+';">Seleccione hora de recogida: <i class="f7-icons size-22">hand_point_right_fill</i> </span>'+
                '<span style="display: inline-block;"><select id="hora-reparto" style="height:20px;font-size:18px;">';
                for (x=0;x<disponiblecocina.length;x++){
                    if (x==0){
                        chk_cocina=' checked';
                    }
                    txt_metodo+='<option value="'+disponiblecocina[x]+'" '+chk_cocina+'>'+disponiblecocina[x]+txtCortesia(disponiblecocina[x])+'</option>';
                }
                
                
                txt_metodo+='</select></span>';
                $('#las-horas').removeClass('grid-cols-2');
                $('#las-horas').removeClass('grid');
                $('#las-horas').html(txt_metodo);
                $('#compra-paso-2').addClass('button-fill');
                $('#compra-paso-2').removeClass('button-raised');
                $('#compra-paso-2').prop("disabled",false);

            }
            if (tipo_seleccion_horas==2){
                for (x=0;x<disponiblecocina.length;x++){
                    txt_metodo+='<button class="button-horario button button-large button-raised" data-hora="'+disponiblecocina[x]+'">'+disponiblecocina[x]+txtCortesia(disponiblecocina[x])+'</button>';
                }
                $('#las-horas').addClass('grid-cols-2');
                $('#las-horas').html(txt_metodo);
            }
            
        }
        else {
            $('#las-horas').removeClass('grid-cols-2');
            $('#las-horas').html('<span style="color:#f35605;font-size:18px;text-align: center;">NO HAY HORAS DISPONIBLE</span>');
            //ponebotonesmetodo(0,hay_reparto,hay_cocina);
        }
    }
    $('.button-horario').on( "click", function() {
        var elemento=$(this);
        var hora=elemento.attr('data-hora');
        //console.log(hora);
        hora_envio=hora;
        $('.button-horario').removeClass('button-fill');
        elemento.addClass('button-fill');
        $('#compra-paso-2').addClass('button-fill');
        $('#compra-paso-2').removeClass('button-raised');
        $('#compra-paso-2').prop("disabled",false);
        
    });
    if (tipo_seleccion_horas==2){

    }
}

function ponebotonesmetodo(envio,hay_reparto,hay_cocina){
    //console.log('hay_reparto:'+hay_reparto+' hay_cocina:'+hay_cocina);
    
    var txt='';
    var txt_recoger='<div><button class="button button-outline button-envio" style="height: auto;font-size: 18px;padding:5px;width: 90%;margin: auto;" id="button-envio-2" onclick="cambiametodoenviobut(this,'+hay_reparto+','+hay_cocina+');" data-metodo="2"><i class="icon material-icons">shopping_bag</i>&nbsp;Recoger</button></div>';
    var txt_domicilio='<div><button class="button button-outline button-envio" style="height: auto;font-size: 18px;padding:5px;width: 90%;margin: auto;" id="button-envio-1" onclick="cambiametodoenviobut(this,'+hay_reparto+','+hay_cocina+');" data-metodo="1"><i class="icon material-icons">delivery_dining</i>&nbsp;Domicilio</button></div>';
    if (tipo_repartos==0){
        txt+=txt_recoger+txt_domicilio;
    }
    else {
        if (tipo_repartos==2){
            txt+=txt_recoger;
            tipo_envio=2;
        }
        else {
            txt+=txt_domicilio;
            tipo_envio=1;
        }
    }
    //console.log('tipo_repartos:'+tipo_repartos+' hay_reparto:'+hay_reparto+' hay_cocina:'+hay_cocina);
    
    
    $('#button-envio').html(txt);
    if (tipo_repartos==2){
        $('#button-envio-2').addClass('button-fill');
        
           
    }
    if (tipo_repartos==1){
        $('#button-envio-1').addClass('button-fill');
        
    }
    /*
    if (envio==1){
        $('.button-envio').each(function() {
            if (tipo_envio==$(this).attr('data-metodo')){
                $(this).addClass('button-fill');
            }
        }); 
    }
    */
}

function cambiametodoenviobut(elem,hay_reparto,hay_cocina){
    var elemento=$(elem);
    tipo_envio=elemento.attr('data-metodo');
    $('.button-envio').removeClass('button-fill');
    $('.button-envio').removeClass('button-raised');
    $('#compra-paso-2').addClass('button-raised');
    $('#compra-paso-2').removeClass('button-fill');
    $('#compra-paso-2').prop("disabled",true);
    
    elemento.removeClass('button-raised');
    elemento.addClass('button-fill');
     $('#las-horas').html('');
    
    // detección clic
    //console.log('tipo_envio:'+tipo_envio);
    //ponelashoras(hay_reparto,hay_cocina);
    ponelashorassegundia(tipo_envio,hay_reparto,hay_cocina)
}

    


function txtCortesia(lahora){
    //console.log(lahora);
    var txt_hora_cortesia='';
    var hora='';
    var minutos='';

    if (cortesia>0){ 
        hora=parseInt(lahora.substr(0,2));
        minutos=parseInt(lahora.substr(3,2));
        minutos+=cortesia;
        if (minutos>=60){
            //minutos-=cortesia;
            minutos-=60;
            hora+=1;

        }
        if (hora>=24){
            hora=0;
        }
        if (minutos<=9){
            minutos='0'+minutos;
        }
        if (hora<=9){
            hora='0'+hora;
        }
        txt_hora_cortesia='-'+hora+':'+minutos;
    }
    
    return txt_hora_cortesia;
}


function eligedomicilio(){
    $('#compra-paso-2').hide(); //boton continuar
    var txt=$('#checkout-page').html();
    var status=miLocalStorage.getItem('status');
    //tipo_envio=1;
    
    $('#metodo-de-envio [name="metodo_envio"]:checked').each(
        function() {
         tipo_envio =$(this).val();
        }
    );
    //console.log('tipo_envio:'+tipo_envio);
    var txt_envio='<b>Entrega en domicilio</b>';
    if (tipo_envio==2){
        txt_envio='<b>A recoger</b>';
        if (tipo_seleccion_horas==0){
            hora_envio=$('#hora-recogida').val(); 
        }
    }
    else {
        if (tipo_seleccion_horas==0){
            hora_envio=$('#hora-reparto').val(); 
        }
    }
    if (tipo_seleccion_horas==1){
        hora_envio=$('#hora-reparto').val(); 
    }
    
    
    
//console.log('hora_envio:'+hora_envio);

    var txt_pre='<span style="font-size:16px; id="txt_pre_envio">'+txt_envio+'<br>Hora:<b>'+hora_envio+'</b>'
    
    
    
    
    if (tipo_envio==1){
        //domicilio

        if (window.localStorage.getItem("username")!=""){
            // registrado
           //console.log('usuario:'+desencripta(window.localStorage.getItem("user"))); 
            buscadirecciones_compra(desencripta(window.localStorage.getItem("user")));
            
            

        }
        else {
            //invitado
            txt=txt+txt_pre+txt_compra_dom_form;
            $('#checkout-page').html(txt);

        }
        

    }
    else {
        carrito_domicilio['envio'] = '0';
        miLocalStorage.setItem('carrito_domicilio', JSON.stringify(carrito_domicilio));
        //var cart=ponetotales();  

        checkout_4();
    }
    $('#metodo-de-envio').hide();
    $('#las-horas').hide();
    
}

function direcciones_compra_nuevo() {
    //'<form class="list" id="my-form-domi-compra" style="margin-top:5px;">'+
    var formData = app.form.convertToData('#my-form-domi-compra');
    
    var direccion=formData['direccion'];
    var complementario=formData['complementario'];
    var cod_postal=formData['cod_postal'];
    var poblacion=formData['poblacion'];
    var provincia=formData['provincia'];
    var errores="";
    if (direccion==''){
        errores+='Dirección, ';
    }
    if (cod_postal==''){
        errores+='Código Postal, ';
    }
    if (poblacion==''){
        errores+='Población, ';
    }
    if (provincia==''){
        errores+='Provincia, ';
    }
    
    if (errores!=''){
        errores = 'Debe completar '+errores.substring(0, errores.length - 2)+'.';
        app.dialog.alert(errores);
    }
    else {

        carrito_domicilio['direccion'] = direccion;
        carrito_domicilio['complementario'] = complementario;
        carrito_domicilio['cod_postal'] = cod_postal;
        carrito_domicilio['poblacion'] = poblacion;
        carrito_domicilio['provincia'] = provincia;
        $.get('https://maps.googleapis.com/maps/api/geocode/json?address='+direccion+' '+cod_postal+' '+poblacion+'&key=AIzaSyDsv3MEv58JZ42mQIqNyE_Zwpyo361dzhs', 
        function(data) {
            //console.log('carrito_domicilio');
            var lat=data.results[0].geometry.location.lat;
            var lng=data.results[0].geometry.location.lng
            carrito_domicilio['coordenadas']={lat:lat,lng:lng};
            var server=servidor+'includes/leezonasreparto.php';
            $.ajax({
                type: "POST",
                url: server,
                data:{ foo:'foo', },
                dataType:"json",
                success: function(data){
                    var obj=Object(data);
                    if (obj.valid==true){
                        var nombre=obj.nombre;
                        var precio=obj.precio;
                        var minimo=obj.minimo;
                        
                        
                        var reparto=obj.reparto;
                        var zonas=obj.zonas;
                        var buscar=new google.maps.LatLng(parseFloat(lat), parseFloat(lng));
                        var esta='no';
                        var noreparto='no';
                        var portes=0;
                        var minimo_domicilio=0;
                        for(x=0;x<zonas.length;x++){
                            for (j=0;j<zonas[x].length;j++){
                                zonas[x][j]={ "lat": parseFloat(zonas[x][j]['lat']), "lng": parseFloat(zonas[x][j]['lng']) };
                            }
                            var polygon = new google.maps.Polygon({paths:zonas[x],map: map});
                            var isWithinPolygon = google.maps.geometry.poly.containsLocation(buscar, polygon);
                            if (isWithinPolygon){
                                esta='si';
                                portes=precio[x];
                                minimo_domicilio=minimo[x];
                                if (reparto[x]=='0'){
                                    // zona no reparto
                                    noreparto='si';
                                }   
                                if (portesgratis==0 ){
                                        if (carritoSubtotal<minimo_domicilio) {
                                            muestraMensaje('El pedido no llega al mínimo para esta zona de reparto', titulo='Error',subtitulo='Mínimo '+minimo_domicilio+'€');
                                            return;
                                        }
                                    }
                                
                            }
                        }
                        if ((esta=='si')&&(noreparto=='no')) {              
                            carrito_domicilio['direccion'] = direccion;
                            carrito_domicilio['complementario'] = complementario;
                            carrito_domicilio['cod_postal'] = cod_postal;
                            carrito_domicilio['poblacion'] = poblacion;
                            carrito_domicilio['provincia'] = provincia;
                            carrito_domicilio['envio'] = portes;
                            carrito_domicilio['minimo'] = minimo_domicilio;
                            miLocalStorage.setItem('carrito_domicilio', JSON.stringify(carrito_domicilio));
                            checkout_4();                                         
                        }
                        else {
                            muestraMensaje('El domicilio introducido NO está en nuestra zona de reparto.',titulo='',subtitulo='Error domicilio');
                            return;
                        }

                    }
                }
            });                    
            
        });
        
        miLocalStorage.setItem('carrito_domicilio', JSON.stringify(carrito_domicilio)); 
        
    }
}

function buscadirecciones_compra(id){

    //ver-direccion-usu
    var server=servidor+'includes/buscadirecciones.php'; 
    $.ajax({
        type: "POST",
        url: server,
        data: { id:id, },
        dataType:"json",
        success: function(data){
            var obj=Object(data);
            if (obj.valid==true){
                var txt="";
                var iddomi=obj.id;
                var linea="";
                var alias=obj.alias;
                var preferida=obj.preferida;
                var direccion=obj.direccion;
                var complementario=obj.complementario;
                var cod_postal=obj.cod_postal;
                var poblacion=obj.poblacion;
                var provincia=obj.provincia;
                var ali='';
                var compl='';
                var prefe='';
                for (x=0;x<alias.length;x++){
                    compl='';
                    prefe='';
                    if (preferida[x]!=0){
                        //prefe='<label class="radio float-right"><input type="radio" checked disabled/><i class="icon-radio card"></i></label>';
                    }
                    if (alias[x]!=""){
                        ali=alias[x];
                    }
                    else {
                        ali='Mi domicilio '+(x+1);
                    }
                    if (complementario[x]!=null){
                        compl=complementario[x]+'<br>';
                    }
                    else {
                        compl="";
                    }
                    
                    txt+=''+                  
                    '<div class="card card-outline card-dividers" style="width: 90%;">'+
                        '<div class="card-header">'+ali+
                        prefe+'</div>'+
                        '<div class="card-content card-content-padding">'+
                            direccion[x]+'<br>'+
                            compl+
                            cod_postal[x]+' - '+poblacion[x]+'<br>'+
                            '('+provincia[x]+')'+    
                        '</div>'+                        
                    '</div>';     
                    txt+='<div class=""><button onclick="seleccionardomicilio('+iddomi[x]+');" class="button button-fill button-round" style="margin:auto;width: 60%;">Seleccionar</button></div>';
                }          
            }
            else {
                txt="<p class='text-color-red sin-direcciones'>Aún no tiene direcciones asociadas.</p>"
            }
            txt+='<br><div class="sin-direcciones"><button onclick="editaDomicilioCompra('+id+');" class="col-60 button button-fill button-round" style="margin:auto;width: 70%;">+ Añadir dirección</button></div>';
        
            var txt_envio='<b>Entrega en domicilio</b>';
            if (tipo_envio==2){
                txt_envio='<b>A recoger</b>';
            }
            if (tipo_seleccion_horas<=1){
                hora_envio=$('#hora-reparto').val(); 
            }

            
            var txt_pre='<span style="font-size:16px;" >'+txt_envio+'<br>Hora:<b>'+hora_envio+'</b></span>';

            $('#checkout-page').html(progresscheckout(3)+txt_pre+txt)
            $( "#txt_pre_envio" ).remove();
            
        },
        error: function (xhr, ajaxOptions, thrownError) {
            console.log(xhr.status);
            console.log(thrownError);
        }
    });
 
                    
}

function seleccionardomicilio(id){
    var server=servidor+'includes/buscadirecciones2.php';  
    $.ajax({
        type: "POST",
        url: server,
        data: { id:id, },
        dataType:"json",
        success: function(data){
            var obj=Object(data);
            if (obj.valid==true){
                var direccion=obj.direccion;
                var complementario=obj.complementario;
                var cod_postal=obj.cod_postal;
                var poblacion=obj.poblacion;
                var provincia=obj.provincia;   
                var lat=obj.lat;   
                var lng=obj.lng;
                carrito_domicilio['coordenadas']={lat:lat,lng:lng};
                //comprobar que está en zona de reparto
                var server=servidor+'includes/leezonasreparto.php';
                $.ajax({
                    type: "POST",
                    url: server,
                    data: { id:id, },
                    dataType:"json",
                    success: function(data){
                        var obj=Object(data);
                        if (obj.valid==true){
                            var nombre=obj.nombre;
                            var precio=obj.precio;
                            var minimo=obj.minimo;
                            var reparto=obj.reparto;
                            var zonas=obj.zonas;
                            var buscar=new google.maps.LatLng(parseFloat(lat), parseFloat(lng));
                            var esta='no';
                            var noreparto='no';
                            var portes=0;
                            var minimo_domicilio=0;
                            for(x=0;x<zonas.length;x++){
                                for (j=0;j<zonas[x].length;j++){
                                    zonas[x][j]={ "lat": parseFloat(zonas[x][j]['lat']), "lng": parseFloat(zonas[x][j]['lng']) };
                                }
                                var polygon = new google.maps.Polygon({paths:zonas[x],map: map});
                                //console.log(buscar);
                                var isWithinPolygon = google.maps.geometry.poly.containsLocation(buscar, polygon);
                                if (isWithinPolygon){
                                    esta='si';
                                    portes=precio[x];
                                    minimo_domicilio=minimo[x];
                                    if (reparto[x]=='0'){
                                        // zona no reparto
                                        noreparto='si';
                                    }   
                                    if (portesgratis==0 ){
                                        if (carritoSubtotal<minimo_domicilio) {
                                            muestraMensaje('El pedido no llega al mínimo para esta zona de reparto', titulo='Error',subtitulo='Mínimo '+minimo_domicilio+'€');
                                            return;
                                        }
                                    }
                                }
                                
                            }
                            if ((esta=='si')&&(noreparto=='no')) {
                                carrito_domicilio['direccion'] = direccion;
                                carrito_domicilio['complementario'] = complementario;
                                carrito_domicilio['cod_postal'] = cod_postal;
                                carrito_domicilio['poblacion'] = poblacion;
                                carrito_domicilio['provincia'] = provincia;
                                carrito_domicilio['envio'] = portes;
                                carrito_domicilio['minimo'] = minimo_domicilio;
                                miLocalStorage.setItem('carrito_domicilio', JSON.stringify(carrito_domicilio));
                                
                                //app.dialog.alert(direccion);
                                checkout_4();                                            
                            }
                            else {
                                muestraMensaje('El domicilio seleccionado NO está en nuestra zona de reparto',titulo='',subtitulo='Error');
                                
                            }

                            
                        }
                    },
                    error: function (xhr, ajaxOptions, thrownError) {
                        console.log(xhr.status);
                        console.log(thrownError);
                    }
                });
   
                
            }
        },
        error: function (xhr, ajaxOptions, thrownError) {
            console.log(xhr.status);
            console.log(thrownError);
        }
    });
                 
    
    
}

function checkout_4(){
    
    if (dias_vista>1){
        //fecha_pedido=$('#fecha_pedido').val();
    }
    
    var f = new Date();
    var hoy = diaCastellano(f.getDate()) + "/" + mesCastellano(f.getMonth()) + "/" + f.getFullYear(); 
    var txt_fecha_pedido=fecha_pedido;
    if (tipo_envio==1){
        if (portesgratis==1 && portesgratismensaje==1){
            //carrito_domicilio['envio'] = '0';
            if (carritoSubtotal>=importeportesgratis){
                carrito_domicilio['envio'] = '0';
                muestraMensaje('¡El envío te sale gratis!',titulo='',subtitulo='Envío gratis','',3000);
            }
            else {
                var falta=(importeportesgratis-carritoSubtotal).toFixed(2);
                muestraMensaje('Te falta <b>'+falta+'</b>€ para envío gratis.',titulo='',subtitulo='¿Quieres envío gratis?','',6000);
            }
        }
    }
    var txt_envio='<div style="font-size:16px;">';
     
    if (tipo_envio==2){
        txt_envio+='<b>A recoger</b>';
    }
    else {
        txt_envio+='<b>Entrega en domicilio</b>';
    }
    //console.log(fecha_pedido);
    //hora_envio=$('#hora-reparto').val(); 
    if(fecha_pedido==hoy){
        txt_fecha_pedido='Hoy';
       
    }
            
    var txt_pre=txt_envio+'<br><b>'+txt_fecha_pedido+'</b> -> Hora:<b>'+hora_envio+'</b><br>'
    $('#icon-back-checkout').show(); 
    document.getElementById("link-volver-checkout").href = "javascript:checkout_3();";
    if (window.localStorage.getItem("username")!=""){
        //registrado
    }
    
    var txt=progresscheckout(4);
    monedero_a_usar=0;
    descuento=0;
    cupon_usado='';

    //var cart=ponetotales();
    
    var cart=ponetotales();
    var txt_cart='<div id="cart-final">'+cart+'</div>';
    var txt2='<p>¿Desea comentarnos algo?<span id="caracteres" style="float:right;"></span></p>'+
            '<div class="list inline-labels" style="margin:0;margin-bottom: -15px;">'+
            '<ul>'+
            '<li class="item-content item-input" style="padding-left: 0;">'+
                '<div class="item-inner">'+

                  '<div class="item-input-wrap">'+
                    '<textarea id="comentario" onkeyup="evaluatextomsg();" class="resizable" placeholder="Escriba un comentario"></textarea>'+
                  '</div>'+
                '</div>'+
            '</li>'+
            '</ul>'+
            '</div><br>';
        var fondo_codigo_promo='lightgray';
        if (modooscuro==1){
            fondo_codigo_promo='white';
        }
        txt2+='<div class="" id="div-codigopromocion" style="display: flex;">'+
                    '<div class="" style="width: 60%;" ><input type="text" id="codigopromocion" placeholder="CÓDIGO PROMOCIÓN" style="border: solid 1px '+colorprimario+';background-color: '+fondo_codigo_promo+';border-radius: 30px;margin-right: 10px;margin-bottom: 10px;padding-left: 15px;font-size: 12px;height: 30px;width: 90%;" ></div>'+
                    '<div class="button button-fill button-round" onclick="tengocupon();" style="width: 40%;">Aplicar</div>'+
                '</div>'+
            '<div id="metodo-de-pago">'+
                '<p>Seleccione método de pago:</p>';
        var img='efectivo';
        var chk="";
         // logica monedero
        if (fidelizacion==1){
            var monedero_actual=desencripta(window.localStorage.getItem("mi_monedero")); 
            //console.log('monedero:'+monedero_actual);       
            var porcentaje=desencripta(window.localStorage.getItem("porcentaje_fidelizacion"));
            if (parseFloat(monedero_actual) >0) {

                if (parseFloat(monedero_actual) >(carritoSubtotal+parseFloat(carrito_domicilio['envio'])-descuento)) {
                    monedero_actual=carritoSubtotal+parseFloat(carrito_domicilio['envio'])-descuento;

                }

                txt2+='<p style="display: flex;"><label class="checkbox"><input type="checkbox" onclick="cambiausomonedero(this);" id="monedero" /><i class="icon-checkbox"></i></label>&nbsp;&nbsp;<i class="f7-icons">giftcard</i>&nbsp;&nbsp;usar <b>&nbsp;<span id="valor-monedero-usar">'+parseFloat(monedero_actual).toFixed(2) +'</span>&nbsp;€</b>&nbsp;de mi tarjeta monedero</p>';
            }   
        }
        for (x=0;x<metodosdepago.length;x++){
            if (metodosdepago[x]['id']==1){
                //img='efectivo';<img src="img/tarjeta_regalo.png" width="24px" height="auto"  align="absmiddle">
                img='&nbsp;&nbsp;<img src="img/cash.png" width="24px" height="auto"  align="absmiddle">&nbsp;&nbsp;';
                if(modooscuro==1){
                    img='&nbsp;&nbsp;<img src="img/cash_white.png" width="24px" height="auto"  align="absmiddle">&nbsp;&nbsp;';
                }
                //img='&nbsp;&nbsp;<i class="material-icons">payments</i>&nbsp;&nbsp;';
                
                chk="checked";

            }
            else{
                //img='tarjetas';
                img='&nbsp;&nbsp;<i class="f7-icons">creditcard</i>&nbsp;&nbsp;';
                chk="checked";
            }
            

            txt2+='<p style="display: flex;"><label class="radio"><input type="radio" name="metodo_pago" id="metodo_pago" value="'+metodosdepago[x]['idrevo']+'" '+chk+' onclick="cambiametodopago(this)";/><i class="icon-radio"></i></label> '+img+'  '+metodosdepago[x]['nombre']+'</p>';
            

        }
        txt2+='<div id="div-tarjeta" style="display:none;"></div>';   
        txt2+='<div class="list" style="margin: 0;margin-left: -15px;"><ul>'+
                '<li id="id-politicas" >'+
                    '<label class="item-checkbox item-content">'+
                        '<input type="checkbox" name="condiciones-checkbox" value="1" />'+
                        '<i class="icon icon-checkbox" style="border-radius:0;"></i>'+
                        '<div class="item-inner">'+
                            '<div class="item-title" style="font-size:.7em;">Acepto los <a href="#" class="link" onclick="leetexto(\'Términos de servicio\',\'terminos.txt\')">Términos y condiciones</a>.</div>'+
                       '</div>'+
                    '</label>'+
                '</li>'+
            '</ul></div>';

        txt2+='<br><div class="row"><button onclick="comprapaso5();" class="col-60 button  button-round button-outline" style="margin:auto;height: 35px; width: 80%;" id="comprar-paso5" disabled >Continuar</button></div></div>';
    var txt_botoncancelar='<br><button class="button button-fill color-red button-round"  onclick="cancelacheckout();" style="font-size:.8em;width:60%;margin:auto;background-color: '+colorsecundario+';" >Volver al carrito</button>';
    
    $('#checkout-page').html(txt+txt_pre+txt_cart+txt2+txt_botoncancelar+'</div>');
    

    $('#id-politicas input[name*="condiciones-checkbox"]').on('click', function () {
        var estado=$('#id-politicas input[name*="condiciones-checkbox"]').prop('checked');
        if (estado==true){
            $('#comprar-paso5').prop( "disabled", false );
            //button-fill .addClass( "tab-link-active" );
            $('#comprar-paso5').addClass( 'button-fill' );
        }
        else {
            $('#comprar-paso5').removeClass( 'button-fill' );
            $('#comprar-paso5').prop( "disabled", true );
        }

    });
    
 
    
}

function trunc (x, posiciones = 0) {
  var s = x.toString()
  var l = s.length
  var decimalLength = s.indexOf('.') + 1
  var numStr = s.substr(0, decimalLength + posiciones)
  return Number(numStr)
}

function ponetotales(){
descuento=trunc (descuento, 2);
  
    var cantidad='1 artículo';
    
    if (carrito.length>1){
        cantidad=carrito.length+' artículos';
    }
    
    var txt_descuento='';
    var txt_monedero='';
    if (descuento>0){
        if (cupon_usado!=''){
            txt_descuento='<span class="text-color-red">Descuento ('+cupon_usado+')<span style="float:right;">-'+descuento.toFixed(2)+'€</span></span><br>';
            
        }
        else {
            txt_descuento='<span class="text-color-red">Descuento<span style="float:right;">-'+descuento.toFixed(2)+'€</span></span><br>';
        }
    }
    if (monedero_a_usar>0){
        var subtotal=carritoSubtotal-descuento+parseFloat(carrito_domicilio['envio']);
        if(monedero_a_usar>subtotal) {
            monedero_a_usar=subtotal;
            console.log('cambio valor');
            $('#valor-monedero-usar').html(monedero_a_usar.toFixed(2));
            
        }
        txt_monedero='<span class="text-color-red">Fidelización<span style="float:right;">-'+(monedero_a_usar).toFixed(2)+'€</span></span><br>';
    }
    
    cantidad+=' <span onclick="muestraocultacarrito();" id="detalles-carrito" >(<span class="text-color-primary">mostrar detalles <i class="f7-icons" style="font-size:14px;">chevron_down</i></span>)</span>';
    

    
    
     var cart='<span>'+cantidad+'<span style="float:right;">'+carritoSubtotal.toFixed(2)+'€</span></span><span style="display:none;" id="carrito-oculto"><br><br>'+mostrarcarrito()+'</span><br>'+
         
    //'<span>Impuestos<span style="float:right;">'+carritoIva.toFixed(2)+'€</span></span><br>'+
        // '<span><span style="float:right;">'+carritoSubtotal.toFixed(2)+'€</span></span><br>'+
         
    '<span>Gastos envio <span style="float:right;">' +parseFloat(carrito_domicilio['envio']).toFixed(2)+ '€</span></span><br>'+
    txt_descuento+txt_monedero+
    
    '<span><b>Total (impuestos inc.)</b><span style="float:right;"><b>'+
    (carritoSubtotal+parseFloat(carrito_domicilio['envio'])-descuento-monedero_a_usar).toFixed(2)+'€</b></span></span>';
    
    


    
    return cart;
    
}
    
function progresscheckout(steep){
    var txt='<div class="breadcrumbs checkout" style="font-size: calc(.5em + 1vw);">';
    
    var separador='<div class="breadcrumbs-separator"></div>';
    
    var txt1='<div class="breadcrumbs-item">'+
            '<i class="icon material-icons">shopping_cart</i>'+
            '<span>Carrito</span>'+
        '</div>';
    
    var txt2='<div class="breadcrumbs-item">'+
            '<i class="icon f7-icons">person_fill</i>'+
            '<span>Usuario</span>'+
        '</div>';
    
    var txt3='<div class="breadcrumbs-item">'+
            '<i class="icon material-icons">delivery_dining</i>'+
            '<span>Envío</span>'+
        '</div>';  
    if (tipo_repartos==2){
        txt3='<div class="breadcrumbs-item">'+
            '<i class="icon material-icons">shopping_bag</i>'+
            '<span>Recoger</span>'+
        '</div>'; 
    }
    
    var txt4='<div class="breadcrumbs-item">'+ 
            '<i class="icon f7-icons">creditcard</i>'+
            '<span>Pago</span>'+
        '</div>';
   
    if (steep==1) {
        txt1='<div class="breadcrumbs-item" style="color:'+colorprimario+';">'+
            '<i class="icon material-icons">shopping_cart</i>'+
            '<span>Carrito</span>'+
        '</div>';
    }    
    if (steep==2) {
        txt1='<div class="breadcrumbs-item" style="color:'+colorprimario+';"><a href="javascript:checkout_1();" class="link">'+
            '<i class="icon material-icons">shopping_cart</i>'+
            '<span>Carrito</span>'+
        '</a></div>';
        txt2='<div class="breadcrumbs-item" style="color:'+colorprimario+';">'+
            '<i class="icon f7-icons">person_fill</i>'+
            '<span>Usuario</span>'+
        '</div>';
    }    
    if (steep==3) {
        txt1='<div class="breadcrumbs-item" style="color:'+colorprimario+';"><a href="javascript:checkout_1();" class="link">'+
            '<i class="icon material-icons">shopping_cart</i>'+
            '<span>Carrito</span>'+
        '</a></div>';
        txt2='<div class="breadcrumbs-item" style="color:'+colorprimario+';"><a href="javascript:checkout_2();" class="link">'+
            '<i class="icon f7-icons">person_fill</i>'+
            '<span>Usuario</span>'+
        '</a></div>';
        txt3='<div class="breadcrumbs-item" style="color:'+colorprimario+';">'+
            '<i class="icon material-icons">delivery_dining</i>'+
            '<span>Envío</span>'+
        '</div>'; 
        if (tipo_repartos==2){
            txt3='<div class="breadcrumbs-item" style="color:'+colorprimario+';">'+
                '<i class="icon material-icons">shopping_bag</i>'+
                '<span>Recoger</span>'+
            '</div>'; 
        }
    }  
    if (steep==4) {
        txt1='<div class="breadcrumbs-item" style="color:'+colorprimario+';"><a href="javascript:checkout_1();" class="link">'+
            '<i class="icon material-icons">shopping_cart</i>'+
            '<span>Carrito</span>'+
        '</a></div>';
        txt2='<div class="breadcrumbs-item" style="color:'+colorprimario+';"><a href="javascript:checkout_2();" class="link">'+
            '<i class="icon f7-icons">person_fill</i>'+
            '<span>Usuario</span>'+
        '</a></div>';
        txt3='<div class="breadcrumbs-item" style="color:'+colorprimario+';"><a href="javascript:checkout_3();" class="link">'+
            '<i class="icon material-icons">delivery_dining</i>'+
            '<span>Envío</span>'+
        '</a></div>'; 
        if (tipo_repartos==2){
            txt3='<div class="breadcrumbs-item" style="color:'+colorprimario+';">'+
                '<i class="icon material-icons">shopping_bag</i>'+
                '<span>Recoger</span>'+
            '</div>'; 
        }
        txt4='<div class="breadcrumbs-item" style="color:'+colorprimario+';">'+ 
            '<i class="icon f7-icons">creditcard</i>'+
            '<span>Pago</span>'+
        '</div>';
    }  
    txt=txt+txt1+separador+txt2+separador+txt3+separador+txt4+'</div><br>';
    return(txt);
}

function cancelacheckout() {
    app.tab.show('#view-carrito');
    $('.toolbar-bottom').show();
    $('#boton-menu-principal').show();
    $('#checkout-page').html('');
    $('#icon-back-checkout').hide(); 
    document.getElementById("link-volver-checkout").href = "#";
}

function cambiaDiaEnviodesdeCalendario(fecha){
    fecha_pedido=fecha;
    var d=new Date();  
    //console.log(fecha_pedido);
    var h=d.getHours();
    var m=d.getMinutes();
    var s=d.getSeconds();
    if (h<=9){
        h='0'+h;
    }
    if (m<=9){
        m='0'+m;
    }
    if (s<=9){
        s='0'+s;
    }
    // 01/34/6789
    //var dString=fecha_pedido.substr(6,4)+'-'+fecha_pedido.substr(3,2)+'-'+fecha_pedido.substr(0,2)+' '+h+':'+m+':'+s;
    var dString=fecha_pedido.substr(6,4)+'-'+fecha_pedido.substr(3,2)+'-'+fecha_pedido.substr(0,2)+' 00:00:00';
    //console.log(dString);
    ponehorasdehoy(new Date(dString));
    
    
}

function cambiaDiaEnvio(elm){
    //cambiametodoenvio()
    var elemento=$(elm);
    var fecha=elemento.attr('data-fecha');

    fecha_pedido=fecha;
    $('.button-fecha-reparto').removeClass('button-fill');
    $('.button-fecha-reparto').removeClass('button-raised');
    $('.button-fecha-reparto').addClass('button-raised');
    elemento.removeClass('button-raised');
    elemento.addClass('button-fill');
    var d=new Date();  
    //console.log(fecha_pedido);
    var h=d.getHours();
    var m=d.getMinutes();
    var s=d.getSeconds();
    if (h<=9){
        h='0'+h;
    }
    if (m<=9){
        m='0'+m;
    }
    if (s<=9){
        s='0'+s;
    }
    // 01/34/6789
    var dString=fecha_pedido.substr(6,4)+'-'+fecha_pedido.substr(3,2)+'-'+fecha_pedido.substr(0,2)+' '+h+':'+m+':'+s;
    //console.log(dString);
    ponehorasdehoy(new Date(dString));
    
    
}

function cambiametodoenvio(){
    //pedidominimo 1 domicilio
    //console.log('cambiametodoenvio');
    var envio=1; //domicilio
    $('#metodo-de-envio [name="metodo_envio"]:checked').each(
        function() {
         envio =$(this).val();
            if (envio==1){
                if (parseFloat(carritoSubtotal)<parseFloat(pedidominimo)){
                    app.dialog.alert('Su pedido no llega al mínimo para envío: '+pedidominimo+'€','Atención');
                    checkout_1();
                }
                
            }
            
        }
    );
    
    var opciones='';
    var texto=' de reparto ';

    if (envio=='1') {
        if (disponiblereparto.length==0){
            muestraMensaje('No tenemos horario para '+fecha_pedido,titulo='',subtitulo='Horario reparto');
            $('#compra-paso-2').prop('disabled', true);
        }
        else {
            $('#compra-paso-2').prop('disabled', false);
        }
        
        if (tipo_seleccion_horas==1){
            for (x=0;x<disponiblereparto.length;x++){
                if (x==0){
                    chk_cocina=' checked';
                }

                opciones+='<option value="'+disponiblereparto[x]+'" '+chk_cocina+'>'+disponiblereparto[x]+txtCortesia(disponiblereparto[x])+'</option>';
            }
        }
        if (tipo_seleccion_horas==2){
            for (x=0;x<disponiblereparto.length;x++){
                opciones+='<button class="button-horario button button-large button-raised" data-hora="'+disponiblereparto[x]+'">'+disponiblereparto[x]+txtCortesia(disponiblereparto[x])+'</button>';
            }
        }
        
        //var txt_hora_cortesia='';

    }
    else {
        texto='de recogida';
        carrito_domicilio['envio']=0;
        var cart=ponetotales();
        
        $('#buy-cart').html(cart); 
        if (disponiblecocina.length==0){
            muestraMensaje('No tenemos horario para '+fecha_pedido,titulo='',subtitulo='Horario recogida');
            $('#compra-paso-2').prop('disabled', true);
            
        }
        else {
            $('#compra-paso-2').prop('disabled', false);
        }
        
        if (tipo_seleccion_horas==1){
            for (x=0;x<disponiblecocina.length;x++){
                if (x==0){
                    chk_cocina=' checked';
                }

                opciones+='<option value="'+disponiblecocina[x]+'" '+chk_cocina+'>'+disponiblecocina[x]+txtCortesia(disponiblecocina[x])+'</option>';
            }
        }
        if (tipo_seleccion_horas==2){
            for (x=0;x<disponiblecocina.length;x++){
                opciones+='<button class="button-horario button button-large button-raised" data-hora="'+disponiblecocina[x]+'">'+disponiblecocina[x]+txtCortesia(disponiblecocina[x])+'</button>';
            }
        }
        
     
    }
    var entrega='';
    if (tipo_seleccion_horas==1){
        entrega='Seleccione hora '+texto+': <i class="f7-icons size-22">hand_point_right_fill</i> '+
        '<span style="display: inline-block;"><select id="hora-reparto" style="height:20px;font-size:16px;">'+opciones+'</select></span>';
    }
    if (tipo_seleccion_horas==2){
        entrega='<p>Seleccione hora: '+texto+'</p><p class="grid grid-cols-2 grid-gap">'+opciones+'</p>';
    }
    $('#horas-entrega').html(entrega);
    
    // detección clic
    $('.button-horario').on( "click", function() {
        var elemento=$(this);
        var hora=elemento.attr('data-hora');
        //console.log(hora);
        hora_envio=hora;
        $('.button-horario').removeClass('button-fill');
        elemento.addClass('button-fill');
        $('#compra-paso-2').addClass('button-fill');
        $('#compra-paso-2').removeClass('button-raised');
        $('#compra-paso-2').prop("disabled",false);
        
    });
    if (tipo_seleccion_horas==2){
        $('#compra-paso-2').removeClass('button-fill');
        $('#compra-paso-2').addClass('button-raised');
        $('#compra-paso-2').prop("disabled",true);
    }

}

function leemetodospago(){
    
    var server=servidor+'includes/leemetodospago.php';
    $.ajax({
        url: server,
        data:{id:'',isapp:isApp},
        method: "post",
        dataType:"json",
        success: function(data){    
            var obj=Object(data);
            if (obj.valid==true){
                var id=obj.id;
                var nombre=obj.nombre;

                var activo=obj.activo;
                var idrevo=obj.idrevo;
                var j=0;

                for (x=0;x<nombre.length;x++){
                    if (activo[x]=='1'){
                        metodosdepago[j]={'id':id[x],'nombre':nombre[x],'idrevo':idrevo[x]};
                        j++;
                    }
                }

                // agregar a metodosdepago
            }
            else{
               
                muestraMensaje('Error leyendo métodos de pago',titulo='',subtitulo='Error');
            }
        }
    });

}

function leehorariosreparto(){
    var server=servidor+'includes/leehorariosreparto.php';
    $.ajax({
        url: server,
        data:{id:'',isapp:isApp},
        method: "post",
        dataType:"json",
        success: function(data){    
            var obj=Object(data);
            if (obj.valid==true){
                var intervalo=parseInt(obj.intervalo);
                //console.log(obj); 
                
                var lunes=obj.lunes;
                var martes=obj.martes;
                var miercoles=obj.miercoles;
                var jueves=obj.jueves;
                var viernes=obj.viernes;
                var sabado=obj.sabado;
                var domingo=obj.domingo;
                
                var ld1=obj.ld1;
                var lh1=obj.lh1;
                var ld2=obj.ld2;
                var lh2=obj.lh2;
                var md1=obj.md1;
                var mh1=obj.mh1;
                var md2=obj.md2;
                var mh2=obj.mh2;
                var xd1=obj.xd1;
                var xh1=obj.xh1;
                var xd2=obj.xd2;
                var xh2=obj.xh2; 
                var jd1=obj.jd1;
                var jh1=obj.jh1;
                var jd2=obj.jd2;
                var jh2=obj.jh2;
                var vd1=obj.vd1;
                var vh1=obj.vh1;
                var vd2=obj.vd2;
                var vh2=obj.vh2;
                var sd1=obj.sd1;
                var sh1=obj.sh1;
                var sd2=obj.sd2;
                var sh2=obj.sh2;
                var dd1=obj.dd1;
                var dh1=obj.dh1;
                var dd2=obj.dd2;
                var dh2=obj.dh2;
                
                var lp=obj.lp;  
                var mp=obj.mp;
                var xp=obj.xp;  
                var jp=obj.jp; 
                var vp=obj.vp;  
                var sp=obj.sp;
                var dp=obj.dp;  
                
                if(lunes!='0'){
                    diasreparto['lunes']=llenahoras(lp,ld1,lh1,ld2,lh2,intervalo);       
                }
                else {
                    diasreparto['lunes']=new Array();
                }
                if(martes!='0'){
                    diasreparto['martes']=llenahoras(mp,md1,mh1,md2,mh2,intervalo);       
                }
                else {
                    diasreparto['martes']=new Array();
                }
                if(miercoles!='0'){
                    diasreparto['miercoles']=llenahoras(xp,xd1,xh1,xd2,xh2,intervalo);       
                }
                else {
                    diasreparto['miercoles']=new Array();
                }
                if(jueves!='0'){
                    diasreparto['jueves']=llenahoras(jp,jd1,jh1,jd2,jh2,intervalo);       
                }
                else {
                    diasreparto['jueves']=new Array();
                }
                
                if(viernes!='0'){
                    diasreparto['viernes']=llenahoras(vp,vd1,vh1,vd2,vh2,intervalo);   
                    
                }
                else {
                    diasreparto['viernes']=new Array();
                }
                
                
                if(sabado!='0'){
                    diasreparto['sabado']=llenahoras(sp,sd1,sh1,sd2,sh2,intervalo);       
                }
                else {
                    diasreparto['sabado']=new Array();
                }
                if(domingo!='0'){
                    diasreparto['domingo']=llenahoras(dp,dd1,dh1,dd2,dh2,intervalo);       
                }
                else {
                    diasreparto['domingo']=new Array();
                }
                //console.log(diasreparto);
            }
            else{
                muestraMensaje('Error leyendo horario de reparto',titulo='',subtitulo='Error');
                
            }
        },
        error: function (xhr, ajaxOptions, thrownError) {
            console.log(xhr.status);
            console.log(thrownError);
        }
        
    });

    
    
    var server=servidor+'includes/leehorarioscocina.php';
    $.ajax({
        url: server,
        data:{id:'',isapp:isApp},
        method: "post",
        dataType:"json",
        success: function(data){ 
            var obj=Object(data);
            if (obj.valid==true){
                var intervalo=parseInt(obj.intervalo);

                //console.log(obj); 
                var lunes=obj.lunes;
                var martes=obj.martes;
                var miercoles=obj.miercoles;
                var jueves=obj.jueves;
                var viernes=obj.viernes;
                var sabado=obj.sabado;
                var domingo=obj.domingo;
                
                var ld1=obj.ld1;
                var lh1=obj.lh1;
                var ld2=obj.ld2;
                var lh2=obj.lh2;
                var md1=obj.md1;
                var mh1=obj.mh1;
                var md2=obj.md2;
                var mh2=obj.mh2;
                var xd1=obj.xd1;
                var xh1=obj.xh1;
                var xd2=obj.xd2;
                var xh2=obj.xh2; 
                var jd1=obj.jd1;
                var jh1=obj.jh1;
                var jd2=obj.jd2;
                var jh2=obj.jh2;
                var vd1=obj.vd1;
                var vh1=obj.vh1;
                var vd2=obj.vd2;
                var vh2=obj.vh2;
                var sd1=obj.sd1;
                var sh1=obj.sh1;
                var sd2=obj.sd2;
                var sh2=obj.sh2;
                var dd1=obj.dd1;
                var dh1=obj.dh1;
                var dd2=obj.dd2;
                var dh2=obj.dh2;
                
                var lp=obj.lp;  
                var mp=obj.mp;
                var xp=obj.xp;  
                var jp=obj.jp; 
                var vp=obj.vp;  
                var sp=obj.sp;
                var dp=obj.dp;  
                
                if(lunes!='0'){
                    diascocina['lunes']=llenahoras(lp,ld1,lh1,ld2,lh2,intervalo);       
                }
                else {
                    diascocina['lunes']=new Array();
                }
                if(martes!='0'){
                    diascocina['martes']=llenahoras(mp,md1,mh1,md2,mh2,intervalo);       
                }
                else {
                    diascocina['martes']=new Array();
                }
                if(miercoles!='0'){
                    diascocina['miercoles']=llenahoras(xp,xd1,xh1,xd2,xh2,intervalo);       
                }
                else {
                    diascocina['miercoles']=new Array();
                }
                if(jueves!='0'){
                    diascocina['jueves']=llenahoras(jp,jd1,jh1,jd2,jh2,intervalo);       
                }
                else {
                    diascocina['jueves']=new Array();
                }
                if(viernes!='0'){
                    diascocina['viernes']=llenahoras(vp,vd1,vh1,vd2,vh2,intervalo);       
                }
                else {
                    diascocina['viernes']=new Array();
                }
                
                if(sabado!='0'){
                diascocina['sabado']=llenahoras(sp,sd1,sh1,sd2,sh2,intervalo);   
                    
                }
                else {
                    diascocina['sabado']=new Array();
                }
                if(domingo!='0'){
                    diascocina['domingo']=llenahoras(dp,dd1,dh1,dd2,dh2,intervalo);       
                }
                else {
                    diascocina['domingo']=new Array();
                }
                //console.log(diasreparto);
            }
            else{
              
                muestraMensaje('Error leyendo horario de regogidas',titulo='',subtitulo='Error');
            }
        },
        error: function (xhr, ajaxOptions, thrownError) {
            console.log(xhr.status);
            console.log(thrownError);
        }
    });
}

function llenahoras(partido,d1,h1,d2,h2,intervalo){
    var horario=new Array();
    var desde=new Date();
    var hasta=new Date();
    var intSeg=intervalo*60000;
    if (h1=='00:00:00'){
        h1='23:59:59';

    }
    if (h2=='00:00:00'){
        
        h2='23:59:59';
        
    }
            

    desde.setHours(parseInt(d1.substr(0,2)));
    desde.setMinutes(parseInt(d1.substr(3,2)));
    hasta.setHours(parseInt(h1.substr(0,2)));
    hasta.setMinutes(parseInt(h1.substr(3,2)));
    var x=0;
    while(desde <= hasta){
        horario[x]=desde.toTimeString().substr(0,5);
        x++;
        desde=new Date(desde.getTime() +intSeg);
    }
    if (partido!='0'){
        //horario partido
        desde.setHours(parseInt(d2.substr(0,2)));
        desde.setMinutes(parseInt(d2.substr(3,2)));
        hasta.setHours(parseInt(h2.substr(0,2)));
        hasta.setMinutes(parseInt(h2.substr(3,2)));
        while(desde <= hasta){
            horario[x]=desde.toTimeString().substr(0,5);
            x++;
            desde=new Date(desde.getTime() +intSeg);
        }
    }
    //console.log(horario);
    return horario;
}

function cancelarcompra() {
    app.dialog.create({
          //title: 'Vertical Buttons',
        text: '¿Cancelar el proceso de compra?',
        buttons: [
            {
                text: 'Si, cancelar',
                color: 'red',
                onClick: function () {
                    
                        carrito_domicilio['direccion'] = "";
                        carrito_domicilio['complementario'] = "";
                        carrito_domicilio['cod_postal'] = "";
                        carrito_domicilio['poblacion'] = "";
                        carrito_domicilio['provincia'] = "";
                        carrito_domicilio['envio'] = "0";
                        carrito_domicilio['minimo']="0"
                        descuento=0;
                        cupon_usado=0;
                        monedero_a_usar=0
                        tipo_descuento="";
                        $('.subnavbar').show();
                        $('#search').show();
                        muestragrupos();
                }  
            },
            {
                text: 'No, seguir',
            },
        ],
        verticalButtons: true,
    }).open();
    
    
}

function mostrarcarrito(){
    var txt='';
    for (var x=0;x<carrito.length;x++) {
        var extras="";
        if (carrito[x]['modificadores']!=null){
            var modis=carrito[x]['modificadores'];     
            if (modis.length>0){   
                for (y=0;y<modis.length;y++){
                    extras+=modis[y]['nombre']+', ';
                }    
                extras=extras.slice(0, -2);
            }

        }
        if (carrito[x]['menu']==0){
            txt+='<hr>  <div style="align-items: center;display: flex;">'+
                '<div class="col-35" style="width:35%;"><img src="'+carrito[x]['img']+'" width="80px" height="auto"></div>'+
                '<div class="col-65 text-aling-left" style="width:65%;">'+carrito[x]['nombre']+'<br><span style="font-size:.7em;">'+
                extras+'</span><br><div style="text-align: right;"><span style="font-size:.9em;">'+
                carrito[x]['cantidad']+' x </span><span class="text-color-primary" style="font-size:1.2em;">'+carrito[x]['precio']+'€</span><br><span class="text-color-primary" style="font-size:.8em;font-style: italic;float:left;">'+carrito[x]['comentario']+'</span></div></div>'+    
            '</div>';
        }
        else {
            txt+='<hr>  <div style="align-items: center;display: flex;">'+
                '<div class="col-35" style="width:35%;"><img src="'+carrito[x]['img']+'" width="80px" height="auto"></div>'+
                '<div class="col-65 text-aling-left" style="width:65%;">'+carrito[x]['nombre']+'<br><span style="font-size:.7em;">'+
                extras+'</span><br><div style="text-align: right;"><span style="font-size:.9em;">'+
                carrito[x]['cantidad']+' x </span><span class="text-color-primary" style="font-size:1.2em;">'+carrito[x]['precio']+'€</span><br><span class="text-color-primary" style="font-size:.8em;font-style: italic;float:left;">'+carrito[x]['comentario']+'</span></div></div>'+    
            '</div>';
            var elem=carrito[x]['elmentosMenu'];  
            
            for (j=0;j<elem.length;j++){
                
            txt+='<div style="align-items: center;display: flex;">'+
                '<div class="col-35 " style="width:35%;"><img src="'+elem[j]['img']+'" width="60px" height="auto"></div>'+
                '<div class="col-65 text-aling-left" style="width:35%;"><span style="font-size:.9em;">'+elem[j]['nombre']+'</span><br><div style="text-align: right;"><span style="font-size:.9em;">'+
                elem[j]['cantidad']+' x </span><span class="text-color-primary" style="font-size:1.2em;">'+elem[j]['precio']+'€</span></div></div>'+    
            '</div>';
            }
        }
    }
    
    return txt+'<hr>';
}

function muestraocultacarrito() {
    

    if ( $('#carrito-oculto').css('display') == 'none' || $('#carrito-oculto').css("visibility") == "hidden"){
       
        $('#carrito-oculto').show();
        $('#detalles-carrito').html('(<span class="text-color-primary">ocultar detalles <i class="f7-icons" style="font-size:14px;">chevron_up</i></span>)');
    }
    else {
        
         $('#carrito-oculto').hide();
        $('#detalles-carrito').html('(<span class="text-color-primary">mostrar detalles <i class="f7-icons" style="font-size:14px;">chevron_down</i></span>)');
    }
}

function tengocupon(){
    if($('#codigopromocion').val()!=""){
        var user=desencripta(localStorage.getItem('user'));
        // tipo_envio =1 recoger
        miLocalStorage.setItem('cupon','');
        miLocalStorage.setItem('idcupon','0');
        var server=servidor+'includes/buscapromo.php';
        $.ajax({
            type: "POST",
            url: server,
            data: {codigo:$('#codigopromocion').val(),usuario:user},
            dataType:"json",
            success: function(data){
                var obj=Object(data);
                if (obj.valid==true){
                    var dias=obj.logica;
                    var desde=obj.desde;
                    var hasta=obj.hasta;
                    var tipo=obj.tipo;
                    var nombre=obj.nombre;
                    var codigo=obj.codigo;
                    var activo=obj.activo;
                    var id=obj.id;
                    var logica=obj.logica;
                    var producto=obj.producto;
                    var envio_recoger=obj.envio_recoger;
                    var usuario=obj.usuario;
                    var usupermitido=obj.usupermitido;
                    var grupo=obj.grupo;
                    var maximo=obj.maximo;
                    var emitidos=obj.emitidos;
                    var valido=obj.valido;
                    var motivo=obj.motivo;
                    var hoy=new Date();
                    var d=new Date();
                    var h=new Date();
                    var importecarrito=carritoSubtotal;
                    miLocalStorage.setItem('idcupon',encripta(id));
                    if ((id==1)||(id==2)){
                        if (valido=='no'){
                            muestraMensaje(motivo,titulo='',subtitulo='Error');
                            return;
                        }
                    }
                    else {                   
                        d.setFullYear(parseInt(desde.substr(0,4)));
                        h.setFullYear(parseInt(hasta.substr(0,4)));
                        d.setMonth(parseInt(desde.substr(5,2))-1);
                        h.setMonth(parseInt(hasta.substr(5,2))-1);
                        d.setDate(parseInt(desde.substr(8,2)));
                        h.setDate(parseInt(hasta.substr(8,2)));
                        d.setHours(parseInt(desde.substr(11,2)));
                        h.setHours(parseInt(hasta.substr(11,2)));
                        d.setMinutes(parseInt(desde.substr(14,2)));
                        h.setMinutes(parseInt(hasta.substr(14,2)));

                        if (hoy.getTime()>h.getTime()){
                            muestraMensaje('Código caducado',titulo='',subtitulo='Error');
                            return;
                        }
                        if (hoy.getTime()<d.getTime()) {
                             muestraMensaje('Código  aún no es válido',titulo='',subtitulo='Error');
                            return;
                        }
                    }


                    if (usupermitido=='no'){
                        muestraMensaje('Cupón no válido',titulo='',subtitulo='Error');
                        return;
                    }
                    if (activo==0){

                        muestraMensaje('Cupón no válido',titulo='',subtitulo='Error');
                        return;
                    }
                    if (maximo>0){
                        if (parseInt(emitidos)>=parseInt(maximo)){

                            muestraMensaje('Cupón no válido, ya está agotado.',titulo='',subtitulo='Error');
                            return;
                        }
                    }
                    
                    if (hoy.getTime()>h.getTime()){
                        muestraMensaje('Cupón caducado',titulo='',subtitulo='Error');
                        return;
                    }
                    if (id>2){
                        if (hoy.getTime()<d.getTime()) {
                            muestraMensaje('Cupón aún no es válido',titulo='',subtitulo='Error');
                            return;
                        }
                    }
     
                    if ((id==1)||(id==2)){
                        
                    }
                   
                    //'<option value="1">% Dto. Global</option>'+
                    //<option value="2">% Dto. Producto</option>'+
                    //<option value="3">Envío Gratis</option>'+
                    //<option value="4">Importe descuento</option>'+
 
                    var partes=logica.split('##');
                    
                    if (tipo=='1') {
                      
                        if (partes[1]!=""){
                            if (parseFloat(partes[1])>parseFloat(carritoSubtotal)) {
                               
                                muestraMensaje('El pédido minimo es de '+partes[1]+ '€',titulo='',subtitulo='Pedido mínimo');
                                return;
                            }
                        }
                        descuento=parseFloat(carritoSubtotal)*parseFloat(partes[0])/100;
                        tipo_descuento='1#'+partes[0];
                    }
                    if (tipo=='2') {
                        partes=logica.split('##');
                        var subtotal=0;
                        for (var x=0;x<carrito.length;x++) {
                            var item=carrito[x]['id'].split('-');
                            if (item[0]==partes[1]){  
                                subtotal+=carrito[x]['cantidad']*parseFloat(carrito[x]['precio']);
                                tipo_descuento='2#'+partes[0]+'#'+carrito[x]['id'];
                                
                            }
                        }
                        if (subtotal==0){
                           
                            muestraMensaje('Código no válido',titulo='',subtitulo='Error');
                            return;
                        }
                        descuento=subtotal*parseFloat(partes[0])/100;     
                        
                    }
                    if (tipo=='7') {
                        partes=logica.split('##');
                        var subtotal=0;
                        for (var x=0;x<carrito.length;x++) {
                            var item=carrito[x]['categoria'].split('-');
                            if (item[0]==partes[1]){  
                                subtotal+=carrito[x]['cantidad']*parseFloat(carrito[x]['precio']);
                                tipo_descuento='2#'+partes[0]+'#'+carrito[x]['id'];
                                
                            }
                        }
                        if (subtotal==0){
                           
                            muestraMensaje('Código no válido',titulo='',subtitulo='Error');
                            return;
                        }
                        descuento=subtotal*parseFloat(partes[0])/100;     
                        
                    }
                    if (tipo=='3') {

                             if (parseFloat(partes[0])>parseFloat(carritoSubtotal)) {
                              
                                  muestraMensaje('El pédido minimo de este código es de '+partes[0]+ '€',titulo='',subtitulo='Pedido mínimo');
                                return;
                            }
                         
                        descuento=parseFloat(carrito_domicilio['envio']);
                        tipo_descuento='3#'+carrito_domicilio['envio'];
                       
                    }   
                    if (tipo=='4') {
                        if (partes[1]!=""){
                            if (parseFloat(partes[1])>parseFloat(carritoSubtotal)) {
                               
                                muestraMensaje('El pédido minimo es de '+partes[1]+ '€',titulo='',subtitulo='Pedido mínimo');
                                return;
                            }
                        }
                        descuento=parseFloat(partes[0]);
                        tipo_descuento='4#'+partes[0];
                    
                    }
                    if (tipo=='5') {
                        //prod
                        
                        partes=logica.split('##');
                        
                        var H=partes[0];
                        var J=partes[1];
                        var regalo=H-J;
                        
                        var coin=new Array();
                        var losprod=partes[3].split(',');
                        for (var x=0;x<carrito.length;x++) {
                            var item=carrito[x]['id'].split('-');
                           for (j=0;j<losprod.length;j++){
                            if (item[0]==losprod[j]){ 
                              coin.push({cantidad:carrito[x]['cantidad'],precio:carrito[x]['precio'],nombre:carrito[x]['nombre']});
                            }
                           }
                        }
                        if (coin.length>0){
                            var suma=0;
                            var precio=coin[0]['precio'];
                            var cantidad=0;
                            for (var x=0;x<coin.length;x++) {
                                if (coin[x]['precio']<precio){
                                    precio=coin[x]['precio'];
                                }
                                cantidad+=coin[x]['cantidad'];
                                suma+=(coin[x]['precio']*coin[x]['cantidad']);
                                
                            }
                            
                            
                            
                            
                            var corresponde=Math.trunc(cantidad/H);
                            corresponde=corresponde*regalo;
                            if (corresponde==0){
                                muestraMensaje('Necesitas '+H+' productos de la promoción y solo tienes '+cantidad,titulo='',subtitulo='Error');
                                return;
                            }
                            var precio_medio=(suma/cantidad).toFixed(3);
                            if (partes[2]==1){
                                descuento=corresponde*precio;
                            }
                            else {
                                descuento=corresponde*precio_medio;
                            }
                            
                            
                        }
                        else {
                            muestraMensaje('No hay ningún producto para este Cupón en el carrito',titulo='',subtitulo='Error');
                            return;
                        }
                    }
                    if (tipo=='6') {
                        //cat
                        
                        partes=logica.split('##');
                        
                        var H=partes[1];
                        var J=partes[2];
                        var regalo=H-J;
                        
                        var coin=new Array();
                        
                        for (var x=0;x<carrito.length;x++) {
                            var item=carrito[x]['categoria'];
                            
                            if (item==partes[0]){ 
                                coin.push({cantidad:carrito[x]['cantidad'],precio:carrito[x]['precio']});
                            }
                        }
                        if (coin.length>0){
                            var suma=0;
                            var productos=0;
                            var precio=coin[0]['precio'];
                            var cantidad=0;
                            for (var x=0;x<coin.length;x++) {
                                if (coin[x]['precio']<precio){
                                    precio=coin[x]['precio'];
                                }
                                cantidad+=coin[x]['cantidad'];
                                suma+=(coin[x]['precio']*coin[x]['cantidad']);
                            
                            }
                            
                            
                            var corresponde=Math.trunc(cantidad/H);
                             corresponde=corresponde*regalo;
                            
                            if (corresponde==0){
                                muestraMensaje('Necesitas '+H+' productos de la misma categoria y solo tienes '+cantidad,titulo='',subtitulo='Error');
                                return;
                            }
                            var precio_medio=(suma/cantidad).toFixed(2);
                            if (partes[3]==1){
                                descuento=corresponde*precio;
                            }
                            else {
                                descuento=corresponde*precio_medio;
                            }
                           
                            
                        }
                        else {
                            muestraMensaje('No hay ningún producto para este Cupón en el carrito',titulo='',subtitulo='Error');
                            return;
                        }
                    }
                    // tipo_envio =1 recoger
                    //console.log('tipo_envio:'+tipo_envio);
                    if (envio_recoger!=0){
                        if (envio_recoger!=tipo_envio){
                            muestraMensaje('Código no válido',titulo='',subtitulo='Error');
                            return;
                        }
                    }
                    cupon_usado=$('#codigopromocion').val();
                    $('#div-codigopromocion').hide();
                   //console.log('Descuento:'+descuento) ;
                    miLocalStorage.setItem('cupon',encripta(descuento));
                    //console.log('Descuento:'+ desencripta(miLocalStorage.getItem('cupon')) )
                    //console.log('Idcupon:'+ desencripta(miLocalStorage.getItem('idcupon')) )
                    muestraMensaje('Descuento aplicado: <b>'+descuento.toFixed(2)+'</b> €',titulo='',subtitulo='Descuento Ok');
                    
                    var cart=ponetotales();
                    if (monedero_a_usar>0){
                        var subtotal=carritoSubtotal-descuento+parseFloat(carrito_domicilio['envio']);
                        if(monedero_a_usar>subtotal) {
                            monedero_a_usar=subtotal;
                            console.log('cambio valor');
                            $('#valor-monedero-usar').html(monedero_a_usar.toFixed(2));

                        }
                    }

                    $('#cart-final').html(cart); 
                    //console.log('Descuento:'+tipo_descuento);
                    //console.log('Cupon:'+cupon_usado);
  
                }
                else{
                    
                    muestraMensaje('Código no válido',titulo='',subtitulo='Error');
                    $('#codigopromocion').val('');
                }
            },
            error: function (xhr, ajaxOptions, thrownError) {
                console.log(xhr.status);
                console.log(thrownError);
            }
        });
         
        
    }
}

function evaluatextomsg() {  
    $('#caracteres').css('color',colorprimario); 
    var texto=document.getElementById("comentario").value;
     document.getElementById("caracteres").innerHTML=(140-texto.length);
    if(texto.length>140){
        document.getElementById("comentario").value=texto.substring(0,texto.length-1);
        document.getElementById("caracteres").innerHTML='0';
    }
}

function cambiametodopago(e){
    var sitarjeta=$('#metodo_pago').prop('checked');
    //alert(sitarjeta);
     if (sitarjeta){
        $('#div-tarjeta').hide();
     }
    else {
        $('#div-tarjeta').show();
    }
}

function cambiausomonedero(e){
    var activo=$('#monedero').prop('checked');
    //console.log(activo);
    if (activo){
        monedero_a_usar=parseFloat($('#valor-monedero-usar').html());
    }
    else {
        monedero_a_usar=0;
    }

    var cart=ponetotales();
    $('#cart-final').html(cart); 
}

function comprapaso5(){
    
    var tarjeta=1;
    $('#metodo-de-pago [name="metodo_pago"]:checked').each(
        function() {
         tarjeta =$(this).val();
        }      
    );  

    
    if (tarjeta==idRedys){
        /*
        var divTarjeta ='<div id="mis-tarjetas" style="display:none;"></div>'+
            '<form class="list" id="comprar-form-tarj" style="margin-top:5px;">'+
                '<input type="hidden" name="id" value=""/>'+   
                '<input type="hidden" name="idtarj" value=""/>'+
                '<ul>'+

                    '<li>'+
                        '<div class="item-content item-input">'+
                            '<div class="item-inner">'+
                                '<div class="item-title item-label">Titular</div>'+
                                '<div class="item-input-wrap">'+
                                    '<input type="text" id="titular" name="titular" placeholder="Titular" value="" required validate autocomplete="off" style="text-transform: uppercase;"/>'+
                                '</div>'+
                            '</div>'+
                        '</div>'+
                    '</li>'+ 
                    '<li>'+
                        '<div class="item-content item-input">'+
                            '<div class="item-inner">'+
                                '<div class="item-title item-label">Número</div>'+
                                '<div class="item-input-wrap" style=" display: inherit;">'+
                                    '<input type="text" id="numero" name="numero" placeholder="Número" value="" required validate autocomplete="off" onkeyup="this.value=observaNumeroTarjeta(this.value,\'img-tarjeta\');"/><div style="float: right;"><img src="img/tarjetas/none.png" height="30" width="auto" id="img-tarjeta"></div>'+
                                '</div>'+
                            '</div>'+
                        '</div>'+
                    '</li>'+ 
                    '<li>'+
                        '<div class="item-content item-input">'+
                            '<div class="item-inner">'+
                                '<div class="item-title item-label">Validez</div>'+
                                '<div class="item-input-wrap">'+
                                    '<input type="text" id="mm" name="mm" placeholder="mm" value="" pattern="[0-9]{2}" required validate style="float:left;width: 30px;"/>'+'<span style="float:left;position: relative;top: 8px;"> / </span>'+
                                    '<input type="text" id="aa" name="aa" placeholder="aa" value="" pattern="[0-9]{2}" required validate style="float: left;width: 50px;position: relative;left: 10px;"/>'+
                                '</div>'+
                            '</div>'+
                        '</div>'+
                    '</li>'+ 
                    '<li>'+
                        '<div class="item-content item-input">'+
                            '<div class="item-inner">'+
                                '<div class="item-title item-label">CSV</div>'+
                                '<div class="item-input-wrap" style=" display: inherit;">'+
                                    '<input type="text" id="csv" name="csv" placeholder="CSV" value="" required validate autocomplete="off" pattern="[0-9]{3}|[0-9]{4}"/>'+
                                '</div>'+
                            '</div>'+
                        '</div>'+
                    '</li>'+ 
                '</ul>'+
            '</form>';
        document.getElementById('div-tarjeta').innerHTML =divTarjeta;
        $('#div-tarjeta').show();
        //console.log(miLocalStorage.getItem('user'));
        if (miLocalStorage.getItem('user')>0){
            var server=servidor+'includesapp/buscatarjetas.php';  
                app.request.postJSON(server, { id:miLocalStorage.getItem('user'), }, 
                function (data) {
                    var obj=Object(data);
                    if (obj.valid==true){
                       
                        var txt='<div class="list">'+
                            '<ul>'+
                            '<li>'+
                             '<a class="item-link smart-select" data-open-in="sheet" data-sheet-close-link-text="Cerrar">'+
                                '<select name="tarjetas" onchange="verTarjeta();">';

             
                        var alias=obj.alias;
                        var idTarjeta=obj.id;
                        var titular=obj.titular;
                        var numero=obj.numero;
                        var aa=obj.aa;
                        var mm=obj.mm;
                        var csv=obj.csv;
                        var tipo=obj.tipo;

                        for (x=0;x<alias.length;x++){
                            var ali='';
                            if (alias[x]!=""){
                                ali=alias[x];
                            }
                            else {
                                ali='Mi tarjeta '+(x+1);
                            }
                                
                            var encriptado=encriptatarjeta(numero[x]);
                            txt+=''+     
                               '<option value="'+idTarjeta[x]+'" data-display-as="'+ali+'" data-option-image="img/tarjetas/'+tipo[x]+'.png" data-titular="'+titular[x]+'" data-alias="'+ali+'" data-numero="'+numero[x]+'" data-mm="'+mm[x]+'" data-aa="'+aa[x]+'" data-csv="'+csv[x]+'" data-tipo="'+tipo[x]+'" onclick="verTarjeta();">'+encriptado.slice(encriptado.length-8,encriptado.length)+' - '+ali+'</option>';
                                
                            
                                             
                        } 
                        txt+='</select>'+
                            '<div class="item-content">'+
                            '  <div class="item-inner">'+
                                '<div class="item-title">Seleccione tarjeta</div>'+
                              '</div>'+
                            '</div>'+
                          '</a>'+
                        '</li> '+                        
                            '</ul>'+
                            '</div>';
                        
                        $('#mis-tarjetas').html(txt); 
                        $('#mis-tarjetas').show(); 
                        if (alias.length==1) {
                            $('#mis-tarjetas').hide(); 
                        }
                        $('#comprar-form-tarj').find("#titular").val(titular[0]);
                        $('#comprar-form-tarj').find("#numero").val(numero[0].replace(/([0-9]{4})/g, '$1 '));
                        $('#comprar-form-tarj').find("#mm").val(mm[0]);
                        $('#comprar-form-tarj').find("#aa").val(aa[0]);
                        $('#comprar-form-tarj').find("#csv").val(csv[0]);
                        $('#img-tarjeta').attr("src",'img/tarjetas/'+tipo[0]+'.png');
                        document.getElementById("comprar-paso5").onclick = function (){terminarcompra();};
                    }
                    else {
                        txt="";
                    }
                },
                function (xhr, status) {
            });                  
            
        }
        
        
        */
        //app.accordion.close('.item4');

        //$('#div-tarjeta').hide();
        terminarcompra();   
    }
    else {
        //app.accordion.close('.item4');

        //$('#div-tarjeta').hide();

        terminarcompra();        
    }

}

function verTarjeta() {

    
    app.smartSelect.close('.smart-select');

    $('#comprar-form-tarj').find("#titular").val($('.smart-select').find(':selected').attr('data-titular'));
    $('#comprar-form-tarj').find("#numero").val($('.smart-select').find(':selected').attr('data-numero').replace(/([0-9]{4})/g, '$1 '));
    $('#comprar-form-tarj').find("#mm").val($('.smart-select').find(':selected').attr('data-mm'));
    $('#comprar-form-tarj').find("#aa").val($('.smart-select').find(':selected').attr('data-aa'));
    $('#comprar-form-tarj').find("#csv").val($('.smart-select').find(':selected').attr('data-csv'));
    $('#img-tarjeta').attr("src",'img/tarjetas/'+$('.smart-select').find(':selected').attr('data-tipo')+'.png');
}


function terminarcompra(){
    //console.log('terminarcompra');
    //status=miLocalStorage.getItem('status');
    //var fidelizacion=miLocalStorage.getItem('fidelizacion');
    
    var cliente=0;
    var tratamiento=0;
    var nombre='';
    var apellidos='';
    var email='';
    var telefono='';
    var publicidad='';
    var hora=hora_envio;
    var dia=fecha_pedido;
    var importe=carritoSubtotal.toFixed(2);
    var portes=parseFloat(carrito_domicilio['envio']).toFixed(2);
    var mi_monedero=0;
   var porcentaje_fidelizacion=0;
   
   if (fidelizacion=='1'){
       porcentaje_fidelizacion=parseFloat(desencripta(miLocalStorage.getItem('porcentaje_fidelizacion'))).toFixed(2);
       mi_monedero=parseFloat(desencripta(miLocalStorage.getItem('mi_monedero'))).toFixed(2);
   } 
    var des =descuento.toFixed(2);
    var monedero =monedero_a_usar.toFixed(2);
    var tot=carritoSubtotal+parseFloat(carrito_domicilio['envio'])-descuento-monedero_a_usar;
    var total=tot.toFixed(2);
    var importe_fidelizacion=0;
    var cupon=0;
    var idcupon=0;
    var codigocupon='';
    if (window.localStorage.getItem("cupon")!=null) {

        cupon=desencripta(miLocalStorage.getItem('cupon'));
        idcupon=desencripta(miLocalStorage.getItem('idcupon'));
        codigocupon=$('#codigopromocion').val();
    } 
    if (fidelizacion=='1'){
        if(miLocalStorage.getItem('username')!=""){
        
            importe_fidelizacion=(carritoSubtotal*porcentaje_fidelizacion/100).toFixed(2);
           var nuevo_monedero=(parseFloat(mi_monedero)-parseFloat(monedero)+parseFloat(importe_fidelizacion)).toFixed(2);
           /*
           console.log('importe_fidelizacion:'+importe_fidelizacion);
        
           console.log('mi_monedero:'+mi_monedero); 
           console.log('monedero_a_usar'+monedero_a_usar); console.log('mi_monedero:'+nuevo_monedero); 
           */ miLocalStorage.setItem('mi_monedero',encripta(nuevo_monedero));
        }
        
    }
    //console.log('codigocupon:'+codigocupon);
    //console.log('cupon:'+cupon);
    //return
    var canal=1;
    if (isApp){
        canal=2;
    }
    
    if (window.localStorage.getItem("username")!=""){
        var formData = app.form.convertToData('#my-form-usu');
        tratamiento=formData['tratamiento'];
        publicidad=formData['publi-checkbox'];
        nombre=$('#my-form-usu input[name*="nombre"]').val();
        apellidos=$('#my-form-usu input[name*="apellidos"]').val();
        telefono=$('#my-form-usu input[name*="telefono"]').val();
        email=desencripta(window.localStorage.getItem("username")); ; 
        cliente=desencripta(miLocalStorage.getItem('user'));
    }
    else {
        //var formData = app.form.convertToData('#my-form-usu-compra');
        tratamiento=carrito_invitado['tratamiento'];
        publicidad=carrito_invitado['publicidad'];
        nombre=carrito_invitado['nombre'];
        apellidos=carrito_invitado['apellidos'];
        telefono=carrito_invitado['telefono'];
        email=carrito_invitado['email'];
    }

    var envio=tipo_envio;
    
    var tarjeta=1;
    $('#metodo-de-pago [name="metodo_pago"]:checked').each(
        function() {
         tarjeta =$(this).val();
        }
        
    );
    
    if (tarjeta==idRedys) {
        //verificar tarjeta
        /*
        var formData = app.form.convertToData('#comprar-form-tarj');
        var errores="";

        var titular=formData['titular'].toUpperCase();
        var numero=formData['numero'].replace(/\s/g, '');
        var mm=formData['mm'];
        var aa=formData['aa'];
        var csv=formData['csv'];
        var tipo="";

        var today = new Date();
        var myDate=new Date();
        myDate.setFullYear(2000+parseInt(aa));
        myDate.setMonth(parseInt(mm)-1); 

        if (titular==''){
            errores+='Titular, ';
        }
        if (numero==''){
            errores+='Número, ';
        }
        
        if (mm==''){
            errores+='Mes , ';
        }
        if (aa==''){
            errores+='Año, ';
        }
        if (csv==''){
            errores+='CSV, ';
        }
        if (myDate<today){
            errores+='Tarjeta caducada, ';
        }
        if (errores!=''){
            errores = 'Revise: '+errores.substring(0, errores.length - 2)+'.';
            app.dialog.alert(errores);
            return;
            
        }          
        var obj=checkCreditCard(numero);
        if (obj['success']==false){
           
             muestraMensaje(obj['message'],titulo='',subtitulo='Error');
            return;
        }
        
        */
        console.log('Tarjeta');
        
    }
    
    var comentario=document.getElementById("comentario").value;
    var txt='Datos compra:<hr>'+
        nombre + ' '+apellidos+'<br>'+
        telefono+'<br>'+
        email+'<br>'+
        'fecha: '+dia+'<br>'+
        'hora: '+hora+'<br>'+
        'Subtotal: '+importe+'<br>'+
        'Envío: '+portes+'<br>'+
        'Descuento: '+des+'<br>'+
        'Monedero: '+monedero+'<br>'+
        'Total: <b>'+total+'</b><br>'+
        'Metodo envío: '+envio+'<br>'+
        'Metodo pago: '+tarjeta+'<br>'+
        'cupon: '+cupon+'<br>'+
        'idcupon: '+idcupon+'<br>'+
        'cupon: '+cupon_usado+'<br>'+
        'Comentario: '+comentario;


    //console.log(txt);
    //app.dialog.alert(txt);
    
    // verificar si esta libre la hora
    //console.log('disponiblereparto');
    //console.log(disponiblereparto);
    //console.log('disponiblecocina');
    //console.log(disponiblecocina);
    
    var server=servidor+'includes/verificahoralibre.php'; 
    $.ajax({
        type: "POST",
        url: server,
        data: {envio:envio, hora:hora, dia:dia,disponiblereparto:disponiblereparto,disponiblecocina:disponiblecocina},
        dataType:"json",
        success: function(data){
            var obj=Object(data);
            if (obj.valid==true){
               
                var server=servidor+'includes/addpedido.php';  
                $.ajax({
                    type: "POST",
                    url: server,
                    data: {cliente:cliente,canal:canal,tratamiento:tratamiento,nombre:nombre,apellidos:apellidos, telefono:telefono, email:email,carrito:carrito, publicidad:publicidad, domicilio:carrito_domicilio, envio:envio,tarjeta:tarjeta, hora:hora,dia:dia, subtotal:parseFloat(carritoSubtotal), portes:parseFloat(carrito_domicilio['envio']), descuento:parseFloat(descuento), tipo_descuento:tipo_descuento, monedero:parseFloat(monedero_a_usar),total:parseFloat(tot), importe_fidelizacion:parseFloat(importe_fidelizacion), cupon:cupon, comentario:comentario, codigocupon:codigocupon,  idcupon:idcupon},
                    dataType:"json",
                    success: function(data){
                        var obj=Object(data);
                        if (obj.valid==true){

                            //console.log('Tarjeta:'+parseInt(tarjeta));
                            // tarjeta -> antes 1 ahora idRedsys
                            if (parseInt(tarjeta)==parseInt(idRedsys)) {             
                                document.all.iframe_tpv.src = servidor+'includes/tpv.php?importe='+total+'&order='+obj.order+'&idpedido='+obj.idpedido;

                                //document.all.iframe_tpv.src = servidor+'includes/tpv.php?importe='+total+'&order='+obj.order+'&idpedido='+obj.idpedido+'&num_tar=4548810000000003&mm=12&aa=49';

                                navegar('#view-tpv');

                                $('.toolbar-bottom').hide();
                                $('#boton-menu-principal').hide();

                                $('#countdown-tpv').css('color',colorprimario);
                                totalTimeTpv=300;
                                myTimeoutTarjetaActivo='si';
                                var seconds = Date.now();
                                window.localStorage.setItem('nowseconds',seconds);
                                updateClockTpv(obj.idpedido,cliente);
                                
                                
                                


                            }
                            else {
                                finalizaPedido(obj.idpedido,obj.order,2);
                            }                
                        }
                        else {


                             muestraMensaje('Error procesando pedido',titulo='',subtitulo='Error');
                        }
                        if (cliente>0){

                            buscapedidos(desencripta(window.localStorage.getItem("user"),1));
                        }
                    },
                    error: function (xhr, ajaxOptions, thrownError) {
                        console.log(xhr.status);
                        console.log(thrownError);
                    }
                });
              
                
            }
            else {
                app.dialog.alert('La hora <b>'+hora+'</b> para <b>'+fecha_pedido+'</b><br>ya no está disponible.<br>Seleccione otra hora','Atención');
                
                checkout_3();
            }
        },
        error: function (xhr, ajaxOptions, thrownError) {
            console.log(xhr.status);
            console.log(thrownError);
        }
    });
    
    //return;
    

}



function secondsToString(seconds) {
  
  var minute = Math.floor((seconds / 60) % 60);
  //minute = (minute < 10)? '0' + minute : minute;
  var second = seconds % 60;
  second = (second < 10)? '0' + second : second;
  return minute + ':' + second;
}



var totalTimeTpv=0;

var myTimeoutTarjetaActivo='no';

function updateClockTpv(idPedido,cliente) {
    if (myTimeoutTarjetaActivo=='si'){
        document.getElementById('countdown-tpv').innerHTML = secondsToString(totalTimeTpv);
        var ahora=parseInt(Date.now());
        var antes= parseInt(window.localStorage.getItem('nowseconds'));

        var dif=(ahora-antes)/1000;
        var resta=Math.round(300-dif);
        //console.log('Dif:'+dif);
        //console.log('resta:'+resta);
        //totalTimeTpv=Math.round(dif);
        document.getElementById('countdown-tpv').innerHTML = secondsToString(resta);

        if (dif>=300){ //5 min
           totalTimeTpv=0;
        }    
        if(totalTimeTpv==0){

        //cancelaPedido(obj.idpedido);
        if (cliente>0){
            buscapedidos(desencripta(window.localStorage.getItem("user"),1));
        }
        document.all.iframe_tpv.src ='';
        navegar('#view-checkout');
        $('.toolbar-bottom').show();
        $('#boton-menu-principal').show();
        var server=servidor+'includes/cancelapedido.php';  
            $.ajax({
                url: server,
                data:{idpedido:idPedido },
                method: "post",
                dataType:"json",
                success: function(data){ 
                    var obj=Object(data);
                    if (obj.valid==true){
                        console.log('cancelado');
                        checkout_3(); 
                    }
                    else {
                        console.log('error');
                    }
                },
                error: function (xhr, ajaxOptions, thrownError){
                    console.log(xhr.status);
                    console.log(thrownError);
                }
            });  
        }else{
            totalTimeTpv-=1;
            myTimeoutTarjeta=setTimeout('updateClockTpv('+idPedido+','+cliente+')', 1000);
      } 
    } 
}


function finalizaPedido(idpedido,pedido,modo){
    //modo 2 efectivo
    //modo 1 tarjeta
    /*
    console.log('finalizaPedido');
    console.log('Modo:'+modo);
    console.log('Pedido:'+pedido);
    */
    if(modo!=idRedsys){
        //efectivo u otrro
        //var fidelizacion=miLocalStorage.getItem('fidelizacion');
        var porcentaje_fidelizacion=0;
        var importe_fidelizacion=0;
        
        var mi_monedero=0;
        //var monedero =monedero_a_usar.toFixed(2);

        if (fidelizacion=='1'){
            porcentaje_fidelizacion=parseFloat(desencripta(miLocalStorage.getItem('porcentaje_fidelizacion'))).toFixed(2);
            importe_fidelizacion=0;
        
            mi_monedero=parseFloat(desencripta(miLocalStorage.getItem('mi_monedero'))).toFixed(2);
            monedero =monedero_a_usar.toFixed(2);
            
            if(miLocalStorage.getItem('username')!=""){
                importe_fidelizacion=(carritoSubtotal*porcentaje_fidelizacion/100).toFixed(2);     
            }
        }  

        // mail: idpedido, pedido
        
        
        
        var txt='Hemos recibido tu pedido.';
        //console.log('Registrado:'+desencripta(miLocalStorage.getItem('registrado')));
        //console.log('Fide:'+importe_fidelizacion);
        
        if ((importe_fidelizacion>0)&&(desencripta(miLocalStorage.getItem('registrado'))=='si')){
            txt+='<br>Has acumulado <b>'+importe_fidelizacion+'</b>€ en tu monedero';
        }
        muestraMensaje(txt,titulo='',subtitulo='Gracias por tu compra','pedido-recibido.jpg',tiempo=5000);
        borradatoscompra();
        // pedidoPagado(pedido);
        //return;
    }
    else {
        // tarjeta
    

    }
    
    if (fidelizacion=='1'){ 
        $('#importe-mi-monedero').html('<b>'+parseFloat(desencripta(miLocalStorage.getItem('mi_monedero'))).toFixed(2)+'</b> €');  
    }
    
    if(integracion==1){
        // pedido a Revo 
        
        var server=servidor+'includes/pedidoaRevo.php'; 
        $.ajax({
            url: server,
            data:{idpedido:idpedido, numero:pedido },
            method: "post",
            dataType:"json",
            success: function(data){ 
                var obj=Object(data);
                if (obj.valid==true){
                    var idRevo=obj.idRevo;
                    //console.log('idRevo:'+idRevo);
                    if (idRevo>0){
                        //console.log('Actualizando ..'+idRevo);
                        actualizapedidoRevo(idpedido,idRevo,pedido);
                        
                        if (delivery>0){
                            //console.log('delivery pedido:'+idpedido);
                            enviaDelivery(idpedido);
                            
                        }
                       
                        
                        
                        
                    }
                    else {
                        // volver a reintentar?
                        console.log('Error revo');
                        var tarjeta=1;
                        $('#metodo-de-pago [name="metodo_pago"]:checked').each(
                            function() {
                             tarjeta =$(this).val();
                            }

                        );
                        

                        //modo 2 efectivo
                        //modo 1 tarjeta

                    }

                }
            },
            error: function (xhr, ajaxOptions, thrownError){
                console.log(xhr.status);
                console.log(thrownError);
            }
        });

    }
    else {
        //star
        // hacer tiket
        // idpedido, pedido
        enviaelmail(idpedido,'pedido',pedido);
        var server=servidor+'includes/imprimeticket.php';  
        $.ajax({
            url: server,
            data:{idpedido:idpedido,numero:pedido},
            method: "post",
            dataType:"json",
            success: function(data){ 
                var obj=Object(data);
                if (obj.valid==true){
                   console.log('ticket enviado');
                    //muestraMensaje(obj.msg,titulo='',subtitulo='Revise su correo');
                    if (delivery>0){
                            //console.log('delivery pedido:'+idpedido);
                            enviaDelivery(idpedido);
                            
                    }
                }
            }
            ,
            error: function (xhr, ajaxOptions, thrownError){
                console.log(xhr.status);
                console.log(thrownError);
            }
        });
        
    }
    
}

function enviaDelivery(idpedido){
    //console.log('enviaDelivery:'+idpedido);
    
    var server=servidor+'includes/enviaDelivery.php';  
    $.ajax({
        url: server,
        data:{idpedido:idpedido,delivery:delivery},
        method: "post",
        dataType:"json",
        success: function(data){ 
            var obj=Object(data);
            if (obj.valid==true){
               //console.log('pedido enviado a Delivery');
                //console.log(obj.msg);
                
            }
            else {
                //console.log(obj.msg);
            }
        }
        ,
        error: function (xhr, ajaxOptions, thrownError){
            console.log(xhr.status);
            console.log(thrownError);
        }
    });
}

function enviaelmail(idpedido,tipo,pedido){
    var server=servidor+'includes/envioemail.php';  

        $.ajax({
            url: server,
            data:{idpedido:idpedido,tipo:tipo,numero:pedido},
            method: "post",
            dataType:"json",
            success: function(data){ 
                var obj=Object(data);
                if (obj.valid==true){
                   //console.log('mail enviado');

                }
                else {
                    console.log('error mail');
                }
            },
            error: function (xhr, ajaxOptions, thrownError){
                console.log(xhr.status);
                console.log(thrownError);
            }
        });
}

function actualizapedidoRevo(idpedido,idrevo,pedido){
    //console.log('Actualizando ..');
    var server=servidor+'includes/actualizapedidoRevo.php';  
    $.ajax({
        url: server,
        data:{idpedido:idpedido, idrevo:idrevo},
        method: "post",
        dataType:"json",
        success: function(data){ 
            var obj=Object(data);
            if (obj.valid==true){
                //var idRevo=obj.idRevo;
                // Añadir la id de revo al pedido
                //console.log('actualizado numeroRevo');
                enviaelmail(idpedido,'pedido',pedido);
                

            }
            else {
                console.log('error');
            }
        },
        error: function (xhr, ajaxOptions, thrownError){
            console.log(xhr.status);
            console.log(thrownError);
        }
    });  
}

function borradatoscompra(){
    // borrado de carrito 
    carrito = [];
    carrito_domicilio = {direccion:'',complementario:'',cod_postal:'',poblacion:'',provincia:'',envio:'0',minimo:'0'} 
    carritohtml = "";
    carritoSubtotal=0;
    totalItemCarrito=0;
    tipo_descuento='';
    descuento=0;
    guardarCarritoEnLocalStorage();
    miLocalStorage.setItem('carrito_domicilio', JSON.stringify(carrito_domicilio));
    miLocalStorage.removeItem('cupon');
    miLocalStorage.removeItem('idcupon');
    cargarCarritoDeLocalStorage();
    calcularTotal();
    renderizarCarrito();
    totalItemCarrito=calcularTotal();
    $('.subnavbar').show();
    $('#search').show();
    navegar('#view-catalog');
    //muestragrupos(); 
}


/*
function pedidoPagado(pedido){
    var server=servidor+'includesapp/pedidopagado.php';  
        app.request.postJSON(server, { pedido:pedido, }, 
            function (data) {
                var obj=Object(data);
                if (obj.valid==true){
                }
               },
            function (xhr, status) {
        });    
}
*/

function cancelaPedido(idpedido){
    var server=servidor+'includes/cancelapedido.php';  
    $.ajax({
        url: server,
        data:{idpedido:idpedido },
        method: "post",
        dataType:"json",
        success: function(data){ 
            var obj=Object(data);
            if (obj.valid==true){
                console.log('cancelado');
            }
            else {
                console.log('error');
            }
        },
        error: function (xhr, ajaxOptions, thrownError){
            console.log(xhr.status);
            console.log(thrownError);
        }
    });
  
    
    borradatoscompra();
    
}

var map;
function initMap() {
 map = new google.maps.Map(document.getElementById("map"), {
    center: {  lat: 36.60113320, lng: -6.22815830 },
    zoom: 18,
  });
}


function editaDomicilioCompra(id) {
    var alias='';
    var idDomi='';
    var direccion=''; 
    var complementario=''; 
    var cod_postal='';
    var poblacion='';
    var provincia='';
    var titulo="Crear dirección";

        idDomi='NUEVO'
        titulo="Nueva dirección";
        //console.log('Nuevo');




    var texto=""+
    '<form class="list" id="my-form-domi-compra" style="margin-top:25px;">'+
        '<input type="hidden" name="id" value="'+id+'"/>'+   
        '<input type="hidden" name="iddomi" value="'+idDomi+'"/>'+
        '<ul>'+
            '<li>'+
                '<div class="item-content item-input">'+
                    '<div class="item-inner">'+
                        '<div class="item-title item-label">Alias</div>'+
                        '<div class="item-input-wrap">'+
                            '<input type="text" name="alias" placeholder="Alias" value="'+alias+'"/>'+
                        '</div>'+
                    '</div>'+
                '</div>'+
            '</li>'+
            '<li>'+
                '<div class="item-content item-input">'+
                    '<div class="item-inner">'+
                        '<div class="item-title item-label">Dirección</div>'+
                        '<div class="item-input-wrap">'+
                            '<input type="text" id="midireccionactual" name="direccion" placeholder="Dirección" value="'+direccion+'" required validate/>'+
                        '</div>'+
                    '</div>'+
                '</div>'+
            '</li>'+ 
            '<li>'+
                '<div class="item-content item-input">'+
                    '<div class="item-inner">'+
                        '<div class="item-title item-label">Dirección complementaria</div>'+
                        '<div class="item-input-wrap">'+
                            '<input type="text" name="complementario" placeholder="Dirección complementaria" value="'+complementario+'"/>'+
                        '</div>'+
                    '</div>'+
                '</div>'+
            '</li>'+ 
            '<li>'+
                '<div class="item-content item-input">'+
                    '<div class="item-inner">'+
                        '<div class="item-title item-label">Cod. Postal</div>'+
                        '<div class="item-input-wrap">'+
                            '<input type="text" name="cod_postal" placeholder="Cod. Postal" value="'+cod_postal+'" required validate/>'+
                        '</div>'+
                    '</div>'+
                '</div>'+
            '</li>'+ 
            '<li>'+
                '<div class="item-content item-input">'+
                    '<div class="item-inner">'+
                        '<div class="item-title item-label">Población</div>'+
                        '<div class="item-input-wrap">'+
                            '<input type="text" name="poblacion" placeholder="Población" value="'+poblacion+'" required validate/>'+
                        '</div>'+
                    '</div>'+
                '</div>'+
            '</li>'+
            '<li>'+
                '<div class="item-content item-input">'+
                    '<div class="item-inner">'+
                        '<div class="item-title item-label">Provincia</div>'+
                        '<div class="item-input-wrap">'+
                            '<input type="text" name="provincia" placeholder="Provincia" value="'+provincia+'" required validate/>'+
                        '</div>'+
                    '</div>'+
                '</div>'+
            '</li>'+ 
        '</ul>'+
    '</form>'+
    '<div class="text-align-center" style="width:50%;margin:auto;"><a class="button button-fill button-round" id="guarda-datos-domicilio" href="#" onclick="guardaDomicilioCompra();">Guardar</a></div>  ';

    var dynamicPopup = app.popup.create({
        content:  ''+
          '<div class="popup">'+
        '<p class="text-color-primary" style="float: right;"><a class="link popup-close"><i class="icon f7-icons">xmark</i></a></p>'+
            '<div class="block page-content">'+
              
                ' <div class="block-title block-title-medium">'+titulo+'</div>'+
                '<div class="block">'+texto+'<br></div>'+
            '</div>'+
          '</div>'
         ,
        // Events
        
    });  
    
    dynamicPopup.open();  
    //navegar('#view-setting-domi');
    
  
                          
}

function guardaDomicilioCompra() {
    var formData = app.form.convertToData('#my-form-domi-compra');
    //app.dialog.alert(JSON.stringify(formData));
    var errores="";
    var id=formData['id'];
    var iddomi=formData['iddomi'];
    var alias=formData['alias'];
    var direccion=formData['direccion'];
    var complementario=formData['complementario'];
    var cod_postal=formData['cod_postal'];
    var poblacion=formData['poblacion'];
    var provincia=formData['provincia'];
    
    if (direccion==''){
        errores+='Dirección, ';
    }
    if (cod_postal==''){
        errores+='Código Postal, ';
    }
    if (poblacion==''){
        errores+='Población, ';
    }
    if (provincia==''){
        errores+='Provioncia, ';
    }
    if (errores!=''){
        errores = 'Debe completar '+errores.substring(0, errores.length - 2)+'.';
        app.dialog.alert(errores);
    }
    else {
        
        $.get('https://maps.googleapis.com/maps/api/geocode/json?address='+direccion+' '+cod_postal+' '+poblacion+'&key=AIzaSyDsv3MEv58JZ42mQIqNyE_Zwpyo361dzhs', 
        function(data) {
            
            var server=servidor+'includes/modificadireccion.php'; 
            $.ajax({
                type: "POST",
                url: server,
                data: { id:id, iddomi:iddomi, alias:alias, direccion:direccion, complementario:complementario, cod_postal:cod_postal, poblacion:poblacion, provincia:provincia, lat:data.results[0].geometry.location.lat, lng:data.results[0].geometry.location.lng}, 
                dataType:"json",
                success: function(data){
                    var obj=Object(data);
                    if (obj.valid==true){  
                        app.popup.close(); 
                        $('.sin-direcciones').hide();
                        //buscadirecciones(id);
                    }
                    else {
                        muestraMensaje('No se pudo guardar domicilio',titulo='',subtitulo='Error');
                    }
                    // buscadirecciones(id);
                    document.getElementById('3-dir-envio').innerHTM=buscadirecciones_compra(id) ; 
                }
            });
                             
               
        });
    }
}



var txt_compra_dom_form=""+
    '<form class="list" id="my-form-domi-compra" style="margin-top:25px;">'+
        '<ul>'+
            '<li>'+
                '<div class="item-content item-input">'+
                    '<div class="item-inner">'+
                        '<div class="item-title item-label">Dirección</div>'+
                        '<div class="item-input-wrap">'+
                            '<input type="text" name="direccion" placeholder="Dirección" value="" required validate/>'+
                        '</div>'+
                    '</div>'+
                '</div>'+
            '</li>'+ 
            '<li>'+
                '<div class="item-content item-input">'+
                    '<div class="item-inner">'+
                        '<div class="item-title item-label">Dirección complementaria</div>'+
                        '<div class="item-input-wrap">'+
                            '<input type="text" name="complementario" placeholder="Dirección complementaria" value=""/>'+
                        '</div>'+
                    '</div>'+
                '</div>'+
            '</li>'+ 
            '<li>'+
                '<div class="item-content item-input">'+
                    '<div class="item-inner">'+
                        '<div class="item-title item-label">Cod. Postal</div>'+
                        '<div class="item-input-wrap">'+
                            '<input type="text" name="cod_postal" placeholder="Cod. Postal" value="" required validate/>'+
                        '</div>'+
                    '</div>'+
                '</div>'+
            '</li>'+ 
            '<li>'+
                '<div class="item-content item-input">'+
                    '<div class="item-inner">'+
                        '<div class="item-title item-label">Población</div>'+
                        '<div class="item-input-wrap">'+
                            '<input type="text" name="poblacion" placeholder="Población" value="" required validate/>'+
                        '</div>'+
                    '</div>'+
                '</div>'+
            '</li>'+
            '<li>'+
                '<div class="item-content item-input">'+
                    '<div class="item-inner">'+
                        '<div class="item-title item-label">Provincia</div>'+
                        '<div class="item-input-wrap">'+
                            '<input type="text" name="provincia" placeholder="Provincia" value="" required validate/>'+
                        '</div>'+
                    '</div>'+
                '</div>'+
            '</li>'+ 
        '</ul>'+
    '</form>'+
    '<div class="text-align-center" style="width:50%;margin:auto;height: 35px;"><a class="button button-fill button-round" href="#" onclick="direcciones_compra_nuevo();">Continuar</a></div>  ';

var txt_compra_form='<form class="list" id="my-form-usu-compra" >'+
    '<p class="block-title" id="titulo-nuevo-usu-compras">Nuevo usuario</p>'+
            '<input type="hidden" name="id" value="NUEVO"/>'+
            '<ul>'+
                '<li>'+
                    '<div class="item-content item-input">'+
                        '<div class="item-inner">'+
                            '<div class="item-title item-label">Tratamiento</div>'+
                            '<div class="item-input-wrap">'+
                                '<p style="margin-top: 10px;margin-bottom: 10px;">Sr.<label class="radio"><input type="radio" name="tratamiento" id="tratamiento-sr" value="1" checked/><i class="icon-radio icon-tratamiento"></i></label> Sra.<label class="radio"><input type="radio" name="tratamiento" value="2" id="tratamiento-sra" /><i class="icon-radio icon-tratamiento"></i></label></p>'+
                            '</div>'+
                        '</div>'+
                    '</div>'+
                '</li>'+
                '<li>'+
                    '<div class="item-content item-input">'+
                        '<div class="item-inner">'+
                            '<div class="item-title item-label">Nombre</div>'+
                            '<div class="item-input-wrap">'+
                                '<input type="text" name="nombre" placeholder="Nombre" required validate/>'+
                            '</div>'+
                        '</div>'+
                    '</div>'+
                '</li>'+
                '<li>'+
                    '<div class="item-content item-input">'+
                        '<div class="item-inner">'+
                            '<div class="item-title item-label">Apellidos</div>'+
                            '<div class="item-input-wrap">'+
                                '<input type="text" name="apellidos" placeholder="Apellidos" required validate/>'+
                            '</div>'+
                        '</div>'+
                    '</div>'+
                '</li>'+
                '<li>'+
                    '<div class="item-content item-input">'+
                        '<div class="item-inner">'+
                            '<div class="item-title item-label">Fecha nacimiento</div>'+
                            '<div class="item-input-wrap">'+
                                '<input type="text" name="nacimiento" id="nacimiento-compras" placeholder="Fecha nacimiento" required validate/>'+
                            '</div>'+
                        '</div>'+
                    '</div>'+
                '</li>'+
                '<li>'+
                    '<div class="item-content item-input">'+
                        '<div class="item-inner">'+
                            '<div class="item-title item-label">Email</div>'+
                            '<div class="item-input-wrap">'+
                                '<input type="email" name="email" placeholder="Email" required validate/>'+
                            '</div>'+
                        '</div>'+
                    '</div>'+
                '</li>'+
                '<li>'+
                    '<div class="item-content item-input">'+
                        '<div class="item-inner">'+
                            '<div class="item-title item-label">Teléfono</div>'+
                            '<div class="item-input-wrap">'+
                                '<input type="tel" name="telefono" placeholder="Teléfono" required validate pattern="[0-9]{9,9}"/>'+
                            '</div>'+
                        '</div>'+
                    '</div>'+
                '</li>'+
            '</ul>'+
            '<p style="font-size:14px;" id="crear-cuenta-nuevo"><b>Crear una cuenta</b> (opcional)<br>'+
            '<span style="font-size:12px;">¡Y ahorre tiempo en su próximo pedido!</span></p>'+
            '<ul>'+
                '<li id="pass-nuevo-usu">'+
                    '<div class="item-content item-input">'+
                        '<div class="item-inner">'+
                            '<div class="item-title item-label">Contraseña</div>'+
                            '<div class="item-input-wrap">'+
                                '<input type="password" name="pass" placeholder="Contraseña" id="campo-clave6"  validate required style="margin-top: -2px;margin-bottom: -25px;"/>'+
                                '<div style="float:right;position: relative;top:-10px;right:10px;;"><i class="f7-icons size-22 campo-clave6" onclick="muestraOcultaClave(\'campo-clave6\');">eye_slash</i></div>'+
                            '</div>'+
                        '</div>'+
                    '</div>'+
                '</li>'+
                '<li>'+
                    '<label class="item-checkbox item-content">'+
                        '<input type="checkbox" name="publi-checkbox" value="1" />'+
                        '<i class="icon icon-checkbox"></i>'+
                        '<div class="item-inner">'+
                            '<div class="item-title" style="font-size:.8em;">Acepto recibir ofertas y publicidad.</div>'+
                        '</div>'+
                    '</label>'+
                '</li>'+
                '<li>'+
                   '<label class="item-checkbox item-content">'+
                        '<input type="checkbox" name="privacidad-checkbox" id="privacidad-checkbox" value="1" />'+
                        '<i class="icon icon-checkbox"></i>'+
                        '<div class="item-inner">'+
                            '<div class="item-title" style="font-size:.8em;">Acepto la <a href="#" class="link" onclick="leePolitica();">Política de privacidad</a>.</div>'+
                        '</div>'+
                    '</label>'+
                '</li>'+
            '</ul>'+
            '<div class="text-align-center" style="width:50%;margin:auto;height: 35px;"><a class="button button-outline button-round" onclick="" id="boton-continuar-nuevo-usuario" href="#"  >Continuar</a></div>' +
        '</form>';



function buscadirecciones_old(id){
    //ver-direccion-usu
    var server=servidor+'includesapp/buscadirecciones.php';  
    app.request.postJSON(server, { id:id, }, 
        function (data) {
            var obj=Object(data);
            if (obj.valid==true){
                var txt="";
                var iddomi=obj.id;
                var linea="";
                var alias=obj.alias;
                var preferida=obj.preferida;
                var direccion=obj.direccion;
                var complementario=obj.complementario;
                var cod_postal=obj.cod_postal;
                var poblacion=obj.poblacion;
                var provincia=obj.provincia;
                var ali='';
                var prefe='';
                var compl='';
                for (x=0;x<alias.length;x++){
                    compl='';
                    prefe='';
                    if (preferida[x]!=0){
                        prefe='checked';
                    }
                    if (alias[x]!=""){
                        ali=alias[x];
                    }
                    else {
                        ali='Mi domicilio '+(x+1);
                    }
                    if (complementario[x]!=null){
                        compl=complementario[x]+'<br>';
                    }
                    else {
                        compl="";
                    }
                    
                    txt+=''+                  
                    '<div class="card">'+
                        '<div class="card-header">'+ali+
                            '<label class="radio float-right"><input type="radio" name="dirpreferida" value="1" '+prefe+' onclick="cambiapreferenciadireccion('+id+','+iddomi[x]+');"/><i class="icon-radio"></i></label> '+
                        '</div>'+
                        '<div class="card-content card-content-padding">'+
                            direccion[x]+'<br>'+
                            compl+
                            cod_postal[x]+' - '+poblacion[x]+'<br>'+
                            '('+provincia[x]+')'+    
                        '</div>'+
                        '<div class="card-footer"><span onclick="editaDomicilio('+id+',this);" data-id="'+id+'"  data-alias="'+alias+'" data-iddomi="'+iddomi[x]+'" data-direccion="'+direccion[x]+'" data-complementario="'+complementario[x]+'" data-cod_postal="'+cod_postal[x]+'" data-poblacion="'+poblacion[x]+'" data-provincia="'+provincia[x]+'"><i class="f7-icons">pencil</i> Editar</span><span onclick="borraDomicilio(this);" data-id="'+id+'" data-idDomi="'+iddomi[x]+'" data-alias="'+ali+'"><i class="f7-icons" >trash</i> Borrar</span></div>'+
                    '</div>';               
                }               
            }
            else {
                txt='<p class="sin-direcciones">Aún no tiene direcciones asociadas.</p>';
            }
            txt+='<div class="sin-direcciones"><button onclick="editaDomicilio('+id+');" class="col-60 button button-fill" style="margin:auto;">+ Añadir dirección</button></div>';
            $('#ver-direccion-usu').html(txt);   
 
        },
        function (xhr, status) {
    });       
}


