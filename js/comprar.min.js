/**
 * Archivo: comprar.min.js
 *
 * Version: 1.1.1
 * Fecha  : 29/01/2024
 *
 * © Manuel Sánchez (www.elmaestroweb.es)
 *
*/

var map,descuento=0,tipo_descuento="",cupon_usado="",monedero_a_usar=0,metodosdepago=[],diasreparto=[],diascocina=[],disponiblereparto=[],disponiblecocina=[],tipo_envio=1,hora_envio="";function terminar(){app.tab.show("#view-checkout"),$(".toolbar-bottom").hide(),$("#boton-menu-principal").hide(),$("#checkout-page").html(""),leemetodospago(),leehorariosreparto(),checkout_1()}function checkout_1(){var e=progresscheckout(1),i=mostrarcarrito(),o="1 art\xedculo";$("#icon-back-checkout").hide(),document.getElementById("link-volver-checkout").href="#",carrito.length>1&&(o=carrito.length+" art\xedculos");var a='<span><b>Total (impuestos inc.)</b><span style="float:right;font-size: 1.3em;"><b>'+carritoSubtotal.toFixed(2)+"€</b></span></span><br><br>";txt_boton1='<button class="button button-fill button-round"  onclick="checkout_2();" id="boton-checkout" style="font-size:.9em;width:80%;margin:auto;height: 35px;" >CONTINUAR</button><br>',txt_botoncancelar='<button class="button button-fill button-round"  onclick="cancelacheckout();" style="font-size:.9em;width:60%;margin:auto;background-color: '+colorsecundario+';" >Volver al carrito</button>',$("#checkout-page").html(e+i+a+txt_boton1+txt_botoncancelar);var t=window.localStorage.getItem("pedido_minimo");if(parseFloat(carritoSubtotal)<parseFloat(t)){muestraMensaje("El importe no llega al m\xednimo ("+t+" €)",titulo="",subtitulo="Importe m\xednimo"),$("#boton-checkout").hide();return}}function checkout_2(){var e=progresscheckout(2);$("#checkout-page").html(e),$("#icon-back-checkout").show(),document.getElementById("link-volver-checkout").href="javascript:checkout_1();";var i='<div id="usuario-compras">';""!=window.localStorage.getItem("username")?(i+="<p>Nombre completo:</p><p><b>"+$('#my-form-usu input[name*="nombre"]').val()+" "+$('#my-form-usu input[name*="apellidos"]').val()+"</b></p><p>Email:</p><p><b>"+desencripta(window.localStorage.getItem("username"))+"</b></p>",i+='<div class="grid grid-cols-2 grid-gap"><div class="button button-raised button-round" onclick="cierrasesioncompra();" style="font-size:11px;height: 35px;"><i class="f7-icons ">power</i>Cerrar sesi\xf3n</div> <div class="button button-fill button-round" onclick="checkout_3();" style="height: 35px;">Continuar</div></div>'):i+=iniciosesioncompra(),i+="</div>";var o='<br><button class="button button-fill color-red button-round"  onclick="cancelacheckout();" style="font-size:.8em;width:60%;margin:auto;background-color: '+colorsecundario+';" >Volver al carrito</button>';if($("#checkout-page").html(e+i+o),""==window.localStorage.getItem("username")){var a=new Date;a.setFullYear(a.getFullYear()-18),calendarNacimientoCompras=app.calendar.create({inputEl:"#nacimiento-compras",value:[a],openIn:"customModal",closeOnSelect:!0,dateFormat:"dd/mm/yyyy"}),"1"==carrito_invitado.tratamiento?$("#tratamiento-sr").attr("checked",!0):$("#tratamiento-sra").attr("checked",!0),$('#my-form-usu-compra input[name*="nombre"]').val(carrito_invitado.nombre),$('#my-form-usu-compra input[name*="apellidos"]').val(carrito_invitado.apellidos),$('#my-form-usu-compra input[name*="nacimiento"]').val(carrito_invitado.fecha_nacimiento),$('#my-form-usu-compra input[name*="telefono"]').val(carrito_invitado.telefono),$('#my-form-usu-compra input[name*="email"]').val(carrito_invitado.email),"1"==carrito_invitado.publicidad&&$('#my-form-usu-compra input[name*="publi-checkbox"]').prop("checked",!0)}}function continuainvitado(e){var i="";i+=txt_compra_form,$("#usuario-compras").html(i),0==e?($("#crear-cuenta-nuevo").hide(),$("#titulo-nuevo-usu-compras").html("Nuevo usuario")):($("#pass-nuevo-usu").hide(),$("#crear-cuenta-nuevo").hide(),$("#titulo-nuevo-usu-compras").html("Invitado")),carrito_domicilio={direccion:"",complementario:"",cod_postal:"",poblacion:"",provincia:"",envio:"0",minimo:"0"},window.localStorage.setItem("registrado",encripta("no")),window.localStorage.setItem("username",""),window.localStorage.setItem("mi_monedero",encripta("0")),window.localStorage.setItem("porcentaje_fidelizacion",encripta("0")),window.localStorage.setItem("user",""),$("#login-inicio").show(),$("#usu-inicio").hide();var o=new Date;o.setFullYear(o.getFullYear()-18),calendarNacimientoCompras=app.calendar.create({inputEl:"#nacimiento-compras",value:[o],openIn:"customModal",closeOnSelect:!0,dateFormat:"dd/mm/yyyy"}),"1"==carrito_invitado.tratamiento?$("#tratamiento-sr").attr("checked",!0):$("#tratamiento-sra").attr("checked",!0),$('#my-form-usu-compra input[name*="nombre"]').val(carrito_invitado.nombre),$('#my-form-usu-compra input[name*="apellidos"]').val(carrito_invitado.apellidos),$('#my-form-usu-compra input[name*="nacimiento"]').val(carrito_invitado.fecha_nacimiento),$('#my-form-usu-compra input[name*="telefono"]').val(carrito_invitado.telefono),$('#my-form-usu-compra input[name*="email"]').val(carrito_invitado.email),"1"==carrito_invitado.publicidad&&$('#my-form-usu-compra input[name*="publi-checkbox"]').prop("checked",!0)}function cierrasesioncompra(){window.localStorage.setItem("registrado",encripta("no")),window.localStorage.setItem("username",""),window.localStorage.setItem("mi_monedero",encripta("0")),window.localStorage.setItem("porcentaje_fidelizacion",encripta("0")),window.localStorage.setItem("user",""),$("#login-inicio").show(),$("#usu-inicio").hide(),checkout_2()}function iniciosesioncompra(){return'<div class="login-screen-content" id="my-login-screen2"><div class="list login-screen-content"><ul><li class="item-content item-input"><div class="item-inner"><div class="item-title item-label">Usuario</div><div class="item-input-wrap"><input type="text" name="username" placeholder="Email"/></div></div></li><li class="item-content item-input"><div class="item-inner"><div class="item-title item-label">Contrase\xf1a</div><div class="item-input-wrap"><input type="password" name="password" id="campo-clave7" placeholder="Contrase\xf1a" style="margin-bottom: -25px;"/><div style="float:right;position: relative;top:-15px;right:10px;;"><i class="f7-icons size-22 campo-clave7" onclick="muestraOcultaClave(\'campo-clave7\');">eye_slash</i></div></div></div></li></ul></div><div class="list" style="margin-top:-15px;"><ul><li><button class="button button-fill button-round" style="width:50%;margin: auto;" onclick="accederdesdecompras();">Acceder</button></li></ul></div><div class="block-footer text-color-red" id="error-login-compras" style="display:none;">Error en usuario y contrase\xf1a</div><div class="block-footer"><a href="javascript:RecuperarClave();">\xbfOlvid\xf3 su contrase\xf1a?</a><br></div><div class="block-footer" style="font-size:18px;">No tengo cuenta, <a href="#" onclick="continuainvitado(0);" class="button button-fill button-round" style="margin:auto;width: 50%;"><b>crearme una.</b></a></div><hr><br><div class="block-footer "><button class="button button-fill button-round" style="width:70%;margin: auto;height: 35px;" onclick="continuainvitado(1);">Continuar como invitado</button></div></div>'}function accederdesdecompras(){var e=$('#my-login-screen2 [name="username"]').val(),i=$('#my-login-screen2 [name="password"]').val(),o=servidor+"includes/login.php";$.ajax({url:o,data:{username:e,password:i},method:"post",dataType:"json",success:function(i){var o=Object(i);if(!0==o.valid){window.localStorage.setItem("registrado",encripta("si)")),window.localStorage.setItem("username",encripta(e)),window.localStorage.setItem("mi_monedero",encripta(o.monedero)),"1"==o.monedero_activo?window.localStorage.setItem("porcentaje_fidelizacion",encripta(o.porcentaje)):window.localStorage.setItem("porcentaje_fidelizacion",encripta("0"));var a=o.id;if($('#my-form-usu input[name*="id"]').val(a),window.localStorage.setItem("user",encripta(a)),$('#my-form-usu input[name*="nombre"]').val(o.nombre),$('#my-form-usu input[name*="apellidos"]').val(o.apellidos),$('#my-form-usu input[name*="nacimiento1"]').val(o.nacimiento),$('#my-form-usu input[name*="tratamiento"][value="'+o.tratamiento+'"]').attr("checked",!0),"1"==o.publicidad&&$('#my-form-usu input[name*="publi-checkbox"]').attr("checked",!0),$('#my-form-usu input[name*="email"]').val(e),$('#my-form-usu input[name*="telefono"]').val(o.telefono),$('#my-form-usu input[name*="pass"]').val(""),$('#my-form-usu input[name*="pass2"]').val(""),calendarNacimiento1=app.calendar.create({inputEl:"#calendar-nacimiento-user",value:[new Date(o.nacimiento.substr(6,4),parseInt(o.nacimiento.substr(3,2))-1,o.nacimiento.substr(0,2))],openIn:"customModal",closeOnSelect:!0,dateFormat:"dd/mm/yyyy"}),!0==isApp){var t=servidor+"includesapp/actualizacion_telefono.php",n=device.manufacturer,r=device.model,s=device.platform,l=device.version,c=window.localStorage.getItem("idtel");app.request.postJSON(t,{idtel:c,plataforma:s,version:l,fabricante:n,modelo:r,user:o.id,push:window.localStorage.getItem("estado_push")},function(e){!0==Object(e).valid&&window.localStorage.setItem("telefono_registrado","si")},function(e,i){})}$("#usu-inicio").show(),$("#login-inicio").hide(),$("#nombre-usu").html(o.nombre),1==fidelizacion&&($("#mi-monedero").show(),$("#importe-mi-monedero").html("<b>"+o.monedero+"</b> €")),mostrarMasDatos(),txt_1="<p>Nombre completo:</p><p><b>"+$('#my-form-usu input[name*="nombre"]').val()+" "+$('#my-form-usu input[name*="apellidos"]').val()+"</b></p><p>Email:</p><p><b>"+desencripta(window.localStorage.getItem("username"))+"</b></p>",txt_1+='<div class="grid grid-cols-2 grid-gap"><div class="button button-raised button-round" onclick="cierrasesioncompra();" style="font-size:11px;height: 35px;"><i class="f7-icons ">power</i>Cerrar sesi\xf3n</div> <div class="button button-fill button-round" onclick="checkout_3();" style="height: 35px;">Continuar</div></div>',$("#usuario-compras").html(txt_1)}else $("#error-login-compras").show()}})}function nuevoUsuCompra(){var e=$("#pass-nuevo-usu").css("display");e="none",l="";var i=app.form.convertToData("#my-form-usu-compra");i.id;var o=i.tratamiento,a=i.nombre,t=i.apellidos,n=i.nacimiento,r=i.email,s=i.telefono,l=i.pass,c=i["publi-checkbox"];c="1"!=c?"0":"1";var d=i["privacidad-checkbox"],p="";if(""==a&&(p+="Nombre, "),""==t&&(p+="Apellidos, "),""==r&&(p+="email, "),""==s&&(p+="Tel\xe9fono, "),""==d&&(p+="aceptar la Pol\xedtica de privacidad, "),"list-item"==e&&""==l&&(p+="Contrase\xf1a, "),""!=p)p="Debe completar "+p.substring(0,p.length-2)+".",app.dialog.alert(p);else if("none"==e&&(l=""),""!=l){var m=servidor+"includes/guardausuario.php";$.ajax({url:m,data:{nombre:a,apellidos:t,telefono:s,usuario:r,pass:l,publi:parseInt(c),tratamiento:o,nacimiento:n},method:"post",dataType:"json",success:function(e){var i=Object(e);if(!0==i.valid){if(window.localStorage.setItem("registrado",encripta("si")),window.localStorage.setItem("username",encripta(r)),window.localStorage.setItem("user",encripta(i.id)),$("#usu-nuevo").hide(),$("#login-inicio").hide(),$("#usu-inicio").show(),$('#my-form-usu input[name*="id"]').val(i.id),$('#my-form-usu input[name*="nombre"]').val(a),$('#my-form-usu input[name*="apellidos"]').val(t),$('#my-form-usu input[name*="telefono"]').val(s),$('#my-form-usu input[name*="tratamiento"][value="'+i.tratamiento+'"]').attr("checked",!0),"1"==c&&$('#my-form-usu input[name*="publi-checkbox"]').attr("checked",!0),$('#my-form-usu input[name*="email"]').val(r),$('#my-form-usu input[name*="pass"]').val(""),$('#my-form-usu input[name*="pass2"]').val(""),enviaemail("nuevo",r),!0==isApp){var o=servidor+"includesapp/actualizacion_telefono.php",n=device.manufacturer,l=device.model,d=device.platform,p=device.version,m=window.localStorage.getItem("idtel");app.request.postJSON(o,{idtel:m,plataforma:d,version:p,fabricante:n,modelo:l,user:i.id,push:window.localStorage.getItem("estado_push")},function(e){!0==Object(e).valid&&window.localStorage.setItem("telefono_registrado","si")},function(e,i){})}$("#usu-inicio").show(),$("#nombre-usu").html(a),mostrarMasDatos(),checkout_3()}else!0==i.existe?muestraMensaje("Ya existe usuario con ese email.",titulo="",subtitulo="Error"):muestraMensaje("No se pudo crear usuario.",titulo="",subtitulo="Error")},error:function(e,i,o){console.log(e.status),console.log(o)}})}else carrito_invitado={tratamiento:o,nombre:a,apellidos:t,fecha_nacimiento:n,telefono:s,email:r,publicidad:c},checkout_3(),miLocalStorage.setItem("carrito_invitado",JSON.stringify(carrito_invitado))}function checkout_3(){$("#icon-back-checkout").show(),document.getElementById("link-volver-checkout").href="javascript:checkout_2();",window.localStorage.getItem("username");var e,i,o=progresscheckout(3),a=parseInt(tiempoenvio),t=new Date;t.setMinutes(t.getMinutes()+a);var n=t.getDay(),r=new Date,s=t.getTime();1==n&&(e=diasreparto.lunes),2==n&&(e=diasreparto.martes),3==n&&(e=diasreparto.miercoles),4==n&&(e=diasreparto.jueves),5==n&&(e=diasreparto.viernes),6==n&&(e=diasreparto.sabado),0==n&&(e=diasreparto.domingo),1==n&&(i=diascocina.lunes),2==n&&(i=diascocina.martes),3==n&&(i=diascocina.miercoles),4==n&&(i=diascocina.jueves),5==n&&(i=diascocina.viernes),6==n&&(i=diascocina.sabado),0==n&&(i=diascocina.domingo),disponiblereparto=[];var l=0;disponiblecocina=[];var c=0;for(x=0;x<e.length;x++){var d=e[x].split(":");r.setHours(parseInt(d[0])),r.setMinutes(parseInt(d[1]));var p=r.getTime();s<=p&&(disponiblereparto[l]=e[x],l++)}for(x=0;x<i.length;x++){var d=i[x].split(":");r.setHours(parseInt(d[0])),r.setMinutes(parseInt(d[1]));var p=r.getTime();s<=p&&(disponiblecocina[c]=i[x],c++)}var m="",u=!1,v=!1,b=servidor+"includes/mirapedidoshoy.php";$.ajax({url:b,data:{horario:disponiblereparto,horariococina:disponiblecocina},method:"post",dataType:"json",success:function(e){var i=Object(e);if(!0==i.valid){disponiblereparto=i.horario;var a="",t="",n="",r="";if(null!=(disponiblecocina=i.horariococina))for(x=0,v=!0;x<disponiblecocina.length;x++)0==x&&(m=" checked"),cortesia>0&&(a=parseInt(disponiblecocina[x].substr(0,2)),t=parseInt(disponiblecocina[x].substr(3,2)),(t+=cortesia)>=60&&(t-=cortesia,a+=1),a>=24&&(a=0),t<=9&&(t="0"+t),a<=9&&(a="0"+a),n="-"+a+":"+t),r+='<option value="'+disponiblecocina[x]+'" '+m+">"+disponiblecocina[x]+n+"</option>";else v=!1;var s="";if(n="",null!=disponiblereparto)for(x=0,u=!0;x<disponiblereparto.length;x++)cortesia>0&&(a=parseInt(disponiblereparto[x].substr(0,2)),t=parseInt(disponiblereparto[x].substr(3,2)),(t+=cortesia)>=60&&(t-=cortesia,a+=1),a>=24&&(a=0),t<=9&&(t="0"+t),a<=9&&(a="0"+a),n="-"+a+":"+t),s+='<option value="'+disponiblereparto[x]+'">'+disponiblereparto[x]+n+"</option>";else u=!1;o+='<div id="metodo-de-envio"><p>Seleccione opci\xf3n de env\xedo:</p>';var l="";v&&0!=disponiblecocina.length&&(o+='<p><label class="radio"><input type="radio" onclick="cambiametodoenvio();" name="metodo_envio" value="2" checked/><i class="icon-radio"></i></label> Recogida en local</p>'),u&&0!=disponiblereparto.length&&(v||(l="checked"),o+='<p><label class="radio"><input type="radio" onclick="cambiametodoenvio();" name="metodo_envio" value="1" /><i class="icon-radio" '+l+"></i></label> Entrega en mi domicilio</p>"),o+='<div class="text-color-primary" style="font-size:16px;" id="horas-entrega"></div><br><div class="row"><button id="compra-paso-2"  onclick="eligedomicilio();" class="col-60 button button-fill button-round" style="margin:auto;height: 35px;width: 60%;">Continuar</button></div></div>',$("#checkout-page").html(o);var c='Seleccione hora de recogida: <i class="f7-icons size-22">hand_point_right_fill</i> <span style="display: inline-block;"><select id="hora-reparto" style="height:20px;font-size:16px;">'+r+" </select></span>";v||u||(muestraMensaje(norepartomensaje,titulo="",subtitulo="Horario reparto"),checkout_2()),u||v?u&&!v&&(c='Seleccione hora de reparto: <i class="f7-icons size-22">hand_point_right_fill</i> <span style="display: inline-block;"><select id="hora-reparto" style="height:20px;font-size:16px;">'+s+"</select></span>",$('input:radio[name="metodo_envio"]').filter('[value="1"]').attr("checked",!0)):muestraMensaje(norepartomensaje,titulo="",subtitulo="Horario reparto"),$("#horas-entrega").html(c)}else muestraMensaje("Error leyendo horarios",titulo="",subtitulo="Horarios"),checkout_2()},error:function(e,i,o){console.log(e.status),console.log(o)}})}function eligedomicilio(){$("#compra-paso-2").hide();var e=$("#checkout-page").html();miLocalStorage.getItem("status"),tipo_envio=1,$('#metodo-de-envio [name="metodo_envio"]:checked').each(function(){tipo_envio=$(this).val()});var i="<b>Entrega en domicilio</b>";2==tipo_envio&&(i="<b>A recoger</b>");var o=i+"<br>Hora:<b>"+(hora_envio=$("#hora-reparto").val())+"</b>";1==tipo_envio?""!=window.localStorage.getItem("username")?(console.log("usuario:"+desencripta(window.localStorage.getItem("user"))),buscadirecciones_compra(desencripta(window.localStorage.getItem("user")))):(e=e+o+txt_compra_dom_form,$("#checkout-page").html(e)):(carrito_domicilio.envio="0",miLocalStorage.setItem("carrito_domicilio",JSON.stringify(carrito_domicilio)),checkout_4()),$("#metodo-de-envio").hide()}function direcciones_compra_nuevo(){var e=app.form.convertToData("#my-form-domi-compra"),i=e.direccion,o=e.complementario,a=e.cod_postal,t=e.poblacion,n=e.provincia,r="";""==i&&(r+="Direcci\xf3n, "),""==a&&(r+="C\xf3digo Postal, "),""==t&&(r+="Poblaci\xf3n, "),""==n&&(r+="Provincia, "),""!=r?(r="Debe completar "+r.substring(0,r.length-2)+".",app.dialog.alert(r)):(carrito_domicilio.direccion=i,carrito_domicilio.complementario=o,carrito_domicilio.cod_postal=a,carrito_domicilio.poblacion=t,carrito_domicilio.provincia=n,$.get("https://maps.googleapis.com/maps/api/geocode/json?address="+i+" "+a+" "+t+"&key=AIzaSyDsv3MEv58JZ42mQIqNyE_Zwpyo361dzhs",function(e){var r=e.results[0].geometry.location.lat,s=e.results[0].geometry.location.lng,l=servidor+"includes/leezonasreparto.php";$.ajax({type:"POST",url:l,data:{foo:"foo"},dataType:"json",success:function(e){var l=Object(e);if(!0==l.valid){l.nombre;var c=l.precio,d=l.minimo,p=l.reparto,m=l.zonas,u=new google.maps.LatLng(parseFloat(r),parseFloat(s)),v="no",b="no",h=0,g=0;for(x=0;x<m.length;x++){for(j=0;j<m[x].length;j++)m[x][j]={lat:parseFloat(m[x][j].lat),lng:parseFloat(m[x][j].lng)};var f=new google.maps.Polygon({paths:m[x],map:map});google.maps.geometry.poly.containsLocation(u,f)&&(v="si",h=c[x],g=d[x],"0"==p[x]&&(b="si"))}if("si"==v&&"no"==b)carrito_domicilio.direccion=i,carrito_domicilio.complementario=o,carrito_domicilio.cod_postal=a,carrito_domicilio.poblacion=t,carrito_domicilio.provincia=n,carrito_domicilio.envio=h,carrito_domicilio.minimo=g,miLocalStorage.setItem("carrito_domicilio",JSON.stringify(carrito_domicilio)),checkout_4();else{muestraMensaje("El domicilio introducido NO est\xe1 en nuestra zona de reparto.",titulo="",subtitulo="Error domicilio");return}}}})}),miLocalStorage.setItem("carrito_domicilio",JSON.stringify(carrito_domicilio)))}function buscadirecciones_compra(e){var i=servidor+"includes/buscadirecciones.php";$.ajax({type:"POST",url:i,data:{id:e},dataType:"json",success:function(i){var o=Object(i);if(!0==o.valid){var a="",t=o.id,n=o.alias,r=o.preferida,s=o.direccion,l=o.complementario,c=o.cod_postal,d=o.poblacion,p=o.provincia,m="",u="",v="";for(x=0;x<n.length;x++)u="",v="",r[x],m=""!=n[x]?n[x]:"Mi domicilio "+(x+1),u=null!=l[x]?l[x]+"<br>":"",a+='<div class="card card-outline card-dividers" style="width: 90%;"><div class="card-header">'+m+v+'</div><div class="card-content card-content-padding">'+s[x]+"<br>"+u+c[x]+" - "+d[x]+"<br>("+p[x]+")</div></div>",a+='<div class=""><button onclick="seleccionardomicilio('+t[x]+');" class="button button-fill button-round" style="margin:auto;width: 60%;">Seleccionar</button></div>'}else a="<p class='text-color-red sin-direcciones'>A\xfan no tiene direcciones asociadas.</p>";a+='<br><div class="sin-direcciones"><button onclick="editaDomicilioCompra('+e+');" class="col-60 button button-fill button-round" style="margin:auto;width: 70%;">+ A\xf1adir direcci\xf3n</button></div>';var b="<b>Entrega en domicilio</b>";2==tipo_envio&&(b="<b>A recoger</b>");var h=b+"<br>Hora:<b>"+(hora_envio=$("#hora-reparto").val())+"</b>";$("#checkout-page").html($("#checkout-page").html()+h+a)},error:function(e,i,o){console.log(e.status),console.log(o)}})}function seleccionardomicilio(e){var i=servidor+"includes/buscadirecciones2.php";$.ajax({type:"POST",url:i,data:{id:e},dataType:"json",success:function(i){var o=Object(i);if(!0==o.valid){var a=o.direccion,t=o.complementario,n=o.cod_postal,r=o.poblacion,s=o.provincia,l=o.lat,c=o.lng,d=servidor+"includes/leezonasreparto.php";$.ajax({type:"POST",url:d,data:{id:e},dataType:"json",success:function(e){var i=Object(e);if(!0==i.valid){i.nombre;var o=i.precio,d=i.minimo,p=i.reparto,m=i.zonas,u=new google.maps.LatLng(parseFloat(l),parseFloat(c)),v="no",b="no",h=0,g=0;for(x=0;x<m.length;x++){for(j=0;j<m[x].length;j++)m[x][j]={lat:parseFloat(m[x][j].lat),lng:parseFloat(m[x][j].lng)};var f=new google.maps.Polygon({paths:m[x],map:map});google.maps.geometry.poly.containsLocation(u,f)&&(v="si",h=o[x],g=d[x],"0"==p[x]&&(b="si"))}"si"==v&&"no"==b?(carrito_domicilio.direccion=a,carrito_domicilio.complementario=t,carrito_domicilio.cod_postal=n,carrito_domicilio.poblacion=r,carrito_domicilio.provincia=s,carrito_domicilio.envio=h,carrito_domicilio.minimo=g,miLocalStorage.setItem("carrito_domicilio",JSON.stringify(carrito_domicilio)),checkout_4()):muestraMensaje("El domicilio seleccionado NO est\xe1 en nuestra zona de reparto",titulo="",subtitulo="Error")}},error:function(e,i,o){console.log(e.status),console.log(o)}})}},error:function(e,i,o){console.log(e.status),console.log(o)}})}function checkout_4(){1==tipo_envio&&1==portesgratis&&1==portesgratismensaje&&(carritoSubtotal>=importeportesgratis?(carrito_domicilio.envio="0",muestraMensaje("\xa1El env\xedo te sale gratis!",titulo="",subtitulo="Env\xedo gratis","",3e3)):muestraMensaje("Te falta <b>"+(importeportesgratis-carritoSubtotal).toFixed(2)+"</b>€ para env\xedo gratis.",titulo="",subtitulo="\xbfQuieres env\xedo gratis?","",6e3));var e="<b>Entrega en domicilio</b>";2==tipo_envio&&(e="<b>A recoger</b>");var i=e+"<br>Hora:<b>"+hora_envio+"</b><br>";$("#icon-back-checkout").show(),document.getElementById("link-volver-checkout").href="javascript:checkout_3();",window.localStorage.getItem("username");var o=progresscheckout(4);monedero_a_usar=0;var a=ponetotales(),t='<p>\xbfDesea comentarnos algo?<span id="caracteres" style="float:right;"></span></p><div class="list inline-labels" style="margin:0;margin-bottom: -15px;"><ul><li class="item-content item-input" style="padding-left: 0;"><div class="item-inner"><div class="item-input-wrap"><textarea id="comentario" onkeyup="evaluatextomsg();" class="resizable" placeholder="Escriba un comentario"></textarea></div></div></li></ul></div><br>',n="lightgray";1==modooscuro&&(n="white"),t+='<div class="" id="div-codigopromocion" style="display: flex;"><div class="" style="width: 60%;" ><input type="text" id="codigopromocion" placeholder="C\xd3DIGO PROMOCI\xd3N" style="border: solid 1px '+colorprimario+";background-color: "+n+';border-radius: 30px;margin-right: 10px;margin-bottom: 10px;padding-left: 15px;font-size: 12px;height: 30px;width: 90%;" ></div><div class="button button-fill button-round" onclick="tengocupon();" style="width: 40%;">Aplicar</div></div><div id="metodo-de-pago"><p>Seleccione m\xe9todo de pago:</p>';var r="efectivo",s="";if(1==fidelizacion){var l=desencripta(window.localStorage.getItem("mi_monedero"));desencripta(window.localStorage.getItem("porcentaje_fidelizacion")),parseFloat(l)>0&&(parseFloat(l)>carritoSubtotal+parseFloat(carrito_domicilio.envio)-descuento&&(l=carritoSubtotal+parseFloat(carrito_domicilio.envio)-descuento),t+='<p style="display: flex;"><label class="checkbox"><input type="checkbox" onclick="cambiausomonedero(this);" id="monedero" /><i class="icon-checkbox"></i></label>&nbsp;&nbsp;<i class="f7-icons">giftcard</i>&nbsp;&nbsp;usar <b><span id="valor-monedero-usar">'+parseFloat(l).toFixed(2)+"</span>€ </b>de mi tarjeta regalo</p>")}for(x=0;x<metodosdepago.length;x++)1==metodosdepago[x].id?(r='&nbsp;&nbsp;<img src="img/cash.png" width="24px" height="auto"  align="absmiddle">&nbsp;&nbsp;',1==modooscuro&&(r='&nbsp;&nbsp;<img src="img/cash_white.png" width="24px" height="auto"  align="absmiddle">&nbsp;&nbsp;'),s="checked"):(r='&nbsp;&nbsp;<i class="f7-icons">creditcard</i>&nbsp;&nbsp;',s="checked"),t+='<p style="display: flex;"><label class="radio"><input type="radio" name="metodo_pago" id="metodo_pago" value="'+metodosdepago[x].idrevo+'" '+s+' onclick="cambiametodopago(this)";/><i class="icon-radio"></i></label> '+r+"  "+metodosdepago[x].nombre+"</p>";t+='<div id="div-tarjeta" style="display:none;"></div>',t+='<div class="list" style="margin: 0;margin-left: -15px;"><ul><li id="id-politicas" ><label class="item-checkbox item-content"><input type="checkbox" name="condiciones-checkbox" value="1" /><i class="icon icon-checkbox" style="border-radius:0;"></i><div class="item-inner"><div class="item-title" style="font-size:.7em;">Acepto los <a href="#" class="link" onclick="leetexto(\'T\xe9rminos de servicio\',\'terminos.txt\')">T\xe9rminos y condiciones</a>.</div></div></label></li></ul></div>',t+='<br><div class="row"><button onclick="comprapaso5();" class="col-60 button  button-round button-outline" style="margin:auto;height: 35px; width: 80%;" id="comprar-paso5" disabled >Continuar</button></div></div>';var c='<br><button class="button button-fill color-red button-round"  onclick="cancelacheckout();" style="font-size:.8em;width:60%;margin:auto;background-color: '+colorsecundario+';" >Volver al carrito</button>';$("#checkout-page").html(o+i+'<div id="cart-final">'+a+"</div>"+t+c),$('#id-politicas input[name*="condiciones-checkbox"]').on("click",function(){!0==$('#id-politicas input[name*="condiciones-checkbox"]').prop("checked")?($("#comprar-paso5").prop("disabled",!1),$("#comprar-paso5").addClass("button-fill")):($("#comprar-paso5").removeClass("button-fill"),$("#comprar-paso5").prop("disabled",!0))})}function trunc(e,i=0){var o=e.toString();o.length;var a=o.indexOf(".")+1;return Number(o.substr(0,a+i))}function ponetotales(){descuento=trunc(descuento,2);var e="1 art\xedculo";carrito.length>1&&(e=carrito.length+" art\xedculos");var i="",o="";if(descuento>0&&(i='<span class="text-color-red">Descuento<span style="float:right;">-'+descuento.toFixed(2)+"€</span></span><br>"),monedero_a_usar>0){var a=carritoSubtotal-descuento+parseFloat(carrito_domicilio.envio);monedero_a_usar>a&&(monedero_a_usar=a,console.log("cambio valor"),$("#valor-monedero-usar").html(monedero_a_usar.toFixed(2))),o='<span class="text-color-red">Fidelizaci\xf3n<span style="float:right;">-'+monedero_a_usar.toFixed(2)+"€</span></span><br>"}return"<span>"+(e+=' <span onclick="muestraocultacarrito();" id="detalles-carrito" >(<span class="text-color-primary">mostrar detalles <i class="f7-icons" style="font-size:14px;">chevron_down</i></span>)</span>')+'<span style="float:right;">'+carritoSubtotal.toFixed(2)+'€</span></span><span style="display:none;" id="carrito-oculto"><br><br>'+mostrarcarrito()+'</span><br><span>Gastos envio <span style="float:right;">'+parseFloat(carrito_domicilio.envio).toFixed(2)+"€</span></span><br>"+i+o+'<span><b>Total (impuestos inc.)</b><span style="float:right;"><b>'+(carritoSubtotal+parseFloat(carrito_domicilio.envio)-descuento-monedero_a_usar).toFixed(2)+"€</b></span></span>"}function progresscheckout(e){var i='<div class="breadcrumbs checkout" style="font-size: calc(.5em + 1vw);">',o='<div class="breadcrumbs-separator"></div>',a='<div class="breadcrumbs-item"><i class="icon material-icons">shopping_cart</i><span>Carrito</span></div>',t='<div class="breadcrumbs-item"><i class="icon f7-icons">person_fill</i><span>Usuario</span></div>',n='<div class="breadcrumbs-item"><i class="icon material-icons">delivery_dining</i><span>Env\xedo</span></div>',r='<div class="breadcrumbs-item"><i class="icon f7-icons">creditcard</i><span>Pago</span></div>';return 1==e&&(a='<div class="breadcrumbs-item" style="color:'+colorprimario+';"><i class="icon material-icons">shopping_cart</i><span>Carrito</span></div>'),2==e&&(a='<div class="breadcrumbs-item" style="color:'+colorprimario+';"><a href="javascript:checkout_1();" class="link"><i class="icon material-icons">shopping_cart</i><span>Carrito</span></a></div>',t='<div class="breadcrumbs-item" style="color:'+colorprimario+';"><i class="icon f7-icons">person_fill</i><span>Usuario</span></div>'),3==e&&(a='<div class="breadcrumbs-item" style="color:'+colorprimario+';"><a href="javascript:checkout_1();" class="link"><i class="icon material-icons">shopping_cart</i><span>Carrito</span></a></div>',t='<div class="breadcrumbs-item" style="color:'+colorprimario+';"><a href="javascript:checkout_2();" class="link"><i class="icon f7-icons">person_fill</i><span>Usuario</span></a></div>',n='<div class="breadcrumbs-item" style="color:'+colorprimario+';"><i class="icon material-icons">delivery_dining</i><span>Env\xedo</span></div>'),4==e&&(a='<div class="breadcrumbs-item" style="color:'+colorprimario+';"><a href="javascript:checkout_1();" class="link"><i class="icon material-icons">shopping_cart</i><span>Carrito</span></a></div>',t='<div class="breadcrumbs-item" style="color:'+colorprimario+';"><a href="javascript:checkout_2();" class="link"><i class="icon f7-icons">person_fill</i><span>Usuario</span></a></div>',n='<div class="breadcrumbs-item" style="color:'+colorprimario+';"><a href="javascript:checkout_3();" class="link"><i class="icon material-icons">delivery_dining</i><span>Env\xedo</span></a></div>',r='<div class="breadcrumbs-item" style="color:'+colorprimario+';"><i class="icon f7-icons">creditcard</i><span>Pago</span></div>'),i=i+a+o+t+o+n+o+r+"</div><br>"}function cancelacheckout(){app.tab.show("#view-carrito"),$(".toolbar-bottom").show(),$("#boton-menu-principal").show(),$("#checkout-page").html(""),$("#icon-back-checkout").hide(),document.getElementById("link-volver-checkout").href="#"}function cambiametodoenvio(){var e=1;$('#metodo-de-envio [name="metodo_envio"]:checked').each(function(){1==(e=$(this).val())&&parseFloat(carritoSubtotal)<parseFloat(pedidominimo)&&(app.dialog.alert("Su pedido no llega al m\xednimo para env\xedo: "+pedidominimo+"€","Atenci\xf3n"),checkout_1())});var i="",o=" de reparto ",a="",t="";if("1"==e){0==disponiblereparto.length?(muestraMensaje("No tenemos horario para hoy",titulo="",subtitulo="Horario reparto"),$("#compra-paso-2").prop("disabled",!0)):$("#compra-paso-2").prop("disabled",!1);var n="";for(x=0;x<disponiblereparto.length;x++)cortesia>0&&(a=parseInt(disponiblereparto[x].substr(0,2)),t=parseInt(disponiblereparto[x].substr(3,2)),(t+=cortesia)>=60&&(t-=cortesia,a+=1),a>=24&&(a=0),t<=9&&(t="0"+t),a<=9&&(a="0"+a),n="-"+a+":"+t),i+='<option value="'+disponiblereparto[x]+'">'+disponiblereparto[x]+n+"</option>"}else{o="de recogida",carrito_domicilio.envio=0;var r=ponetotales();$("#buy-cart").html(r),0==disponiblecocina.length?(muestraMensaje("No tenemos horario para hoy",titulo="",subtitulo="Horario recogida"),$("#compra-paso-2").prop("disabled",!0)):$("#compra-paso-2").prop("disabled",!1);var n="";for(x=0;x<disponiblecocina.length;x++)cortesia>0&&(a=parseInt(disponiblecocina[x].substr(0,2)),t=parseInt(disponiblecocina[x].substr(3,2)),(t+=cortesia)>=60&&(t-=cortesia,a+=1),a>=24&&(a=0),t<=9&&(t="0"+t),a<=9&&(a="0"+a),n="-"+a+":"+t),i+='<option value="'+disponiblecocina[x]+'">'+disponiblecocina[x]+n+"</option>"}var s="Seleccione hora "+o+': <i class="f7-icons size-22">hand_point_right_fill</i> <span style="display: inline-block;"><select id="hora-reparto" style="height:20px;font-size:16px;">'+i+"</select></span>";$("#horas-entrega").html(s)}function leemetodospago(){var e=servidor+"includes/leemetodospago.php";$.ajax({url:e,data:{id:"",isapp:isApp},method:"post",dataType:"json",success:function(e){var i=Object(e);if(!0==i.valid){var o=i.id,a=i.nombre,t=i.activo,n=i.idrevo,r=0;for(x=0;x<a.length;x++)"1"==t[x]&&(metodosdepago[r]={id:o[x],nombre:a[x],idrevo:n[x]},r++)}else muestraMensaje("Error leyendo m\xe9todos de pago",titulo="",subtitulo="Error")}})}function leehorariosreparto(){var e=servidor+"includes/leehorariosreparto.php";$.ajax({url:e,data:{id:"",isapp:isApp},method:"post",dataType:"json",success:function(e){var i=Object(e);if(!0==i.valid){var o=parseInt(i.intervalo),a=i.lunes,t=i.martes,n=i.miercoles,r=i.jueves,s=i.viernes,l=i.sabado,c=i.domingo,d=i.ld1,p=i.lh1,m=i.ld2,u=i.lh2,v=i.md1,b=i.mh1,h=i.md2,g=i.mh2,f=i.xd1,k=i.xh1,_=i.xd2,w=i.xh2,I=i.jd1,T=i.jh1,S=i.jd2,E=i.jh2,z=i.vd1,C=i.vh1,P=i.vd2,F=i.vh2,D=i.sd1,M=i.sh1,O=i.sd2,N=i.sh2,A=i.dd1,H=i.dh1,q=i.dd2,B=i.dh2,L=i.lp,U=i.mp,R=i.xp,Y=i.jp,J=i.vp,V=i.sp,G=i.dp;"0"!=a?diasreparto.lunes=llenahoras(L,d,p,m,u,o):diasreparto.lunes=[],"0"!=t?diasreparto.martes=llenahoras(U,v,b,h,g,o):diasreparto.martes=[],"0"!=n?diasreparto.miercoles=llenahoras(R,f,k,_,w,o):diasreparto.miercoles=[],"0"!=r?diasreparto.jueves=llenahoras(Y,I,T,S,E,o):diasreparto.jueves=[],"0"!=s?diasreparto.viernes=llenahoras(J,z,C,P,F,o):diasreparto.viernes=[],"0"!=l?diasreparto.sabado=llenahoras(V,D,M,O,N,o):diasreparto.sabado=[],"0"!=c?diasreparto.domingo=llenahoras(G,A,H,q,B,o):diasreparto.domingo=[]}else muestraMensaje("Error leyendo horario de reparto",titulo="",subtitulo="Error")},error:function(e,i,o){console.log(e.status),console.log(o)}});var e=servidor+"includes/leehorarioscocina.php";$.ajax({url:e,data:{id:"",isapp:isApp},method:"post",dataType:"json",success:function(e){var i=Object(e);if(!0==i.valid){var o=parseInt(i.intervalo),a=i.lunes,t=i.martes,n=i.miercoles,r=i.jueves,s=i.viernes,l=i.sabado,c=i.domingo,d=i.ld1,p=i.lh1,m=i.ld2,u=i.lh2,v=i.md1,b=i.mh1,h=i.md2,g=i.mh2,f=i.xd1,k=i.xh1,_=i.xd2,w=i.xh2,I=i.jd1,T=i.jh1,S=i.jd2,E=i.jh2,z=i.vd1,C=i.vh1,P=i.vd2,F=i.vh2,D=i.sd1,M=i.sh1,O=i.sd2,N=i.sh2,A=i.dd1,H=i.dh1,q=i.dd2,B=i.dh2,L=i.lp,U=i.mp,R=i.xp,Y=i.jp,J=i.vp,V=i.sp,G=i.dp;"0"!=a?diascocina.lunes=llenahoras(L,d,p,m,u,o):diascocina.lunes=[],"0"!=t?diascocina.martes=llenahoras(U,v,b,h,g,o):diascocina.martes=[],"0"!=n?diascocina.miercoles=llenahoras(R,f,k,_,w,o):diascocina.miercoles=[],"0"!=r?diascocina.jueves=llenahoras(Y,I,T,S,E,o):diascocina.jueves=[],"0"!=s?diascocina.viernes=llenahoras(J,z,C,P,F,o):diascocina.viernes=[],"0"!=l?diascocina.sabado=llenahoras(V,D,M,O,N,o):diascocina.sabado=[],"0"!=c?diascocina.domingo=llenahoras(G,A,H,q,B,o):diascocina.domingo=[]}else muestraMensaje("Error leyendo horario de regogidas",titulo="",subtitulo="Error")},error:function(e,i,o){console.log(e.status),console.log(o)}})}function llenahoras(e,i,o,a,t,n){var r=[],s=new Date,l=new Date,c=6e4*n;"00:00:00"==o&&(o="23:59:59"),"00:00:00"==t&&(t="23:59:59"),s.setHours(parseInt(i.substr(0,2))),s.setMinutes(parseInt(i.substr(3,2))),l.setHours(parseInt(o.substr(0,2))),l.setMinutes(parseInt(o.substr(3,2)));for(var d=0;s<=l;)r[d]=s.toTimeString().substr(0,5),d++,s=new Date(s.getTime()+c);if("0"!=e)for(s.setHours(parseInt(a.substr(0,2))),s.setMinutes(parseInt(a.substr(3,2))),l.setHours(parseInt(t.substr(0,2))),l.setMinutes(parseInt(t.substr(3,2)));s<=l;)r[d]=s.toTimeString().substr(0,5),d++,s=new Date(s.getTime()+c);return r}function cancelarcompra(){app.dialog.create({text:"\xbfCancelar el proceso de compra?",buttons:[{text:"Si, cancelar",color:"red",onClick:function(){carrito_domicilio.direccion="",carrito_domicilio.complementario="",carrito_domicilio.cod_postal="",carrito_domicilio.poblacion="",carrito_domicilio.provincia="",carrito_domicilio.envio="0",carrito_domicilio.minimo="0",descuento=0,cupon_usado=0,monedero_a_usar=0,tipo_descuento="",$(".subnavbar").show(),$("#search").show(),muestragrupos()}},{text:"No, seguir"},],verticalButtons:!0}).open()}function mostrarcarrito(){for(var e="",i=0;i<carrito.length;i++){var o="";if(null!=carrito[i].modificadores){var a=carrito[i].modificadores;if(a.length>0){for(y=0;y<a.length;y++)o+=a[y].nombre+", ";o=o.slice(0,-2)}}if(0==carrito[i].menu)e+='<hr>  <div style="align-items: center;display: flex;"><div class="col-35" style="width:35%;"><img src="'+carrito[i].img+'" width="80px" height="auto"></div><div class="col-65 text-aling-left" style="width:65%;">'+carrito[i].nombre+'<br><span style="font-size:.7em;">'+o+'</span><br><div style="text-align: right;"><span style="font-size:.9em;">'+carrito[i].cantidad+' x </span><span class="text-color-primary" style="font-size:1.2em;">'+carrito[i].precio+'€</span><br><span class="text-color-primary" style="font-size:.8em;font-style: italic;float:left;">'+carrito[i].comentario+"</span></div></div></div>";else{e+='<hr>  <div style="align-items: center;display: flex;"><div class="col-35" style="width:35%;"><img src="'+carrito[i].img+'" width="80px" height="auto"></div><div class="col-65 text-aling-left" style="width:65%;">'+carrito[i].nombre+'<br><span style="font-size:.7em;">'+o+'</span><br><div style="text-align: right;"><span style="font-size:.9em;">'+carrito[i].cantidad+' x </span><span class="text-color-primary" style="font-size:1.2em;">'+carrito[i].precio+'€</span><br><span class="text-color-primary" style="font-size:.8em;font-style: italic;float:left;">'+carrito[i].comentario+"</span></div></div></div>";var t=carrito[i].elmentosMenu;for(j=0;j<t.length;j++)e+='<div style="align-items: center;display: flex;"><div class="col-35 " style="width:35%;"><img src="'+t[j].img+'" width="60px" height="auto"></div><div class="col-65 text-aling-left" style="width:35%;"><span style="font-size:.9em;">'+t[j].nombre+'</span><br><div style="text-align: right;"><span style="font-size:.9em;">'+t[j].cantidad+' x </span><span class="text-color-primary" style="font-size:1.2em;">'+t[j].precio+"€</span></div></div></div>"}}return e+"<hr>"}function muestraocultacarrito(){"none"==$("#carrito-oculto").css("display")||"hidden"==$("#carrito-oculto").css("visibility")?($("#carrito-oculto").show(),$("#detalles-carrito").html('(<span class="text-color-primary">ocultar detalles <i class="f7-icons" style="font-size:14px;">chevron_up</i></span>)')):($("#carrito-oculto").hide(),$("#detalles-carrito").html('(<span class="text-color-primary">mostrar detalles <i class="f7-icons" style="font-size:14px;">chevron_down</i></span>)'))}function tengocupon(){if(""!=$("#codigopromocion").val()){var e=desencripta(localStorage.getItem("user"));miLocalStorage.setItem("cupon",""),miLocalStorage.setItem("idcupon","0");var i=servidor+"includes/buscapromo.php";$.ajax({type:"POST",url:i,data:{codigo:$("#codigopromocion").val(),usuario:e},dataType:"json",success:function(e){var i=Object(e);if(!0==i.valid){i.logica;var o=i.desde,a=i.hasta,t=i.tipo;i.nombre,i.codigo;var n=i.activo,r=i.id,s=i.logica;i.producto;var l=i.envio_recoger;i.usuario;var c=i.usupermitido;i.grupo;var d=i.maximo,p=i.emitidos,m=i.valido,u=i.motivo,v=new Date,b=new Date,h=new Date;if(carritoSubtotal,miLocalStorage.setItem("idcupon",encripta(r)),1==r||2==r){if("no"==m){muestraMensaje(u,titulo="",subtitulo="Error");return}}else{if(b.setFullYear(parseInt(o.substr(0,4))),h.setFullYear(parseInt(a.substr(0,4))),b.setMonth(parseInt(o.substr(5,2))-1),h.setMonth(parseInt(a.substr(5,2))-1),b.setDate(parseInt(o.substr(8,2))),h.setDate(parseInt(a.substr(8,2))),b.setHours(parseInt(o.substr(11,2))),h.setHours(parseInt(a.substr(11,2))),b.setMinutes(parseInt(o.substr(14,2))),h.setMinutes(parseInt(a.substr(14,2))),v.getTime()>h.getTime()){muestraMensaje("C\xf3digo caducado",titulo="",subtitulo="Error");return}if(v.getTime()<b.getTime()){muestraMensaje("C\xf3digo  a\xfan no es v\xe1lido",titulo="",subtitulo="Error");return}}if("no"==c||0==n||d>0&&parseInt(p)>=parseInt(d)){muestraMensaje("Cup\xf3n no v\xe1lido",titulo="",subtitulo="Error");return}if(v.getTime()>h.getTime()){muestraMensaje("Cup\xf3n caducado",titulo="",subtitulo="Error");return}if(r>2&&v.getTime()<b.getTime()){muestraMensaje("Cup\xf3n a\xfan no es v\xe1lido",titulo="",subtitulo="Error");return}var g=s.split("##");if("1"==t){if(""!=g[1]&&parseFloat(g[1])>parseFloat(carritoSubtotal)){muestraMensaje("El p\xe9dido minimo es de "+g[1]+"€",titulo="",subtitulo="Pedido m\xednimo");return}descuento=parseFloat(carritoSubtotal)*parseFloat(g[0])/100,tipo_descuento="1#"+g[0]}if("2"==t){g=s.split("##");for(var f=0,k=0;k<carrito.length;k++)carrito[k].id.split("-")[0]==g[1]&&(f+=carrito[k].cantidad*parseFloat(carrito[k].precio),tipo_descuento="2#"+g[0]+"#"+carrito[k].id);if(0==f){muestraMensaje("C\xf3digo no v\xe1lido",titulo="",subtitulo="Error");return}descuento=f*parseFloat(g[0])/100}if("3"==t){if(parseFloat(g[0])>parseFloat(carritoSubtotal)){muestraMensaje("El p\xe9dido minimo de este c\xf3digo es de "+g[0]+"€",titulo="",subtitulo="Pedido m\xednimo");return}descuento=parseFloat(carrito_domicilio.envio),tipo_descuento="3#"+carrito_domicilio.envio}if("4"==t){if(""!=g[1]&&parseFloat(g[1])>parseFloat(carritoSubtotal)){muestraMensaje("El p\xe9dido minimo es de "+g[1]+"€",titulo="",subtitulo="Pedido m\xednimo");return}descuento=parseFloat(g[0]),tipo_descuento="4#"+g[0]}if(0!=l&&l!=tipo_envio){muestraMensaje("C\xf3digo no v\xe1lido",titulo="",subtitulo="Error");return}cupon_usado=$("#codigopromocion").val(),$("#div-codigopromocion").hide(),miLocalStorage.setItem("cupon",encripta(descuento)),muestraMensaje("Descuento aplicado: <b>"+descuento.toFixed(2)+"</b> €",titulo="",subtitulo="Descuento Ok");var _=ponetotales();if(monedero_a_usar>0){var f=carritoSubtotal-descuento+parseFloat(carrito_domicilio.envio);monedero_a_usar>f&&(monedero_a_usar=f,console.log("cambio valor"),$("#valor-monedero-usar").html(monedero_a_usar.toFixed(2)))}$("#cart-final").html(_)}else muestraMensaje("C\xf3digo no v\xe1lido",titulo="",subtitulo="Error"),$("#codigopromocion").val("")},error:function(e,i,o){console.log(e.status),console.log(o)}})}}function evaluatextomsg(){$("#caracteres").css("color",colorprimario);var e=document.getElementById("comentario").value;document.getElementById("caracteres").innerHTML=140-e.length,e.length>140&&(document.getElementById("comentario").value=e.substring(0,e.length-1),document.getElementById("caracteres").innerHTML="0")}function cambiametodopago(e){$("#metodo_pago").prop("checked")?$("#div-tarjeta").hide():$("#div-tarjeta").show()}function cambiausomonedero(e){monedero_a_usar=$("#monedero").prop("checked")?parseFloat($("#valor-monedero-usar").html()):0;var i=ponetotales();$("#cart-final").html(i)}function comprapaso5(){var e=1;$('#metodo-de-pago [name="metodo_pago"]:checked').each(function(){e=$(this).val()}),terminarcompra()}function verTarjeta(){app.smartSelect.close(".smart-select"),$("#comprar-form-tarj").find("#titular").val($(".smart-select").find(":selected").attr("data-titular")),$("#comprar-form-tarj").find("#numero").val($(".smart-select").find(":selected").attr("data-numero").replace(/([0-9]{4})/g,"$1 ")),$("#comprar-form-tarj").find("#mm").val($(".smart-select").find(":selected").attr("data-mm")),$("#comprar-form-tarj").find("#aa").val($(".smart-select").find(":selected").attr("data-aa")),$("#comprar-form-tarj").find("#csv").val($(".smart-select").find(":selected").attr("data-csv")),$("#img-tarjeta").attr("src","img/tarjetas/"+$(".smart-select").find(":selected").attr("data-tipo")+".png")}function terminarcompra(){var e=0,i=0,o="",a="",t="",n="",r="",s=hora_envio,l=(carritoSubtotal.toFixed(2),parseFloat(carrito_domicilio.envio).toFixed(2),0),c=0;"1"==fidelizacion&&(c=parseFloat(desencripta(miLocalStorage.getItem("porcentaje_fidelizacion"))).toFixed(2),l=parseFloat(desencripta(miLocalStorage.getItem("mi_monedero"))).toFixed(2)),descuento.toFixed(2);var d=monedero_a_usar.toFixed(2),p=carritoSubtotal+parseFloat(carrito_domicilio.envio)-descuento-monedero_a_usar,m=p.toFixed(2),u=0,v=0,b=0,h="";if(null!=window.localStorage.getItem("cupon")&&(v=desencripta(miLocalStorage.getItem("cupon")),b=desencripta(miLocalStorage.getItem("idcupon")),h=$("#codigopromocion").val()),"1"==fidelizacion&&""!=miLocalStorage.getItem("username")){u=(carritoSubtotal*c/100).toFixed(2);var g=(parseFloat(l)-parseFloat(d)+parseFloat(u)).toFixed(2);miLocalStorage.setItem("mi_monedero",encripta(g))}var f=1;if(isApp&&(f=2),""!=window.localStorage.getItem("username")){var k=app.form.convertToData("#my-form-usu");i=k.tratamiento,r=k["publi-checkbox"],o=$('#my-form-usu input[name*="nombre"]').val(),a=$('#my-form-usu input[name*="apellidos"]').val(),n=$('#my-form-usu input[name*="telefono"]').val(),t=desencripta(window.localStorage.getItem("username")),e=desencripta(miLocalStorage.getItem("user"))}else i=carrito_invitado.tratamiento,r=carrito_invitado.publicidad,o=carrito_invitado.nombre,a=carrito_invitado.apellidos,n=carrito_invitado.telefono,t=carrito_invitado.email;var _=tipo_envio,w=1;$('#metodo-de-pago [name="metodo_pago"]:checked').each(function(){w=$(this).val()}),w==idRedys&&console.log("Tarjeta");var I=document.getElementById("comentario").value,T=servidor+"includes/verificahoralibre.php";$.ajax({type:"POST",url:T,data:{envio:_,hora:s},dataType:"json",success:function(l){if(!0==Object(l).valid){var c=servidor+"includes/addpedido.php";$.ajax({type:"POST",url:c,data:{cliente:e,canal:f,tratamiento:i,nombre:o,apellidos:a,telefono:n,email:t,carrito:carrito,publicidad:r,domicilio:carrito_domicilio,envio:_,tarjeta:w,hora:s,subtotal:parseFloat(carritoSubtotal),portes:parseFloat(carrito_domicilio.envio),descuento:parseFloat(descuento),tipo_descuento:tipo_descuento,monedero:parseFloat(monedero_a_usar),total:parseFloat(p),importe_fidelizacion:parseFloat(u),cupon:v,comentario:I,codigocupon:h,idcupon:b},dataType:"json",success:function(i){var o=Object(i);if(!0==o.valid){if(console.log("Tarjeta:"+parseInt(w)),parseInt(w)==parseInt(idRedsys)){document.all.iframe_tpv.src=servidor+"includes/tpv.php?importe="+m+"&order="+o.order+"&idpedido="+o.idpedido,navegar("#view-tpv"),$(".toolbar-bottom").hide(),$("#boton-menu-principal").hide(),$("#countdown-tpv").css("color",colorprimario),totalTimeTpv=300,myTimeoutTarjetaActivo="si";var a=Date.now();window.localStorage.setItem("nowseconds",a),updateClockTpv(o.idpedido,e)}else finalizaPedido(o.idpedido,o.order,2)}else muestraMensaje("Error procesando pedido",titulo="",subtitulo="Error");e>0&&buscapedidos(desencripta(window.localStorage.getItem("user"),1))},error:function(e,i,o){console.log(e.status),console.log(o)}})}else app.dialog.alert("La hora <b>"+s+"</b> ya no est\xe1 disponible.<br>Seleccione otra hora","Atenci\xf3n"),checkout_3()},error:function(e,i,o){console.log(e.status),console.log(o)}})}function secondsToString(e){var i=e%60;return Math.floor(e/60%60)+":"+(i=i<10?"0"+i:i)}var totalTimeTpv=0,myTimeoutTarjetaActivo="no";function updateClockTpv(e,i){if("si"==myTimeoutTarjetaActivo){document.getElementById("countdown-tpv").innerHTML=secondsToString(totalTimeTpv);var o=parseInt(Date.now()),a=parseInt(window.localStorage.getItem("nowseconds")),t=(o-a)/1e3;if(document.getElementById("countdown-tpv").innerHTML=secondsToString(Math.round(300-t)),t>=300&&(totalTimeTpv=0),0==totalTimeTpv){i>0&&buscapedidos(desencripta(window.localStorage.getItem("user"),1)),document.all.iframe_tpv.src="",navegar("#view-checkout"),$(".toolbar-bottom").show(),$("#boton-menu-principal").show();var n=servidor+"includes/cancelapedido.php";$.ajax({url:n,data:{idpedido:e},method:"post",dataType:"json",success:function(e){!0==Object(e).valid?(console.log("cancelado"),checkout_3()):console.log("error")},error:function(e,i,o){console.log(e.status),console.log(o)}})}else totalTimeTpv-=1,myTimeoutTarjeta=setTimeout("updateClockTpv("+e+","+i+")",1e3)}}function finalizaPedido(e,i,o){if(o!=idRedsys){var a=0,t=0,n=0;"1"==fidelizacion&&(a=parseFloat(desencripta(miLocalStorage.getItem("porcentaje_fidelizacion"))).toFixed(2),t=0,n=parseFloat(desencripta(miLocalStorage.getItem("mi_monedero"))).toFixed(2),monedero=monedero_a_usar.toFixed(2),""!=miLocalStorage.getItem("username")&&(t=(carritoSubtotal*a/100).toFixed(2)));var r=servidor+"includes/envioemail.php";$.ajax({url:r,data:{idpedido:e,tipo:"pedido",numero:i},method:"post",dataType:"json",success:function(e){!0==Object(e).valid||console.log("error mail")},error:function(e,i,o){console.log(e.status),console.log(o)}});var s="Hemos recibido tu pedido.";t>0&&"si"==desencripta(miLocalStorage.getItem("registrado"))&&(s+="<br>Has acumulado <b>"+t+"</b>€ en tu monedero"),muestraMensaje(s,titulo="",subtitulo="Gracias por tu compra","pedido-recibido.jpg",tiempo=5e3),borradatoscompra()}if("1"==fidelizacion&&$("#importe-mi-monedero").html("<b>"+parseFloat(desencripta(miLocalStorage.getItem("mi_monedero"))).toFixed(2)+"</b> €"),1==integracion){var r=servidor+"includes/pedidoaRevo.php";$.ajax({url:r,data:{idpedido:e,numero:i},method:"post",dataType:"json",success:function(i){var o=Object(i);if(!0==o.valid){var a=o.idRevo;if(a>0)actualizapedidoRevo(e,a);else{var t=1;$('#metodo-de-pago [name="metodo_pago"]:checked').each(function(){t=$(this).val()})}}},error:function(e,i,o){console.log(e.status),console.log(o)}})}else{var r=servidor+"includes/imprimeticket.php";$.ajax({url:r,data:{idpedido:e,numero:i},method:"post",dataType:"json",success:function(e){!0==Object(e).valid&&console.log("ticket enviado")},error:function(e,i,o){console.log(e.status),console.log(o)}})}}function actualizapedidoRevo(e,i){var o=servidor+"includes/actualizapedidoRevo.php";$.ajax({url:o,data:{idpedido:e,idrevo:i},method:"post",dataType:"json",success:function(e){!0==Object(e).valid||console.log("error")},error:function(e,i,o){console.log(e.status),console.log(o)}})}function borradatoscompra(){carrito=[],carrito_domicilio={direccion:"",complementario:"",cod_postal:"",poblacion:"",provincia:"",envio:"0",minimo:"0"},carritohtml="",carritoSubtotal=0,totalItemCarrito=0,tipo_descuento="",descuento=0,guardarCarritoEnLocalStorage(),miLocalStorage.setItem("carrito_domicilio",JSON.stringify(carrito_domicilio)),miLocalStorage.removeItem("cupon"),miLocalStorage.removeItem("idcupon"),cargarCarritoDeLocalStorage(),calcularTotal(),renderizarCarrito(),totalItemCarrito=calcularTotal(),$(".subnavbar").show(),$("#search").show(),navegar("#view-catalog")}function cancelaPedido(e){var i=servidor+"includes/cancelapedido.php";$.ajax({url:i,data:{idpedido:e},method:"post",dataType:"json",success:function(e){!0==Object(e).valid?console.log("cancelado"):console.log("error")},error:function(e,i,o){console.log(e.status),console.log(o)}}),borradatoscompra()}function initMap(){map=new google.maps.Map(document.getElementById("map"),{center:{lat:36.6011332,lng:-6.2281583},zoom:18})}function editaDomicilioCompra(e){var i="",o="Crear direcci\xf3n";o="Nueva direcci\xf3n";var a='<form class="list" id="my-form-domi-compra" style="margin-top:25px;"><input type="hidden" name="id" value="'+e+'"/><input type="hidden" name="iddomi" value="'+(i="NUEVO")+'"/><ul><li><div class="item-content item-input"><div class="item-inner"><div class="item-title item-label">Alias</div><div class="item-input-wrap"><input type="text" name="alias" placeholder="Alias" value=""/></div></div></div></li><li><div class="item-content item-input"><div class="item-inner"><div class="item-title item-label">Direcci\xf3n</div><div class="item-input-wrap"><input type="text" id="midireccionactual" name="direccion" placeholder="Direcci\xf3n" value="" required validate/></div></div></div></li><li><div class="item-content item-input"><div class="item-inner"><div class="item-title item-label">Direcci\xf3n complementaria</div><div class="item-input-wrap"><input type="text" name="complementario" placeholder="Direcci\xf3n complementaria" value=""/></div></div></div></li><li><div class="item-content item-input"><div class="item-inner"><div class="item-title item-label">Cod. Postal</div><div class="item-input-wrap"><input type="text" name="cod_postal" placeholder="Cod. Postal" value="" required validate/></div></div></div></li><li><div class="item-content item-input"><div class="item-inner"><div class="item-title item-label">Poblaci\xf3n</div><div class="item-input-wrap"><input type="text" name="poblacion" placeholder="Poblaci\xf3n" value="" required validate/></div></div></div></li><li><div class="item-content item-input"><div class="item-inner"><div class="item-title item-label">Provincia</div><div class="item-input-wrap"><input type="text" name="provincia" placeholder="Provincia" value="" required validate/></div></div></div></li></ul></form><div class="text-align-center" style="width:50%;margin:auto;"><a class="button button-fill button-round" id="guarda-datos-domicilio" href="#" onclick="guardaDomicilioCompra();">Guardar</a></div>  ';app.popup.create({content:'<div class="popup"><p class="text-color-primary" style="float: right;"><a class="link popup-close"><i class="icon f7-icons">xmark</i></a></p><div class="block page-content"> <div class="block-title block-title-medium">'+o+'</div><div class="block">'+a+"<br></div></div></div>"}).open()}function guardaDomicilioCompra(){var e=app.form.convertToData("#my-form-domi-compra"),i="",o=e.id,a=e.iddomi,t=e.alias,n=e.direccion,r=e.complementario,s=e.cod_postal,l=e.poblacion,c=e.provincia;""==n&&(i+="Direcci\xf3n, "),""==s&&(i+="C\xf3digo Postal, "),""==l&&(i+="Poblaci\xf3n, "),""==c&&(i+="Provioncia, "),""!=i?(i="Debe completar "+i.substring(0,i.length-2)+".",app.dialog.alert(i)):$.get("https://maps.googleapis.com/maps/api/geocode/json?address="+n+" "+s+" "+l+"&key=AIzaSyDsv3MEv58JZ42mQIqNyE_Zwpyo361dzhs",function(e){var i=servidor+"includes/modificadireccion.php";$.ajax({type:"POST",url:i,data:{id:o,iddomi:a,alias:t,direccion:n,complementario:r,cod_postal:s,poblacion:l,provincia:c,lat:e.results[0].geometry.location.lat,lng:e.results[0].geometry.location.lng},dataType:"json",success:function(e){!0==Object(e).valid?(app.popup.close(),$(".sin-direcciones").hide()):muestraMensaje("No se pudo guardar domicilio",titulo="",subtitulo="Error"),document.getElementById("3-dir-envio").innerHTM=buscadirecciones_compra(o)}})})}var txt_compra_dom_form='<form class="list" id="my-form-domi-compra" style="margin-top:25px;"><ul><li><div class="item-content item-input"><div class="item-inner"><div class="item-title item-label">Direcci\xf3n</div><div class="item-input-wrap"><input type="text" name="direccion" placeholder="Direcci\xf3n" value="" required validate/></div></div></div></li><li><div class="item-content item-input"><div class="item-inner"><div class="item-title item-label">Direcci\xf3n complementaria</div><div class="item-input-wrap"><input type="text" name="complementario" placeholder="Direcci\xf3n complementaria" value=""/></div></div></div></li><li><div class="item-content item-input"><div class="item-inner"><div class="item-title item-label">Cod. Postal</div><div class="item-input-wrap"><input type="text" name="cod_postal" placeholder="Cod. Postal" value="" required validate/></div></div></div></li><li><div class="item-content item-input"><div class="item-inner"><div class="item-title item-label">Poblaci\xf3n</div><div class="item-input-wrap"><input type="text" name="poblacion" placeholder="Poblaci\xf3n" value="" required validate/></div></div></div></li><li><div class="item-content item-input"><div class="item-inner"><div class="item-title item-label">Provincia</div><div class="item-input-wrap"><input type="text" name="provincia" placeholder="Provincia" value="" required validate/></div></div></div></li></ul></form><div class="text-align-center" style="width:50%;margin:auto;height: 35px;"><a class="button button-fill button-round" href="#" onclick="direcciones_compra_nuevo();">Continuar</a></div>  ',txt_compra_form='<form class="list" id="my-form-usu-compra" ><p class="block-title" id="titulo-nuevo-usu-compras">Nuevo usuario</p><input type="hidden" name="id" value="NUEVO"/><ul><li><div class="item-content item-input"><div class="item-inner"><div class="item-title item-label">Tratamiento</div><div class="item-input-wrap"><p style="margin-top: 10px;margin-bottom: 10px;">Sr.<label class="radio"><input type="radio" name="tratamiento" id="tratamiento-sr" value="1" checked/><i class="icon-radio icon-tratamiento"></i></label> Sra.<label class="radio"><input type="radio" name="tratamiento" value="2" id="tratamiento-sra" /><i class="icon-radio icon-tratamiento"></i></label></p></div></div></div></li><li><div class="item-content item-input"><div class="item-inner"><div class="item-title item-label">Nombre</div><div class="item-input-wrap"><input type="text" name="nombre" placeholder="Nombre" required validate/></div></div></div></li><li><div class="item-content item-input"><div class="item-inner"><div class="item-title item-label">Apellidos</div><div class="item-input-wrap"><input type="text" name="apellidos" placeholder="Apellidos" required validate/></div></div></div></li><li><div class="item-content item-input"><div class="item-inner"><div class="item-title item-label">Fecha nacimiento</div><div class="item-input-wrap"><input type="text" name="nacimiento" id="nacimiento-compras" placeholder="Fecha nacimiento" required validate/></div></div></div></li><li><div class="item-content item-input"><div class="item-inner"><div class="item-title item-label">Email</div><div class="item-input-wrap"><input type="email" name="email" placeholder="Email" required validate/></div></div></div></li><li><div class="item-content item-input"><div class="item-inner"><div class="item-title item-label">Tel\xe9fono</div><div class="item-input-wrap"><input type="text" name="telefono" placeholder="Tel\xe9fono" required validate/></div></div></div></li></ul><p style="font-size:14px;" id="crear-cuenta-nuevo"><b>Crear una cuenta</b> (opcional)<br><span style="font-size:12px;">\xa1Y ahorre tiempo en su pr\xf3ximo pedido!</span></p><ul><li id="pass-nuevo-usu"><div class="item-content item-input"><div class="item-inner"><div class="item-title item-label">Contrase\xf1a</div><div class="item-input-wrap"><input type="password" name="pass" placeholder="Contrase\xf1a" id="campo-clave6"  validate required style="margin-top: -2px;margin-bottom: -25px;"/><div style="float:right;position: relative;top:-10px;right:10px;;"><i class="f7-icons size-22 campo-clave6" onclick="muestraOcultaClave(\'campo-clave6\');">eye_slash</i></div></div></div></div></li><li><label class="item-checkbox item-content"><input type="checkbox" name="publi-checkbox" value="1" /><i class="icon icon-checkbox"></i><div class="item-inner"><div class="item-title" style="font-size:.8em;">Acepto recibir ofertas y publicidad.</div></div></label></li><li><label class="item-checkbox item-content"><input type="checkbox" name="privacidad-checkbox" value="1" /><i class="icon icon-checkbox"></i><div class="item-inner"><div class="item-title" style="font-size:.8em;">Acepto la <a href="#" class="link" onclick="leePolitica();">Pol\xedtica de privacidad</a>.</div></div></label></li></ul><div class="text-align-center" style="width:50%;margin:auto;height: 35px;"><a class="button button-fill button-round" onclick="nuevoUsuCompra();" href="#">Continuar</a></div></form>';function buscadirecciones_old(e){var i=servidor+"includesapp/buscadirecciones.php";app.request.postJSON(i,{id:e},function(i){var o=Object(i);if(!0==o.valid){var a="",t=o.id,n=o.alias,r=o.preferida,s=o.direccion,l=o.complementario,c=o.cod_postal,d=o.poblacion,p=o.provincia,m="",u="",v="";for(x=0;x<n.length;x++)v="",u="",0!=r[x]&&(u="checked"),m=""!=n[x]?n[x]:"Mi domicilio "+(x+1),v=null!=l[x]?l[x]+"<br>":"",a+='<div class="card"><div class="card-header">'+m+'<label class="radio float-right"><input type="radio" name="dirpreferida" value="1" '+u+' onclick="cambiapreferenciadireccion('+e+","+t[x]+');"/><i class="icon-radio"></i></label> </div><div class="card-content card-content-padding">'+s[x]+"<br>"+v+c[x]+" - "+d[x]+"<br>("+p[x]+')</div><div class="card-footer"><span onclick="editaDomicilio('+e+',this);" data-id="'+e+'"  data-alias="'+n+'" data-iddomi="'+t[x]+'" data-direccion="'+s[x]+'" data-complementario="'+l[x]+'" data-cod_postal="'+c[x]+'" data-poblacion="'+d[x]+'" data-provincia="'+p[x]+'"><i class="f7-icons">pencil</i> Editar</span><span onclick="borraDomicilio(this);" data-id="'+e+'" data-idDomi="'+t[x]+'" data-alias="'+m+'"><i class="f7-icons" >trash</i> Borrar</span></div></div>'}else a='<p class="sin-direcciones">A\xfan no tiene direcciones asociadas.</p>';a+='<div class="sin-direcciones"><button onclick="editaDomicilio('+e+');" class="col-60 button button-fill" style="margin:auto;">+ A\xf1adir direcci\xf3n</button></div>',$("#ver-direccion-usu").html(a)},function(e,i){})}


