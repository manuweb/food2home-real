/**
 * Archivo: masdatos.min.js
 *
 * Version: 1.0.5
 * Fecha  : 29/09/2023
 *
 * © Manuel Sánchez (www.elmaestroweb.es)
 *
*/


function mostrarMasDatos() {  
    //console.log('Username:'+username);
    if (desencripta(localStorage.getItem('registrado'))=="no"){
    //loginUsuario();  
        $('#login-inicio').show();
        MirarHora();
    }
    else {
        $('#page-usu-datos').hide();
        $('#page-more').html('');
        //$('#icon-back-more').hide();  
        $('#icon-back-more').hide();
        //document.getElementById("link-volver-more").href = '#';
        //$('#title-mas-datos').html('Más'); 
        $('#page-more').html('');
        var badage=$('.badage-noti-usu').html();

        var server=servidor+'includes/masdatos.php';
         $.ajax({
            url: server,
            data:{ username:username },
            method: "post",
            dataType:"json",
            success: function(data){ 
                var obj=Object(data);
                if (obj.valid==true){
                    texto=obj.texto;
                    $('#page-more').html(texto);
                }
                else {               
                    muestraMensaje('No se pudo leer la pagina "Más"',titulo='',subtitulo='Error');
                } 
                MirarHora();
        
                if($('.badage-noti-usu').html()=='') {
                    $('.badage-noti-usu').hide();
                    $('.badage-noti-nousu').hide();
                }
            }
         });

        
    }
    
                    
                    
}

function muestraMisDatos(){
    if (window.localStorage.getItem("registrado")=='no'){
        navegar('#view-usuario');
    }
    else {
        
            
        $('#icon-back-more').show();  

        document.getElementById("link-volver-more").href = "javascript:mostrarMasDatos();$('#page-more').show();$('#page-usu-datos').hide();";
        $('#page-more').hide();
        $('#page-usu-datos').show();
        
        
    } 
}

function muestraTarjetas(){
    if (window.localStorage.getItem("registrado")=='no'){
        navegar('#view-usuario');
    }
    else {
        buscatarjetas(window.localStorage.getItem("user"))
    } 
}


/*
function buscatarjetas(id){
    //ver-direccion-usu
    var server=servidor+'includesapp/buscatarjetas.php';  
    app.request.postJSON(server, { id:id, }, 
        function (data) {
            var obj=Object(data);
            if (obj.valid==true){
                var txt="";    
                var alias=obj.alias;
                var preferida=obj.preferida;
                var idTarjeta=obj.id;
                var titular=obj.titular;
                var numero=obj.numero;
                var aa=obj.aa;
                var mm=obj.mm;
                var csv=obj.csv;
                var tipo=obj.tipo;
                var prefe='';            
            }
            
            $('#title-mas-datos').html('Mis tarjetas');   
            $('#page-more').html(obj.txt);  
            $('#icon-back-more').show();  
        
            document.getElementById("link-volver-more").href = 'javascript:mostrarMasDatos();';
        
        },
        function (xhr, status) {
            muestraMensaje('No se pudo buscar tarjetas',titulo='',subtitulo='Error');
        
    });       
}

function editaTarjeta(id,e) {
    var alias='';
    var idTarjeta='';
    var titular=''; 
    var numero=''; 
    var mm='';
    var aa='';
    var csv='';
    var tipo='none';  
    var titulo="Crear tarjeta";
    
    if (e!=undefined) {
        
        idTarjeta=e.getAttribute('data-id');
        alias=e.getAttribute('data-alias');
        titular=e.getAttribute('data-titular');  
        numero=e.getAttribute('data-numero'); 
        mm=e.getAttribute('data-mm'); 
        aa=e.getAttribute('data-aa'); 
        csv=e.getAttribute('data-csv'); 
        tipo=e.getAttribute('data-tipo'); 
        titulo="Modificar tarjeta";
 
    }
    else {
        idTarjeta='NUEVO'
        titulo="Nueva tarjeta";
    }
    var texto=""+
    '<form class="list" id="my-form-tarj" style="margin-top:5px;">'+
        '<input type="hidden" name="id" value="'+id+'"/>'+   
        '<input type="hidden" name="idtarj" value="'+idTarjeta+'"/>'+
        '<ul>'+
            '<li>'+
                '<div class="item-content item-input">'+
                    '<div class="item-inner">'+
                        '<div class="item-title item-label">Alias</div>'+
                        '<div class="item-input-wrap">'+
                            '<input type="text" name="alias" placeholder="Alias" value="'+alias+'"/>'+
                        '</div>'+
                    '</div>'+
                '</div>'+
            '</li>'+
            '<li>'+
                '<div class="item-content item-input">'+
                    '<div class="item-inner">'+
                        '<div class="item-title item-label">Titular</div>'+
                        '<div class="item-input-wrap">'+
                            '<input type="text" id="titular" name="titular" placeholder="Titular" value="'+titular+'" required validate autocomplete="off" style="text-transform: uppercase;"/>'+
                        '</div>'+
                    '</div>'+
                '</div>'+
            '</li>'+ 
            '<li>'+
                '<div class="item-content item-input">'+
                    '<div class="item-inner">'+
                        '<div class="item-title item-label">Número</div>'+
                        '<div class="item-input-wrap" style=" display: inherit;">'+
                            '<input type="text" id="numero" name="numero" placeholder="Número" value="'+numero+'" required validate autocomplete="off" onkeyup="this.value=observaNumeroTarjeta(this.value,\'img-tarjeta\');"/><div style="float: right;"><img src="img/tarjetas/'+tipo+'.png" height="30" width="auto" id="img-tarjeta"></div>'+
                        '</div>'+
                    '</div>'+
                '</div>'+
            '</li>'+ 
            '<li>'+
                '<div class="item-content item-input">'+
                    '<div class="item-inner">'+
                        '<div class="item-title item-label">Validez</div>'+
                        '<div class="item-input-wrap">'+
                            '<input type="text" id="mm" name="mm" placeholder="mm" value="'+mm+'" pattern="[0-9]{2}" required validate style="float:left;width: 30px;"/>'+'<span style="float:left;position: relative;top: 8px;"> / </span>'+
                            '<input type="text" id="aa" name="aa" placeholder="aa" value="'+aa+'" pattern="[0-9]{2}" required validate style="float: left;width: 50px;position: relative;left: 10px;"/>'+
                        '</div>'+
                    '</div>'+
                '</div>'+
            '</li>'+ 
            '<li>'+
                '<div class="item-content item-input">'+
                    '<div class="item-inner">'+
                        '<div class="item-title item-label">CSV</div>'+
                        '<div class="item-input-wrap" style=" display: inherit;">'+
                            '<input type="text" id="csv" name="csv" placeholder="CSV" value="'+csv+'" required validate autocomplete="off" pattern="[0-9]{3}|[0-9]{4}"/>'+
                        '</div>'+
                    '</div>'+
                '</div>'+
            '</li>'+ 
        '</ul>'+
    '</form>'+
    '<div class="text-align-center" style="width:50%;margin:auto;"><a class="button button-fill button-round" id="guarda-datos-tarjeta" href="#" onclick="guardaTarjeta();">Guardar</a></div>  ';

    var dynamicPopup = app.popup.create({
        content:  ''+
          '<div class="popup">'+
            '<div class="block page-content">'+
              '<p class="text-align-right"><a href="#" class="link popup-close"><i class="icon f7-icons ">xmark</i></a></p>'+
                ' <div class="block-title block-title-medium">'+titulo+'</div>'+
                '<div class="block">'+texto+'<br></div>'+
            '</div>'+
          '</div>'
         ,
        
    });  
    
    dynamicPopup.open();  
}

function guardaTarjeta(){
    var formData = app.form.convertToData('#my-form-tarj');
    //app.dialog.alert(JSON.stringify(formData));
    var errores="";
    var id=formData['id'];
    var idtarj=formData['idtarj'];
    var alias=formData['alias'];
    var titular=formData['titular'].toUpperCase();
    var numero=formData['numero'];
    var mm=formData['mm'];
    var aa=formData['aa'];
    var csv=formData['csv'];
    var tipo="";
    
    var today = new Date();
    var myDate=new Date();
    myDate.setFullYear(2000+parseInt(aa));
    myDate.setMonth(parseInt(mm)-1); 
    
    if (titular==''){
        errores+='Titular, ';
    }
    if (numero==''){
        errores+='Número, ';
    }
    if (mm==''){
        errores+='Mes , ';
    }
    if (aa==''){
        errores+='Año, ';
    }
    if (csv==''){
        errores+='CSV, ';
    }
    if (myDate<today){
        errores+='Tarjeta caducada, ';
    }
    if (errores!=''){
        errores = 'Revise: '+errores.substring(0, errores.length - 2)+'.';
        app.dialog.alert(errores);
    }  
    else {
        var server=servidor+'includesapp/modificatarjeta.php';  
        tipo=miraTipoTarjeta(numero);
            app.request.postJSON(server, { id:id, idtarj:idtarj, alias:alias, titular:titular, numero:numero.replace(/\s/g, ''), mm:mm, aa:aa, csv:csv, tipo:tipo}, 
                function (data) {
                    var obj=Object(data);
                    if (obj.valid==true){  
                        app.popup.close(); 
                        buscatarjetas(id);
                    }
                    else {
                        muestraMensaje('No se pudo guardar tarjeta',titulo='',subtitulo='Error');
                    }
                    buscatarjetas(id)  ;  
                },
                function (xhr, status) {
                    muestraMensaje('No se pudo guardar tarjeta',titulo='',subtitulo='Error');
            });              
        
        
    }
    
    
    
}

function borraTarjeta(e) {
    var id=e.getAttribute('data-id');
    var alias=e.getAttribute('data-alias');
    var idTarjeta=e.getAttribute('data-idTarjeta');
    var tipo=e.getAttribute('data-tipo');
    var numero=e.getAttribute('data-numero');
    app.dialog.confirm('¿Borrar '+alias+' <img src="img/tarjetas/'+tipo+'.png" height="20" width="auto" > <br>'+numero+'? ', function () {
          //borramos id:id
        var server=servidor+'includesapp/borratarjeta.php';  
        app.request.postJSON(server, { id:idTarjeta }, 
            function (data) {
                var obj=Object(data);
                if (obj.valid==true){
                    buscatarjetas(id);
                }
                else {
                    muestraMensaje('No se pudo borrar '+alias,titulo='',subtitulo='Error');
                }
            },
            function (xhr, status) {
                muestraMensaje('No se pudo borrar '+alias,titulo='',subtitulo='Error');
        });     
        
    });  
}

function cambiapreferenciatarjeta(id,idtar) {
    var server=servidor+'includesapp/cambiapreferenciatarjeta.php';  
                app.request.postJSON(server, { id:id, idtar:idtar}, 
                    function (data) {
                        var obj=Object(data);
                        if (obj.valid==true){  
                            
                            //buscadirecciones(id);
                        }
                        else {
                            muestraMensaje('No se pudo guardar preferncia',titulo='',subtitulo='Error');
                        }
                        buscatarjetas(id)  ;  
                    },
                    function (xhr, status) {
                        muestraMensaje('No se pudo guardar preferncia',titulo='',subtitulo='Error');
                });      
}
*/


function muestraDomicilios(){
    
    if (desencripta(window.localStorage.getItem("registrado"))=='no'){
        navegar('#view-usuario');
    }
    else {

        $('#icon-back-more').show();   
        document.getElementById("link-volver-more").href = 'javascript:mostrarMasDatos();';
        
        miradirecciones(desencripta(window.localStorage.getItem("user")));

        
    }    
    
}

function miradirecciones(id){  
    var server=servidor+'includes/buscadirecciones.php'; 
    $.ajax({
        url: server,
        data:{id:id},
        method: "post",
        dataType:"json",
        success: function(data){ 
            var obj=Object(data);
            if (obj.valid==true){
                var txt="";
                var iddomi=obj.id;
                var linea="";
                var alias=obj.alias;
                var preferida=obj.preferida;
                var direccion=obj.direccion;
                var complementario=obj.complementario;
                var cod_postal=obj.cod_postal;
                var poblacion=obj.poblacion;
                var provincia=obj.provincia;
             
            }
        
            //$('#title-mas-datos').html('Mis domicilios');   
            $('#page-more').html('<div class="block-title" style="margin-top: 0;margin-bottom: 20px;color: var(--primario);">Mis domicilios</div>'+obj.txt);  
            $('#icon-back-more').show();   
            document.getElementById("link-volver-more").href = 'javascript:mostrarMasDatos();';
        
        }
    });       
}

function editaDomicilio(id,e) {
    var alias='';
    var idDomi='';
    var direccion=''; 
    var complementario=''; 
    var cod_postal='';
    var poblacion='';
    var provincia='';
    var titulo="Crear dirección";
    if (e!=undefined) {
        id=e.getAttribute('data-id');
        idDomi=e.getAttribute('data-iddomi');
        alias=e.getAttribute('data-alias');
        direccion=e.getAttribute('data-direccion');  
        complementario=e.getAttribute('data-complementario'); 
        cod_postal=e.getAttribute('data-cod_postal'); 
        poblacion=e.getAttribute('data-poblacion'); 
        provincia=e.getAttribute('data-provincia'); 
        titulo="Modificar dirección";
 
    }
    else {
        idDomi='NUEVO'
        titulo="Nueva dirección";
        //console.log('Nuevo');
    }



    var texto=""+
    '<form class="list" id="my-form-domi" style="margin-top:5px;">'+
        '<input type="hidden" name="id" value="'+id+'"/>'+   
        '<input type="hidden" name="iddomi" value="'+idDomi+'"/>'+
        '<ul>'+
            '<li>'+
                '<div class="item-content item-input">'+
                    '<div class="item-inner">'+
                        '<div class="item-title item-label">Alias</div>'+
                        '<div class="item-input-wrap">'+
                            '<input type="text" name="alias" placeholder="Alias" value="'+alias+'"/>'+
                        '</div>'+
                    '</div>'+
                '</div>'+
            '</li>'+
            '<li>'+
                '<div class="item-content item-input">'+
                    '<div class="item-inner">'+
                        '<div class="item-title item-label">Dirección</div>'+
                        '<div class="item-input-wrap">'+
                            '<input type="text" id="midireccionactual" name="direccion" placeholder="Dirección" value="'+direccion+'" required validate/>'+
                        '</div>'+
                    '</div>'+
                '</div>'+
            '</li>'+ 
            '<li>'+
                '<div class="item-content item-input">'+
                    '<div class="item-inner">'+
                        '<div class="item-title item-label">Dirección complementaria</div>'+
                        '<div class="item-input-wrap">'+
                            '<input type="text" name="complementario" placeholder="Dirección complementaria" value="'+complementario+'"/>'+
                        '</div>'+
                    '</div>'+
                '</div>'+
            '</li>'+ 
            '<li>'+
                '<div class="item-content item-input">'+
                    '<div class="item-inner">'+
                        '<div class="item-title item-label">Cod. Postal</div>'+
                        '<div class="item-input-wrap">'+
                            '<input type="text" name="cod_postal" placeholder="Cod. Postal" value="'+cod_postal+'" required validate/>'+
                        '</div>'+
                    '</div>'+
                '</div>'+
            '</li>'+ 
            '<li>'+
                '<div class="item-content item-input">'+
                    '<div class="item-inner">'+
                        '<div class="item-title item-label">Población</div>'+
                        '<div class="item-input-wrap">'+
                            '<input type="text" name="poblacion" placeholder="Población" value="'+poblacion+'" required validate/>'+
                        '</div>'+
                    '</div>'+
                '</div>'+
            '</li>'+
            '<li>'+
                '<div class="item-content item-input">'+
                    '<div class="item-inner">'+
                        '<div class="item-title item-label">Provincia</div>'+
                        '<div class="item-input-wrap">'+
                            '<input type="text" name="provincia" placeholder="Provincia" value="'+provincia+'" required validate/>'+
                        '</div>'+
                    '</div>'+
                '</div>'+
            '</li>'+ 
        '</ul>'+
    '</form>'+
    '<div class="text-align-center" style="width:50%;margin:auto;"><a class="button button-fill button-round" id="guarda-datos-domicilio" href="#" onclick="guardaDomicilio();">Guardar</a></div>  ';

    var dynamicPopup = app.popup.create({
        content:  ''+
          '<div class="popup">'+
            '<div class="block page-content">'+
              '<p class="text-align-left"><a href="#" class="link popup-close"><i class="icon f7-icons ">xmark</i></a></p>'+
                ' <div class="block-title block-title-medium">'+titulo+'</div>'+
                '<div class="block">'+texto+'<br></div>'+
            '</div>'+
          '</div>'
         ,
        // Events
        
    });  
    
    dynamicPopup.open();  
    //navegar('#view-setting-domi');
    
  
                          
}

function cambiapreferenciadireccion(id,iddomi) {
    
    var server=servidor+'includes/cambiapreferenciadireccion.php';  
    $.ajax({
        url: server,
        data:{id:id, iddomi:iddomi},
        method: "post",
        dataType:"json",
        success: function(data){ 
            var obj=Object(data);
            if (obj.valid==true){  

            }
            else {
                muestraMensaje('No se pudo guardar preferncia',titulo='',subtitulo='Error');
            }
            miradirecciones(id)  ;  
        }
    });   
}


function guardaDomicilio() {
    var formData = app.form.convertToData('#my-form-domi');
    //app.dialog.alert(JSON.stringify(formData));
    var errores="";
    var id=formData['id'];
    var iddomi=formData['iddomi'];
    var alias=formData['alias'];
    var direccion=formData['direccion'];
    var complementario=formData['complementario'];
    var cod_postal=formData['cod_postal'];
    var poblacion=formData['poblacion'];
    var provincia=formData['provincia'];
    
    if (direccion==''){
        errores+='Dirección, ';
    }
    if (cod_postal==''){
        errores+='Código Postal, ';
    }
    if (poblacion==''){
        errores+='Población, ';
    }
    if (provincia==''){
        errores+='Provioncia, ';
    }
    if (errores!=''){
        errores = 'Debe completar '+errores.substring(0, errores.length - 2)+'.';
        app.dialog.alert(errores);
    }
    else {
        
        $.get('https://maps.googleapis.com/maps/api/geocode/json?address='+direccion+' '+cod_postal+' '+poblacion+'&key=AIzaSyDsv3MEv58JZ42mQIqNyE_Zwpyo361dzhs', 
            function(data) {
            
                var server=servidor+'includes/modificadireccion.php'; $.ajax({
                    url: server,
                    data:{id:id, iddomi:iddomi, alias:alias, direccion:direccion, complementario:complementario, cod_postal:cod_postal, poblacion:poblacion, provincia:provincia, lat:data.results[0].geometry.location.lat, lng:data.results[0].geometry.location.lng},
                    method: "post",
                    dataType:"json",
                    success: function(data){ 
                        var obj=Object(data);
                        if (obj.valid==true){   
                            app.popup.close(); 

                            miradirecciones(id);
                            
                        }
                        else {
                            muestraMensaje('No se pudo guardar domicilio',titulo='',subtitulo='Error');
                        
                        }
                        //miradirecciones(id)  ;  
                    }
                });
        });
    }
}

function borraDomicilio(e) {
    var id=e.getAttribute('data-id');
    var alias=e.getAttribute('data-alias');
    var idDomi=e.getAttribute('data-idDomi');
    app.dialog.confirm('¿Borrar '+alias+'?', function () {
          //borramos id:id
        var server=servidor+'includes/borradireccion.php'; 
        $.ajax({
            url: server,
            data:{id:idDomi},
            method: "post",
            dataType:"json",
            success: function(data){ 
                var obj=Object(data);
                if (obj.valid==true){
                    miradirecciones(id)  ;  
                }
                else {
                    muestraMensaje('No se pudo borrar '+alias,titulo='',subtitulo='Error');
                }
            }
        });     
    });  
}


function buscalospedidos(){
    if (desencripta(window.localStorage.getItem("registrado"))=='no'){
        navegar('#view-usuario');
    }
    else {
        buscapedidos(desencripta(window.localStorage.getItem("user")));
    }
  
}



function buscapedidos(cliente=0, pagina=1){
    var server=servidor+'includes/buscapedidos.php';  
    $.ajax({
        url: server,
        data:{cliente:cliente,pagina:pagina},
        method: "post",
        dataType:"json",
        success: function(data){ 
            var obj=Object(data);
            if (obj.valid==true){ 
                /*
                var numero=obj.numero;
                var estadoPago=obj.estadoPago;
                var fecha=obj.fecha;
                var hora=obj.hora;
                //var cliente=obj.cliente;
                var apellidos=obj.apellidos;
                var nombre=obj.nombre;
                var ape_otro=obj.ape_otro;
                var nom_otro=obj.nom_otro;
                var subtotal=obj.subtotal;
                var impuestos=obj.impuestos;
                var descuentos=obj.descuentos;
                var envio=obj.envio;
                var metodo=obj.metodo;
                var total=obj.total;
           
                
                var numReg=obj.registros;
                var paginas=numReg/5;
                var resto=numReg%5;
                var pagina_actual=pagina;
                if (resto>0){
                    paginas=Math.trunc(paginas)+1;
                }
                */              
            }
            $('#page-more').html('<div class="block-title" style="margin-top: 0;margin-bottom: 20px;color: var(--primario);">Mis pedidos</div>'+obj.txt);  
            $('#icon-back-more').show();   
            document.getElementById("link-volver-more").href = 'javascript:mostrarMasDatos();';
        }
    });
                  
}


function verpedido(idpedido){
    
   var txt='';
    var dynamicPopup = app.popup.create({
        content: ''+
          '<div class="popup">'+
            '<div class="block page-content">'+
              '<p class="text-align-left"><a href="#" class="link popup-close"><i class="icon f7-icons ">xmark</i></a></p><br><br>'+
                '<div id="detallepedido"></div>'+         
            '</div>'+
          '</div>'  ,
        on: {
         open: function (popup) {
             
            var txt='';
            var server=servidor+'includes/leeunpedido.php';          $.ajax({
                url: server,
                data:{idpedido:idpedido},
                method: "post",
                dataType:"json",
                success: function(data){ 
                    var obj=Object(data);   
                    var anulado="";
                    if (obj.valid==true){
                        //console.log(obj.order);
                        var order=obj.order;
                        var carrito=order['carrito'];
                        
                        if (obj.estadoPago==-1){
                            anulado='<span style="color:red;"> --> <b>ANULADO</b></span>';
                        }
                        var haymenu=0;
                        for(var x=0;x<carrito.length;x++){
                           if (carrito[x]['menu']>0){
                               haymenu=1;
                           } 
                        }
                        if(haymenu==0){
                            txt +='<div class="text-align-center" style="width:50%;margin:auto;"><a class="button button-fill button-round" href="#" onclick="volverapedir(\''+idpedido+'\');">Volver a pedir</a></div><br>';
                        }

                        //var fecha=order['fecha'].substr(8,2)+'/'+order['fecha'].substr(5,2)+'/'+order['fecha'].substr(0,4);
                        
                        var fecha=fecha_php_a_castellano(order['fecha']);
                        var dia=fecha_php_a_castellano(order['dia']);
                        if (dia=='00/00/0000'){
                            dia=fecha;
                        }
                        
                        txt +='Pedido: <b>'+order['pedido']+'</b><br>Fecha: <b>'+dia+'</b>   (Realizado el '+fecha+' a las '+order['fecha'].substr(11,5)+') <br>Hora:<b> '+order['hora']+'</b><br>';
                        
                        //txt +='Pedido: <b>'+order['pedido']+'</b> Fecha: <b>'+fecha+'</b>'+anulado+'<br>';
                        
                        if (order['domicilio']['direccion']!=""){
                            txt +='ENVIADO A:<br>';
                            txt +=order['domicilio']['direccion']+'<br>';
                            if (order['domicilio']['complementario']!=""){
                                txt +=order['domicilio']['complementario']+'<br>';
                            }
                            txt +=order['domicilio']['cod_postal']+' - '+order['domicilio']['poblacion']+' ('+order['domicilio']['provincia']+')<br>';
                        }
                        else {
                            txt +='RECOGIDA EN LOCAL<br>';
                        }
                        txt+='<br><a href="#" class="button button-fill button-round" style="width:50%;margin:auto;" onclick="window.open(\'https://api.whatsapp.com/send?phone='+whatsapp+'&text=Hola, soy '+order['nombre']+' '+order['apellidos']+' y tengo dudas con respecto el pedido '+order['pedido']+' de fecha '+fecha+'\')" >¿Alguna duda? &nbsp; &nbsp; <img src="img/whatsapp.png" width="22" height="auto"/></a>';
                        txt+='<div class="card data-table">'+
                            '<table>'+
                                '<thead>'+
                                    '<tr>'+
                                        '<th class="numeric-cell">Cantidad</th>'+
                                        '<th class="label-cell">Articulo</th>'+
                                        '<th class="numeric-cell">Precio</th>'+
                                        '<th class="numeric-cell">Total</th>'+
                                    '</tr>'+
                                '</thead>'+
                                '<tbody>';
                                    
                        for(var x=0;x<carrito.length;x++){
                            txt+=''+
                                    '<tr>'+
                                        '<th class="numeric-cell">'+carrito[x]['cantidad']+'</th>'+
                                        '<th class="label-cell">'+carrito[x]['nombre']+'</th>'+
                                        '<th class="numeric-cell">'+parseFloat(carrito[x]['precio_sin']).toFixed(2)+'</th>'+
                                        '<th class="numeric-cell">'+parseFloat(carrito[x]['cantidad']*carrito[x]['precio']).toFixed(2)+'</th>'+
                                    '</tr>';

                            if (typeof carrito[x]['elmentosMenu']!='undefined'){
                                var txt_nom_menu='';   
                                for(var j=0;j<carrito[x]['elmentosMenu'].length;j++){
        if (carrito[x]['elmentosMenu'][j]['nomMenu']!=txt_nom_menu){
            txt_nom_menu=carrito[x]['elmentosMenu'][j]['nomMenu'];
            txt+=''+
        '<tr style="font-size:12px;">'+
            '<th class="numeric-cell"></th>'+
            '<th class="label-cell"><b>'+txt_nom_menu+'</b></th>'+
            '<th class="numeric-cell"></th>'+
            '<th class="numeric-cell"></th>'+
        '</tr>';
        }
                                    
                                    txt+=''+
                                    '<tr style="font-size:11px;font-style:italic;">'+
                                        '<th class="numeric-cell"></th>'+
                                        '<th class="label-cell">'+carrito[x]['elmentosMenu'][j]['cantidad']+' x '+carrito[x]['elmentosMenu'][j]['nombre']+'</th>'+
                                        '<th class="numeric-cell">'+parseFloat(carrito[x]['elmentosMenu'][j]['precio']).toFixed(2)+'</th>'+
                                        '<th class="numeric-cell"></th>'+
                                    '</tr>';
                                }
                            }   
                            if (typeof carrito[x]['modificadores']!='undefined'){
                                var txt_nom_menu='';   
                                for(var j=0;j<carrito[x]['modificadores'].length;j++){
        if (carrito[x]['modificadores'][j]['nom_cat']!=txt_nom_menu){
            txt_nom_menu=carrito[x]['modificadores'][j]['nom_cat'];
            txt+=''+
        '<tr style="font-size:12px;">'+
            '<th class="numeric-cell"></th>'+
            '<th class="label-cell"><b>'+txt_nom_menu+'</b></th>'+
            '<th class="numeric-cell"></th>'+
            '<th class="numeric-cell"></th>'+
        '</tr>';
        }
                                    txt+=''+
                                    '<tr style="font-size:11px;font-style:italic;">'+
                                        '<th class="numeric-cell"></th>'+
                                        '<th class="label-cell">'+carrito[x]['modificadores'][j]['nombre']+'</th>'+
                                        '<th class="numeric-cell">'+parseFloat(carrito[x]['modificadores'][j]['precio']).toFixed(2)+'</th>'+
                                        '<th class="numeric-cell"></th>'+
                                    '</tr>';
                                }
                            }      
                                
                        }
                        txt+=''+
                            '<tr>'+
                                '<th class="numeric-cell"></th>'+
                                '<th class="label-cell"></th>'+
                                '<th class="label-cell">Subtotal</th>'+
                                '<th class="numeric-cell">'+(parseFloat(order['subtotal'])).toFixed(2)+'</th>'+
                            '</tr>';
                        if (order['portes']>0){
                           txt+= '<tr>'+
                                '<th class="numeric-cell"></th>'+
                                '<th class="label-cell"></th>'+
                                '<th class="label-cell">Portes</th>'+
                                '<th class="numeric-cell">'+parseFloat(order['portes']).toFixed(2)+'</th>'+
                            '</tr>';
                        }      
                        if (order['descuento']>0){
                           txt+= '<tr>'+
                                '<th class="numeric-cell"></th>'+
                                '<th class="label-cell"></th>'+
                                '<th class="label-cell">Descuento</th>'+
                                '<th class="numeric-cell">'+parseFloat(order['descuento']).toFixed(2)+'</th>'+
                            '</tr>';
                        }
                         if (order['monedero']>0){
                           txt+= '<tr>'+
                                '<th class="numeric-cell"></th>'+
                                '<th class="label-cell"></th>'+
                                '<th class="label-cell">Monedero</th>'+
                                '<th class="numeric-cell">'+parseFloat(order['monedero']).toFixed(2)+'</th>'+
                            '</tr>';
                        }

                        /*
                        txt+='<tr>'+
                                    '<th class="numeric-cell"></th>'+
                                    '<th class="label-cell"></th>'+
                                    '<th class="label-cell">Impuestos</th>'+
                                    '<th class="numeric-cell">'+parseFloat(impuestos).toFixed(2)+'</th>'+
                                '</tr>';
                        */                                  
                        txt+='<tr>'+
                            '<th class="numeric-cell"></th>'+
                            '<th class="label-cell"></th>'+
                            '<th class="label-cell">Total</th>'+
                            '<th class="numeric-cell">'+parseFloat(order['total']).toFixed(2)+'</th>'+
                        '</tr>';  
                            
                        txt+=''+
                                '</tbody>'+
                            '</table><br><br>'+
                        '</div>';
                    }
                    $('#detallepedido').html(txt);
                },
                error: function (xhr, ajaxOptions, thrownError){
                    console.log(xhr.status);
                    console.log(thrownError);
                }
            });
            
            $('#detallepedido').html(txt);
         },
          opened: function (popup) {
            //console.log('Popup opened');
          },
        }
    });  

    dynamicPopup.open(); 
}

function volverapedir(idpedido){
    app.popup.close(); 

    var server=servidor+'includes/leeunpedidodatos.php';  
    $.ajax({
        url: server,
        data:{idpedido:idpedido,isApp:isApp},
        method: "post",
        dataType:"json",
        success: function(data){ 
            var obj=Object(data);   
            if (obj.valid==true){
                //console.log(obj.carrito);
                //var id=obj.id;
                var carrito2=obj.carrito;
            

                vaciarCarrito();
                carritoEdad=new Date();
                for(var x=0;x<carrito2.length;x++){
                    if (typeof carrito2[x]['modificadores'] !== "undefined") {
                        carrito.push({id:carrito2[x]['id'],nombre:carrito2[x]['nombre'],precio:parseFloat(carrito2[x]['precio']), precio_sin:parseFloat(carrito2[x]['precio_sin']),cantidad:parseFloat(carrito2[x]['cantidad']),iva:carrito2[x]['iva'],img:carrito2[x]['img'],menu:0,elmentMenu:0,comentario:carrito2[x]['comentario'],modificadores:carrito2[x]['modificadores'],categoria:carrito2[x]['categoria']});
                    }
                    else {
                        carrito.push({id:carrito2[x]['id'],nombre:carrito2[x]['nombre'],precio:parseFloat(carrito2[x]['precio']), precio_sin:parseFloat(carrito2[x]['precio_sin']),cantidad:parseFloat(carrito2[x]['cantidad']),iva:carrito2[x]['iva'],img:carrito2[x]['img'],menu:0,elmentMenu:0,comentario:carrito2[x]['comentario'],categoria:carrito2[x]['categoria']});
                    }
                    
                    
                }

                calcularTotal();
                guardarCarritoEnLocalStorage();
                renderizarCarrito();
                var txt='';
                txt+='<p>Pedido añadido al carrito</p>';
            

            }
        },
        error: function (xhr, ajaxOptions, thrownError){
            console.log(xhr.status);
            console.log(thrownError);
        }
    });

}

function buscalaspush(){
    var cliente=0;
    if (window.localStorage.getItem("registrado")=='si'){
        cliente=desencripta(window.localStorage.getItem("user"));
    }
    
    buscapush(cliente);
}


 function mirapushnouser(){
     //console.log('No user');
     var dynamicPopup = app.popup.create({
        content:  ''+
          '<div class="popup">'+
            '<div class="block page-content">'+
              '<p class="text-align-left"><a href="javascript:cierraEstePop();" class="link popup-close"><i class="icon f7-icons ">xmark</i></a></p>'+
                ' <div class="block-title block-title-medium">Notificaciones</div>'+
                '<div class="block" id="texto-push-nouser"><br></div>'+
            '</div>'+
          '</div>'
         ,
        // Events
        on: {
          open: function (popup) {
              
              buscapushnouser(0, 1);
              
              
          },
          opened: function (popup) {
          },
        }
        
    });  
    dynamicPopup.on('close', function (popup) {
      });
      dynamicPopup.on('closed', function (popup) {
      });
    dynamicPopup.open();
 }

function buscapush(cliente, pagina=1){
    var server=servidor+'includes/leepush.php';  
    $.ajax({
        url: server,
        data:{cliente:cliente,pagina:pagina},
        method: "post",
        dataType:"json",
        success: function(data){ 
            var obj=Object(data);
            if (obj.valid==true){
                var id=obj.id;
                var titulo=obj.titulo;
                var body=obj.body;
                var fecha=obj.fecha;
                var hora=obj.hora;
                var imagen=obj.imagen;
                var tipo=obj.tipo;

                //var total=obj.total;
                var numReg=obj.total;
                var paginas=numReg/5;
                var resto=numReg%5;
                var pagina_actual=pagina;
                if (pagina_actual==0){
                    //pagina_actual=1;
                }
                if (resto>0){
                    paginas=Math.trunc(paginas)+1;
                }
                
                //alert (paginas);
                var txt='';
                txt+='<div class="card data-table">'+
                            '<table>'+
                                '<thead>'+
                                    '<tr style="background-color: var(--f7-theme-color);">'+
                                        '<th class="label-cell" style="color:white;">Fecha</th>'+
                                        '<th class="label-cell" style="color:white;">Texto</th>'+
                                    '</tr>'+
                                '</thead>'+
                                '<tbody>';
              
                
                for (x=0;x<id.length;x++){
                    
                    //<tbody id="tabla-pedidos">
                    fecha[x]=fecha[x].substr(8,2)+'/'+fecha[x].substr(5,2)+'/'+fecha[x].substr(0,4);
                    
                    txt+=
                        '<tr onclick="verpush(\''+id[x]+'\',\''+titulo[x]+'\',\''+body[x]+'\',\''+fecha[x]+'\',\''+hora[x]+'\',\''+tipo[x]+'\',\''+imagen[x]+'\');" style="font-size:12px;">'+
                            '<th class="label-cell">'+fecha[x]+'</th>'+
                             '<th class="label-cell">'+titulo[x]+'</th>'+
                        '</tr>';
 
                } 
                txt+='</tbody">'+
                    '</table>';
                var txt_pie="";
                txt_pie+=""+
                    '<div class="data-table-rows-select">Paginas:'+paginas+'</div>'+
                    '<div class="data-table-pagination">'+
                    '<span class="data-table-pagination-label">'+pagina+' de '+paginas+'</span>';
                
            
                var anterior="";
                var siguiente="";
                
                    if (paginas>1){
                        
                        if (pagina>1){
                            
                            txt_pie+='<a href="#" onclick=" buscapush('+cliente+','+(pagina-1)+');"class="link"><i class="icon icon-prev color-gray"></i></a>';
                        }
                        else {
                            txt_pie+='<a href="#" class="link disabled"><i class="icon icon-prev color-gray"></i></a>';
                        }
                        
                        if (pagina<(paginas)){
                            
                            txt_pie+='<a href="#" onclick="buscapush('+cliente+','+(pagina+1)+');"class="link"><i class="icon icon-next color-gray"></i></a>';
                        }
                        else {
                            txt_pie+='<a href="#" class="link disabled"><i class="icon icon-next color-gray"></i></a>';
                        }

                    }             
                    
                    txt_pie+='</div>';
                $('#page-more').html('<div class="block-title" style="margin-top: 0;margin-bottom: 20px;color: var(--primario);">Mis notificaciones</div>'+txt+txt_pie);  
                $('#icon-back-more').show();   
                document.getElementById("link-volver-more").href = 'javascript:mostrarMasDatos();';
                
               
                var ahoramismo=new Date();
                window.localStorage.setItem("fecha_hora_actual",ahoramismo.getFullYear()+'-'+(ahoramismo.getMonth()+1)+'-'+ahoramismo.getDate()+' '+ahoramismo.getHours()+':'+String(ahoramismo.getMinutes()).padStart(2, '0')+':00');

                //$('#ver-alertas-usu').html(txt+txt_pie);  
                $('.badage-noti-usu').html('');
                $('.badage-noti-usu').hide();
                $('.badage-noti-nousu').html('');
                $('.badage-noti-nousu').hide();

            }
            else {
                $('#ver-alertas-usu').html('No tiene mensajes.');
            }
        }
    });      
}

function buscapushnouser(cliente, pagina=1){
    var server=servidor+'includes/leepush.php';  
    $.ajax({
        url: server,
        data:{cliente:cliente,pagina:pagina},
        method: "post",
        dataType:"json",
        success: function(data){ 
            var obj=Object(data);
            if (obj.valid==true){
                var id=obj.id;
                var titulo=obj.titulo;
                var body=obj.body;
                var fecha=obj.fecha;
                var hora=obj.hora;
                var imagen=obj.imagen;
                var tipo=obj.tipo;

                //var total=obj.total;
                var numReg=obj.total;
                var paginas=numReg/5;
                var resto=numReg%5;
                var pagina_actual=pagina;
                if (pagina_actual==0){
                    //pagina_actual=1;
                }
                if (resto>0){
                    paginas=Math.trunc(paginas)+1;
                }
                
                //alert (paginas);
                var txt='';
                txt+='<div class="card data-table">'+
                            '<table>'+
                                '<thead>'+
                                    '<tr style="background-color: var(--f7-theme-color);">'+
                                        '<th class="label-cell" style="color:white;">Fecha</th>'+
                                        '<th class="label-cell" style="color:white;">Texto</th>'+
                                    '</tr>'+
                                '</thead>'+
                                '<tbody>';
              
                
                for (x=0;x<id.length;x++){
                    
                    //<tbody id="tabla-pedidos">
                    fecha[x]=fecha[x].substr(8,2)+'/'+fecha[x].substr(5,2)+'/'+fecha[x].substr(0,4);
                    
                    txt+=
                        '<tr onclick="verpush(\''+id[x]+'\',\''+titulo[x]+'\',\''+body[x]+'\',\''+fecha[x]+'\',\''+hora[x]+'\',\''+tipo[x]+'\',\''+imagen[x]+'\');" style="font-size:12px;">'+
                            '<th class="label-cell">'+fecha[x]+'</th>'+
                             '<th class="label-cell">'+titulo[x]+'</th>'+
                        '</tr>';
 
                } 
                txt+='</tbody">'+
                    '</table>';
                var txt_pie="";
                txt_pie+=""+
                    '<div class="data-table-rows-select">Paginas:'+paginas+'</div>'+
                    '<div class="data-table-pagination">'+
                    '<span class="data-table-pagination-label">'+pagina+' de '+paginas+'</span>';
                
            
                var anterior="";
                var siguiente="";
                
                    if (paginas>1){
                        
                        if (pagina>1){
                            
                            txt_pie+='<a href="#" onclick=" buscapush('+cliente+','+(pagina-1)+');"class="link"><i class="icon icon-prev color-gray"></i></a>';
                        }
                        else {
                            txt_pie+='<a href="#" class="link disabled"><i class="icon icon-prev color-gray"></i></a>';
                        }
                        
                        if (pagina<(paginas)){
                            
                            txt_pie+='<a href="#" onclick="buscapush('+cliente+','+(pagina+1)+');"class="link"><i class="icon icon-next color-gray"></i></a>';
                        }
                        else {
                            txt_pie+='<a href="#" class="link disabled"><i class="icon icon-next color-gray"></i></a>';
                        }

                    }             
                    
                    txt_pie+='</div>';
                
                $('#texto-push-nouser').html(txt+txt_pie);  
                  
                
                
               
                var ahoramismo=new Date();
                window.localStorage.setItem("fecha_hora_actual",ahoramismo.getFullYear()+'-'+(ahoramismo.getMonth()+1)+'-'+ahoramismo.getDate()+' '+ahoramismo.getHours()+':'+String(ahoramismo.getMinutes()).padStart(2, '0')+':00');

                //$('#ver-alertas-usu').html(txt+txt_pie);  
                $('.badage-noti-usu').html('');
                $('.badage-noti-usu').hide();
                $('.badage-noti-nousu').html('');
                $('.badage-noti-nousu').hide();

            }
            
        }
    });      
}


function verpush(id, titulo, body, fecha, hora, tipo, imagen){
   
    if (imagen!=""){
        body+='<br><br><div style="text-align:center;"><img src="'+servidor+'img/upload/'+imagen+'" width="90%" height="auto"></div>';
    }
   var not=app.notification.create({
                   // myApp.alert('<b>'+data.title+'</b>.<br>'+data.message, 'Atención');

            icon: '<img src="img/icon.png" width="22px" height="auto">',
            title: app.name,
            subtitle: titulo,
            closeButton: true,
            titleRightText: fecha+' ('+hora+')',
            //subtitle: 'Notificación con cierre con clic',
            text: body,
            closeOnClick: true,
            //closeTimeout:5000,
            on: {
                close: function () {
                    
                    
                    not.$el.remove();
                    
                                     
              //app.dialog.alert('Notificación cerrada');
                },
            },
        });
        not.open(); 
    
}

if ("fecha_hora_actual" in localStorage) {
   
} else {
     var ahoramismo=new Date();
    window.localStorage.setItem("fecha_hora_actual",ahoramismo.getFullYear()+'-'+(ahoramismo.getMonth()+1)+'-'+ahoramismo.getDate()+' '+ahoramismo.getHours()+':'+String(ahoramismo.getMinutes()).padStart(2, '0')+':00');

}

setInterval(MirarHora,300000); // cada 5 min


function MirarHora(){
    var cliente=0;
    if (window.localStorage.getItem("registrado")=='si'){
        cliente=desencripta(window.localStorage.getItem("user"));
    }
    if ("fecha_hora_actual" in localStorage) {
   
    } else {
         var ahoramismo=new Date();

         window.localStorage.setItem("fecha_hora_actual",ahoramismo.getFullYear()+'-'+(ahoramismo.getMonth()+1)+'-'+ahoramismo.getDate()+' '+ahoramismo.getHours()+':'+String(ahoramismo.getMinutes()).padStart(2, '0')+':00');

    }
    
    var server=servidor+'includes/leepushnuevas.php';  
     $.ajax({
        url: server,
        data:{cliente:cliente, fecha:window.localStorage.getItem("fecha_hora_actual") },
        method: "post",
        dataType:"json",
        success: function(data){ 
            var obj=Object(data);
            if (obj.valid==true){   
                var total=parseInt(obj.total); 
                //console.log('Noti:'+total);
                $('.badage-noti-usu').hide();
                $('.badage-noti-nousu').hide();
                if(total>0) {
                    $('.badage-noti-usu').html(total);
                    $('.badage-noti-nousu').html(total);
                    if (window.localStorage.getItem('user') !== undefined && window.localStorage.getItem('user')) {
                        $('.badage-noti-usu').show();
                        $('.badge').css('background-color',colorsecundario);
                    }else {
                        $('.badage-noti-nousu').show();
                        $('.badge').css('background-color',colorsecundario);
                    }
        
                }
                
            }
        },error:function(e){
            console.log('Error');
        }
     });
    

    
}

function fecha_php_a_castellano(fecha){
    var devuelve='00/00/0000';
    if (fecha!=null){
        devuelve=fecha.substr(8,2)+'/'+fecha.substr(5,2)+'/'+fecha.substr(0,4);
    }
    return devuelve;
}
