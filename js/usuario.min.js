/**
 * Archivo: usuario.min.js
 *
 * Version: 1.0.3
 * Fecha  : 29/09/2023
 *
 * © Manuel Sánchez (www.elmaestroweb.es)
 *
*/

var registrado="no";
window.localStorage.removeItem("registrado"); 
window.localStorage.removeItem("username"); 
window.localStorage.removeItem("user"); 


if (window.localStorage.getItem("registrado")!=null) {
    registrado=desencripta(window.localStorage.getItem("registrado"));
}
else {
    window.localStorage.setItem("registrado",encripta("no"));
    registrado='no';		
}
if (window.localStorage.getItem("username")!=null) {
    //registrado=window.localStorage.getItem("username");
}
else {
    window.localStorage.setItem("username","");	
}

if (registrado=="no"){
    //loginUsuario();  
    $('#login-inicio').show();
    mostrarMasDatos();
}
else {
    
    var server=servidor+'includes/login2.php';
    var username=desencripta(window.localStorage.getItem("username"));
    $.ajax({
        url: server,
        data:{ username:username },
        method: "post",
        dataType:"json",
        success: function(data){ 
            var obj=Object(data);
            if (obj.valid==true){
                
                window.localStorage.setItem("registrado",encripta("si"));
                window.localStorage.setItem("username",encripta(username));
                $('#login-inicio').hide();
                $('#usu-inicio').show();
                //$('#ver-info-usu').html(formUsu);
                $('#my-form-usu input[name*="id"]').val(obj.id);
                window.localStorage.setItem("user",encripta(obj.id));
                $('#my-form-usu input[name*="nombre"]').val(obj.nombre);
                $('#my-form-usu input[name*="apellidos"]').val(obj.apellidos);
                var nacimiento=obj.nacimiento;
                $('#my-form-usu input[name*="nacimiento1"]').val(nacimiento);
                //$('#calendar-nacimiento-user').val(obj.nacimiento);
                //console.log($('#calendar-nacimiento-user').val());
                $('#my-form-usu input[name*="telefono"]').val(obj.telefono);
                //$('#my-form-usu input[name*="tratamiento"]').attr('checked', false);
                $('#my-form-usu input[name*="tratamiento"][value="'+obj.tratamiento+'"]').attr('checked', true);
                if(obj.publicidad=='1'){
                   $('#my-form-usu input[name*="publi-checkbox"]').attr('checked', true); 
                }
                $('#my-form-usu input[name*="privacidad-checkbox"]').prop('checked', false); 
                $('#my-form-usu input[name*="email"]').val(username);
                $('#my-form-usu input[name*="pass"]').val('');
                $('#my-form-usu input[name*="pass2"]').val('');
                 window.localStorage.setItem("mi_monedero",encripta(obj.monedero));
                
                if (obj.monedero_activo=='1'){
                    window.localStorage.setItem("porcentaje_fidelizacion",encripta(obj.porcentaje));
                }
               // console.log('%Fide:'+desencripta(window.localStorage.getItem("porcentaje_fidelizacion")));
                if(isApp==true){                
                    var server=servidor+'includesapp/actualizacion_telefono.php';  
                    var fabricante = device.manufacturer;
                    var modelo = device.model;
                    var plataforma = device.platform;
                    var version = device.version;
                    var idtel=window.localStorage.getItem("idtel");

                    app.request.postJSON(server, { idtel:idtel, plataforma:plataforma, version:version, fabricante:fabricante, modelo:modelo, user:obj.id, push:window.localStorage.getItem("estado_push")}, 
                        function (data) {
                            var obj=Object(data);
                            if (obj.valid==true){
                                window.localStorage.setItem("telefono_registrado","si");	
                            }
                        },
                        function (xhr, status) {
                    });                         
                } 
                $('#page-usu-datos').show(); 
                
            
                $('#nombre-usu').html(obj.nombre);
                if(fidelizacion==1){
                    $('#mi-monedero').show();
                    $('#importe-mi-monedero').html('<b>'+obj.monedero+'</b> €');            
                }
                mostrarMasDatos();
                calendarNacimiento2 = app.calendar.create({
                    inputEl: '#calendar-nacimiento-user',
                    value: [new Date(nacimiento.substr(6,4), parseInt(nacimiento.substr(3,2))-1, nacimiento.substr(0,2))],
                    openIn: 'customModal',
                    toolbarCloseText:'Ok',
                    //header: true,
                    closeOnSelect:true,
                    dateFormat: 'dd/mm/yyyy'
                    //footer: true,
                });
                
            }
        }
    });
    
}

$('#my-login-screen .login-button').on('click', function () {
    var username = $('#my-login-screen [name="username"]').val();
    var password = $('#my-login-screen [name="password"]').val();

    var server=servidor+'includes/login.php';
    $.ajax({
        url: server,
        data:{ username:username, password: password },
        method: "post",
        dataType:"json",
        success: function(data){ 
            var obj=Object(data);
            if (obj.valid==true){
                $('.badage-noti-nousu').hide();
                var nacimiento=obj.nacimiento;
                window.localStorage.setItem("registrado",encripta("si"));
                window.localStorage.setItem("username",encripta(username));
                $('#login-inicio').hide();
                 
                $('#my-form-usu input[name*="id"]').val(obj.id);
                window.localStorage.setItem("user",encripta(obj.id));
                $('#my-form-usu input[name*="nombre"]').val(obj.nombre);
                $('#my-form-usu input[name*="apellidos"]').val(obj.apellidos);
                $('#my-form-usu input[name*="nacimiento1"]').val(obj.nacimiento);
                $('#my-form-usu input[name*="telefono"]').val(obj.telefono);
                //$('#my-form-usu input[name*="tratamiento"]').attr('checked', false);
                $('#my-form-usu input[name*="tratamiento"][value="'+obj.tratamiento+'"]').attr('checked', true);
                if(obj.publicidad=='1'){
                   $('#my-form-usu input[name*="publi-checkbox"]').attr('checked', true); 
                }
                $('#my-form-usu input[name*="email"]').val(username);
                $('#my-form-usu input[name*="pass"]').val('');
                $('#my-form-usu input[name*="pass2"]').val('');
                 window.localStorage.setItem("mi_monedero",encripta(obj.monedero));
                if (obj.monedero_activo=='1'){
                    window.localStorage.setItem("porcentaje_fidelizacion",encripta(obj.porcentaje));
                }
                
                
                if(isApp==true){                
                    var server=servidor+'includesapp/actualizacion_telefono.php';  
                    var fabricante = device.manufacturer;
                    var modelo = device.model;
                    var plataforma = device.platform;
                    var version = device.version;
                    var idtel=window.localStorage.getItem("idtel");
                    app.request.postJSON(server, { idtel:idtel, plataforma:plataforma, version:version, fabricante:fabricante, modelo:modelo, user:obj.id, push:window.localStorage.getItem("estado_push")}, 
                        function (data) {
                            app.dialog.close();
                            var obj=Object(data);
                            if (obj.valid==true){
                                window.localStorage.setItem("telefono_registrado","si");	
                            }
                        },
                        function (xhr, status) {
                    });                         
                }
                else {
                    /*
                    var token=window.localStorage.getItem("token");
                    if (token!=''){
                        guardaToken(token);
                    }
                    */

                }
                $('#usu-inicio').show(); 
                
                $('#nombre-usu').html(obj.nombre);
                if(fidelizacion==1){
                    $('#mi-monedero').show();
                    $('#importe-mi-monedero').html('<b>'+obj.monedero+'</b> €');            
                }
                mostrarMasDatos();
                //console.log('Mas datos');
                /*
                calendarNacimiento2 = app.calendar.create({
                    inputEl: '#calendar-nacimiento-user',
                    value: [new Date(nacimiento.substr(6,4), parseInt(nacimiento.substr(3,2))-1, nacimiento.substr(0,2))],
                    openIn: 'customModal',
                    //header: true,
                    closeOnSelect:true,
                    dateFormat: 'dd/mm/yyyy'
                    //footer: true,
                });
                */
                
                
            }
            else{
                $('#error-login').show();
            }
            
        }
    });
  

 });

$('#guarda-datos-usuario').on('click', function () {
    //my-form-usu
    
    var formData = app.form.convertToData('#my-form-usu');
    var id=formData['id'];
    var tratamiento=formData['tratamiento'];
    var nombre=formData['nombre'];
    var apellidos=formData['apellidos'];
    var nacimiento=formData['nacimiento1'];
    var telefono=formData['telefono'];
    var usuario=formData['email'];
    var pass=formData['pass'];
    var pass2=formData['pass2'];
    var publi=formData['publi-checkbox'];

    if (publi!='1'){
        publi='0';  
    }

    var acepto=formData['privacidad-checkbox'];
  
    var errores="";
    if (nombre==''){
        errores+='Nombre, ';
    }
    if (apellidos==''){
        errores+='Apellidos, ';
    }
    if (usuario==''){
        errores+='email, ';
    }
    
    if (acepto.length==0){
        errores+='aceptar la Política de privacidad, ';
    }
    if(pass!=pass2){
       errores+='las contraseñas no coinciden'; 
    }
    if (errores!=''){
        errores = 'Debe completar '+errores.substring(0, errores.length - 2)+'.';
        app.dialog.alert(errores);
    }
    else {
        var server=servidor+'includes/guardausuario2.php';
        $.ajax({
            url: server,
            data:{nombre:nombre, apellidos:apellidos,nacimiento:nacimiento, telefono:telefono, usuario:usuario, pass:pass, publi:parseInt(publi), tratamiento:tratamiento, id:id},
            method: "post",
            dataType:"json",
            success: function(data){ 
                var obj=Object(data);
                if (obj.valid==true){
                    
                    window.localStorage.setItem("username",encripta(usuario));
                    window.localStorage.setItem("user",encripta(id));
                    
                    $('#my-form-usu input[name*="id"]').val(id);
                    $('#my-form-usu input[name*="nombre"]').val(nombre);
                    $('#my-form-usu input[name*="apellidos"]').val(apellidos);
                    $('#my-form-usu input[name*="nacimiento"]').val(nacimiento);
                    $('#my-form-usu input[name*="telefono"]').val(telefono);
                    
                    $('#my-form-usu input[name*="tratamiento"][value="'+obj.tratamiento+'"]').attr('checked', true);
                    if(publi=='1'){
                       $('#my-form-usu input[name*="publi-checkbox"]').attr('checked', true); 
                    }
                    $('#my-form-usu input[name*="privacidad-checkbox"]').prop('checked', false); 
                    OcultaClave('campo-clave3');
                    OcultaClave('campo-clave4');
                    
                    $('#my-form-usu input[name*="email"]').val(desencripta(window.localStorage.getItem("username")));
                    $('#my-form-usu input[name*="pass"]').val('');
                    $('#my-form-usu input[name*="pass2"]').val('');  
                    $('#id-tratamiento').hide();
                    $('#id-clave1').hide();
                    $('#id-clave2').hide();
                    $('#id-ofertas').hide();
                    $('#id-politicas').hide();
                    $('#guarda-datos-usuario').hide();
                    $('#cancela-datos-usuario').hide();
                    $('#editar-perfil').show();
                    $('#titulo-usuario').show();
                    $('#my-form-usu input[name*="nombre"]').prop('disabled', true);
                    $('#my-form-usu input[name*="apellidos"]').prop('disabled', true);
                    $('#my-form-usu input[name*="nacimiento1"]').prop('disabled', true);
                    $('#my-form-usu input[name*="telefono"]').prop('disabled', true);
                    $('#my-form-usu input[name*="email"]').prop('disabled', true);                
                    app.calendar.destroy('#calendar-nacimiento-user');
                    if(fidelizacion==1){
                        $('#mi-monedero').show();
                    }
                }
                else{
                    if (obj.existe==true){
                        muestraMensaje('Ya existe usuario con ese email.',titulo='',subtitulo='Error');
                    }
                    else {
                        muestraMensaje('No se pudo modificar usuario.',titulo='',subtitulo='Error');
                    }
                }
            }
        });               
        
    }
    
});

$('#editar-perfil').on('click', function () {
    if(fidelizacion==1){
        $('#mi-monedero').hide();
    }
    $('#id-tratamiento').show();
    $('#id-clave1').show();
    $('#id-clave2').show();
    $('#id-ofertas').show();
    $('#id-politicas').show();
    $('#guarda-datos-usuario').show();
    $('#cancela-datos-usuario').show();
    $('#editar-perfil').hide();
    $('#titulo-usuario').hide();
    var nacimiento=$('#my-form-usu input[name*="nacimiento"]').val();
    $('#my-form-usu input[name*="nombre"]').prop('disabled', false);
    $('#my-form-usu input[name*="apellidos"]').prop('disabled', false);
    $('#my-form-usu input[name*="nacimiento1"]').prop('disabled', false);
    var calendarNacimiento5 = app.calendar.create({
        inputEl: '#calendar-nacimiento-user',
        value: [new Date(nacimiento.substr(6,4), parseInt(nacimiento.substr(3,2))-1, nacimiento.substr(0,2))],
        openIn: 'customModal',
        toolbarCloseText:'Ok',
        //header: true,
        closeOnSelect:true,
        dateFormat: 'dd/mm/yyyy'
        //footer: true,
    });
    $('#my-form-usu input[name*="telefono"]').prop('disabled', false);
    $('#my-form-usu input[name*="email"]').prop('disabled', false);
});

$('#cancela-datos-usuario').on('click', function () {
    if(fidelizacion==1){
        $('#mi-monedero').show();
    }
    $('#id-tratamiento').hide();
    $('#id-clave1').hide();
    $('#id-clave2').hide();
    $('#id-ofertas').hide();
    $('#id-politicas').hide();
    $('#guarda-datos-usuario').hide();
    $('#cancela-datos-usuario').hide();
    $('#editar-perfil').show();
    $('#titulo-usuario').show();
    $('#my-form-usu input[name*="nombre"]').prop('disabled', true);
    $('#my-form-usu input[name*="apellidos"]').prop('disabled', true);
    $('#my-form-usu input[name*="nacimiento1"]').prop('disabled', true);
    
    $('#my-form-usu input[name*="telefono"]').prop('disabled', true);
    $('#my-form-usu input[name*="email"]').prop('disabled', true);
});

$('#cancela-datos-usuario-nuevo').on('click', function () {
    $('#login-inicio').show();
    $('#usu-nuevo').hide();
});

$('#lee-politica').on('click', function () {
    leePolitica();      
});

$('#crear-nuevo-usuario').on('click', function () {
    var formData = app.form.convertToData('#my-form');
    var tratamiento=formData['tratamiento'];
    var nombre=formData['nombre'];
    var apellidos=formData['apellidos'];
    var nacimiento=formData['nacimiento2'];
    //console.log(nacimiento);
    var telefono=formData['telefono'];
    var usuario=formData['email'];
    var pass=formData['pass'];
    var publi=formData['publi-checkbox'];
    if (publi!='1'){
        publi='0';  
    }
    var acepto=formData['privacidad-checkbox'];
    var errores="";
    if (nombre==''){
        errores+='Nombre, ';
    }
    if (apellidos==''){
        errores+='Apellidos, ';
    }
    if (telefono==''){
        errores+='Teléfono, ';
    }
    if (usuario==''){
        errores+='email, ';
    }
    if (pass==''){
        errores+='contraseña, ';
    }
    if (acepto==''){
        errores+='aceptar la Política de privacidad, ';
    }
    if (errores!=''){
        errores = 'Debe completar '+errores.substring(0, errores.length - 2)+'.';
        app.dialog.alert(errores);
    }
    else {
        //envio
        //console.log(tratamiento+' '+nombre+' '+apellidos+' '+usuario+' '+pass);
        //app.dialog.alert('publi:'+(parseInt(publi)+1));
        
        var server=servidor+'includes/guardausuario.php';
        $.ajax({
            url: server,
            data:{nombre:nombre, apellidos:apellidos, nacimiento:nacimiento, telefono:telefono, usuario:usuario, pass:pass, publi:parseInt(publi), tratamiento:tratamiento},
            method: "post",
            dataType:"json",
            success: function(data){ 
                var obj=Object(data);
                if (obj.valid==true){
                    window.localStorage.setItem("registrado",encripta("si"));
                    window.localStorage.setItem("username",encripta(usuario));
                    window.localStorage.setItem("user",encripta(obj.id));
                    //$('#usu-nuevo').hide();
                    //$('#user-page').show();
                    $('#usu-nuevo').hide();
                    $('#usu-inicio').show();  
                    
                    $('#nombre-usu').html(nombre);
                    $('#my-form-usu input[name*="id"]').val(obj.id);
                    $('#my-form-usu input[name*="nombre"]').val(nombre);
                    $('#my-form-usu input[name*="apellidos"]').val(apellidos);
                    $('#my-form-usu input[name*="nacimiento"]').val(nacimiento);
                    $('#my-form-usu input[name*="telefono"]').val(telefono);
                    //$('#my-form-usu input[name*="tratamiento"]').attr('checked', false);
                    
                    $('#my-form-usu input[name*="tratamiento"][value="'+obj.tratamiento+'"]').attr('checked', true);
                    if(publi=='1'){
                       $('#my-form-usu input[name*="publi-checkbox"]').attr('checked', true); 
                    }
                    $('#my-form-usu input[name*="email"]').val(usuario);
                    $('#my-form-usu input[name*="pass"]').val('');
                    $('#my-form-usu input[name*="pass2"]').val('');
                    
                    $('#my-form input[name*="nombre"]').val('');
                    $('#my-form input[name*="apellidos"]').val('');
                    $('#my-form input[name*="nacimiento2"]').val('');
                    $('#my-form input[name*="telefono"]').val('');
                    $('#my-form input[name*="email"]').val('');
                    $('#my-form input[name*="pass"]').val('');
                    
                    enviaemail('nuevo',usuario);                  
                    if(isApp==true){                
                        var server=servidor+'includesapp/actualizacion_telefono.php';  
                        var fabricante = device.manufacturer;
                        var modelo = device.model;
                        var plataforma = device.platform;
                        var version = device.version;
                        var idtel=window.localStorage.getItem("idtel");

                        app.request.postJSON(server, { idtel:idtel, plataforma:plataforma, version:version, fabricante:fabricante, modelo:modelo, user:obj.id, push:window.localStorage.getItem("estado_push")}, 
                            function (data) {
                               
                                var obj=Object(data);
                                if (obj.valid==true){
                                    window.localStorage.setItem("telefono_registrado","si");	
                                }

                            },
                            function (xhr, status) {
                        });                         
                    }    
                    else {
                        var token=window.localStorage.getItem("token");
                        if (token!=''){
                            guardaToken(token);
                        }
                        
                    }
                        muestraMensaje('Registro completado con exito',titulo='',subtitulo='Enhorabuena');
                    mostrarMasDatos();
                    
                }
                else{
                    if (obj.existe==true){
                        muestraMensaje('Ya existe usuario con ese email.',titulo='',subtitulo='Error');
                        
                    }
                    else {
                        muestraMensaje('No se pudo crear usuario.',titulo='',subtitulo='Error');
                    }
                }
            }
        });         

    }
});


$('#login-usu-existe').on('click', function () {
    $('#login-inicio').show();
    $('#usu-nuevo').hide();    
});

$('#cerrar-sesion').on('click', function () {
    window.localStorage.setItem("registrado",encripta("no"));
    window.localStorage.setItem("username",''); 
    window.localStorage.setItem("user",''); 
    window.localStorage.setItem("mi_monedero",encripta('0')); 
    //leeempresa();
    $('#login-inicio').show();
    $('#usu-inicio').hide();
    if ($('.badage-noti-usu').html()!=''){
        $('.badage-noti-usu').hide();
        $('.badage-noti-nousu').show();
    }
    //location.href='index.html';
});

$('#crear-usuario').on('click', function () {
    $('#login-inicio').hide();
    $('#usu-nuevo').show(); 
    var start = new Date();
   
    var nacimiento=start.setFullYear(start.getFullYear()-18);
        //f.getDate() + "-"+ f.getMonth()+ "-" +f.getFullYear();
//app.calendar.destroy('#calendar-nacimiento-user');
    calendarNacimiento3 = app.calendar.create({
        inputEl: '#calendar-nacimiento-new',
        value: [nacimiento],
        openIn: 'customModal',
        toolbarCloseText:'Ok',
        //header: true,
        closeOnSelect:true,
        dateFormat: 'dd/mm/yyyy'
        //footer: true,
    });
    
});

function enviaemail(tipo,usuario){
    var server=servidor+'includes/envioemail.php';  
    $.ajax({
        url: server,
        data:{tipo:tipo,usuario:usuario},
        method: "post",
        dataType:"json",
        success: function(data){ 
            var obj=Object(data);
            if (obj.valid==true){
                muestraMensaje('Se le ha enviado email con sus datos de acceso.',titulo='',subtitulo='Email');     
            }
            else {
                
            }   
        }
    }); 
    
}

function muestraOcultaClave(e){
    //console.log(e);
    var x = document.getElementById(e);
    if (x != null){
        if (x.type === "password"){
            $('.'+e).html('eye');
            x.type = "text";
        }
        else {
            $('.'+e).html('eye_slash');
            x.type = "password";
        }
    }        
}

function OcultaClave(e){
    var x = document.getElementById(e);
    if (x != null){
        $('.'+e).html('eye_slash');
        x.type = "password";
    }        
}

function RecuperarClave(){
    app.dialog.prompt('Introduzca su email', function (name) {
        if(validarEmail(name)) {
            // correcto
            
            var server=servidor+'includes/envioemail.php';  
            $.ajax({
                url: server,
                data:{mail:name,tipo:'recupera'},
                method: "post",
                dataType:"json",
                success: function(data){ 
                    var obj=Object(data);
                    if (obj.valid==true){
                       muestraMensaje(obj.msg,titulo='',subtitulo='Revise su correo');
                    }
                    else {	
                        muestraMensaje(obj.msg,titulo='',subtitulo='Atención');
                    }
                },
                error: function (xhr, ajaxOptions, thrownError){
                    console.log(xhr.status);
                    console.log(thrownError);
                  }
            });        
            
        }
        else {
             muestraMensaje('Email erroneo',titulo='',subtitulo='ERROR'); 
          
        }
    });
}

function validarEmail(valor) {
    emailRegex =/^(?:[^<>()[\].,;:\s@"]+(\.[^<>()[\].,;:\s@"]+)*|"[^\n"]+")@(?:[^<>()[\].,;:\s@"]+\.)+[^<>()[\]\.,;:\s@"]{2,63}$/i;
    //Se muestra un texto a modo de ejemplo, luego va a ser un icono
    if (emailRegex.test(valor)) {
        return true;
      
    } 
    else {
        return false;
    }
    
}

function leePolitica(){
    leetexto('Política de Privacidad','privacidad.txt');
}