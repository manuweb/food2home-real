/**
 * Archivo: app.js
 *
 * Version: 1.0.4
 * Fecha  : 04/01/2024
 *
 * © Manuel Sánchez (www.elmaestroweb.es)
 *
*/


var $ = Dom7;

var device = Framework7.getDevice();

var isApp=false;

var app_version = "2.00";
var colorprimario='';
var colorsecundario='';
var modooscuro=0;
var fidelizacion=0;
var por_fidelizacion=0;
var breadcrumbs=0;
var tiempoenvio=0;
var cortesia=0;
var integracion=1;
var pedidominimo=0;
var nameBreadcum='Carta';
var idRedys=0;

var app = new Framework7({
  name: 'Demo Revo', // App name
  theme: 'ios', // Automatic theme detection
  el: '#app', // App root element
  buttonCancel: 'Cancelar',
  id: 'com.manuweb.clouddelivery', // App bundle ID
  // Cordova Statusbar settings
  statusbar: {
    iosOverlaysWebView: false,
    androidOverlaysWebView: false,
    iosTextColor: 'black',
    androidTextColor: 'black',
  },
  dialog: {
        // set default title for all dialog shortcuts
        //title: 'Demo Revo',
        // change default "OK" button text
        //color: '#FF5F00',
        buttonCancel: 'Cancelar',
      },
  smartSelect:{
        popupCloseLinkText: 'Cerrar' ,
        //closeOnSelect: true,
    }, 
  on: {
      init: function () {
          
          window.jQuery = jQuery;
          window.$ = jQuery;
          leeestilos();
          if(isApp){
              $('#app').show();
          }
          else {
                $('#splash').show();
              
                setTimeout(function(){
                    if (navigator.userAgent.match(/Android/i) || navigator.userAgent.match(/webOS/i) || navigator.userAgent.match(/iPhone/i) || navigator.userAgent.match(/iPad/i) || navigator.userAgent.match(/iPod/i) || navigator.userAgent.match(/BlackBerry/i) || navigator.userAgent.match(/Windows Phone/i) || window.innerWidth <= 780) {
                       
                        var filename='css/addtohomescreen.min.css';
                        var fileref = document.createElement('link');

                        fileref.setAttribute("rel", "stylesheet");
                        fileref.setAttribute("type", "text/css");
                        fileref.setAttribute("href", filename)  ;
                        document.getElementsByTagName("head")[0].appendChild(fileref);
                        filename='js/addtohomescreen.min.js';
                        fileref = document.createElement('script');
                        fileref.setAttribute("type", "text/javascript");
                        fileref.setAttribute("src", filename);
                        document.getElementsByTagName("head")[0].appendChild(fileref);
                        
                        setTimeout(function(){
                            //console.log('addtohomescreen');
                            addToHomescreen({
                                startDelay: 3
                            });
                        } , 2000);   
                       
                        
                        
                        $('#splash').hide();
                        $('#app').show();
                        
                        
	                   }
                    else{
                        //console.log('Pantalla grande');
                        /*
                        $('#splash').hide();
                        $('#app').show();                        
                        app.dialog.confirm('Esta <b>web/app</b> está diseñada para ver en <b>dispositivos mobiles</b>.<br><br>Si continua será funcional pero puede que no se vea correctamente.<br><br><b>¿Desea verla así de todos modos?</b>','¡Atención!',function () {
                            $('#splash').hide();
                            $('.dialog-backdrop').css('background','rgba(0,0,0,.4)');
                        },function () {
                            $('#splash').show()
                            $('#app').hide();
                        });
                        
                        $('.dialog-backdrop').css('background','rgba(0,0,0,.9)');
                        */
                        location.href='index2.html';
                        

                    }
                    
                    //alert(getCurrentElementInFullScreen());
                }, 2000);
              
          }
          

   
         
        window.history.pushState('forward', null, './');
        window.onpopstate = function() {
            //alert('Back');
        window.history.pushState(null, null, './');   
        
        };
      },
  },
});

var whatsapp='';
var portesgratis=0;
var maximocarrito=0;
var reglamaximo=new Array();;
var tipo_repartos=0;
var importeportesgratis=0;
var portesgratismensaje=0;
var norepartomensaje='';
var tipo_seleccion_horas=0;
var dias_vista=0;
var delivery=0;
var tiendas=new Array();

$('#version-app').html(app_version);

function navegar(destino) {
    var menuCustom=$('#i-menu').hasClass('custom-menu-icon'); 
    var eltab=destino.split('-')
    app.panel.close();  
    $('.tab-link').removeClass( "tab-link-active" );
    if (destino=='#view-catalog'){  
        if (menuCustom){
            $('.custom-menu-icon').css('background-color',colorprimario);
        }
        muestragrupos();
        
    } 
    else {
        if (menuCustom){
            $('.custom-menu-icon').css('background-color','#979797');

        }
    }
    $('#tab-'+eltab[1]).addClass( "tab-link-active" );
    app.tab.show(destino);
}

function leeestilos(){
    var server=servidor+'includes/leeestilos.php';
    $.ajax({
        type: "POST",
        url: server,
        dataType:"json",
        success: function(data){
            var obj=Object(data);
            if (obj.valid==true){
                // app.setColorTheme('#00ff00')
                //class="dark"
                //$('#app').show();
                
                modooscuro=obj.modooscuro;
                breadcrumbs=data.breadcrumbs;
                if (data.modooscuro==1){
                    $('body').addClass('dark');
                }
                else {
                    $('.page').css( "background-color","white" );
                    $('.toolbar-inner').css( "background-color","rgba(255, 255, 255, 0.7)" );
                    $('.navbar-inner').css( "background-color","#fff" );
                    
                }
                app.setColorTheme(data.primario)    ;
                colorprimario=data.primario;
                colorsecundario=data.secundario;

                
                $('.secundario').css('color',colorsecundario);
                $('.secundario-BG').css('background-color',colorsecundario);

                $('.badge').css('background-color',colorsecundario);
                // estilo botones
                
                if (obj.estilo_boton_inicio==1){
                    $('#i-inicio').html('house_fill');
                }
                else {
                    $('#i-inicio').html('house_alt_fill');
                }
                if (obj.estilo_boton_menu==0){
                    //$('#i-inicio').html('house_fill'); 
                    //material-icons
                    $('#i-menu').html(''); 
                    $('#i-menu').removeClass('material-icons');
                    $('#i-menu').addClass('custom-menu-icon'); 
                    if (obj.tam_boton_menu==1){
                        $('#i-menu').css('width','28px');
                        $('#i-menu').css('height','28px');
                        $('#i-menu').css('bottom','0');
                    }
                    else{
                        $('#i-menu').css('width','48px');
                        $('#i-menu').css('height','48px');
                        $('#i-menu').css('bottom','10px');
                        $('#boton_menu').css('bottom','9px');
                    }
                    
                } 
                else {
                    if (obj.tam_boton_menu==1){
                        $('#i-menu').css('font-size','28px');
                        $('#i-menu').css('bottom','0');
                    }
                    else {
                        $('#i-menu').css('font-size','48px');
                        $('#i-menu').css('bottom','10px');

                    }
                
                    if (obj.estilo_boton_menu==1){
                        $('#i-menu').html('restaurant');
                    }
                    else {
                        if (obj.estilo_boton_menu==2){
                            $('#i-menu').html('room_service');

                        }
                        else {
                            $('#i-menu').html('fastfood');

                        }
                    }
                }
                if (obj.estilo_boton_carrito==1){
                    $('#i-carrito').html('<span class="badge badage-cart">4</span>shopping_cart');
                    $('#i-carrito').removeClass('f7-icons');
                    $('#i-carrito').addClass('material-icons');
                }
                else {
                    $('#i-carrito').html('<span class="badge  badage-cart">4</span>cart_fill');
                    $('#i-carrito').removeClass('material-icons');
                    $('#i-carrito').addClass('f7-icons');
                }
                $('input[name=tipo-boton-inicio]').each(function() {
                    if ($(this).val()==obj.estilo_boton_inicio){
                        $(this).prop('checked',true);
                    }
                });
                
                $('input[name=tipo-boton-menu]').each(function() {
                    if ($(this).val()==obj.estilo_boton_menu){
                        $(this).prop('checked',true);
                    }
                });
                
                $('input[name=tipo-boton-carrito]').each(function() {
                    if ($(this).val()==obj.estilo_boton_carrito){
                        $(this).prop('checked',true);
                    }
                });
                $('input[name=tam-boton-menu]').each(function() {
                    if ($(this).val()==obj.tam_boton_menu){
                        $(this).prop('checked',true);
                    }
                });
                
                
                if (("standalone" in window.navigator) &&  window.navigator.standalone){               
                    $('#tool-bar-menu-icon').css('bottom','15px');

                }
                $('#span-inicio').html(obj.boton_inicio);
              
                $('#boton_menu').html(obj.boton_menu);
                nameBreadcum=obj.boton_menu;
                $('#span-carrito').html(obj.boton_carrito);
                //tiempoenvio=obj.tiempoenvio;
                
            }
        }
    });
}

function muestranosotros() {
    app.tab.show('#view-nosotros');   
}

leeEstaoWeb();
// lee el estado de la web
function leeEstaoWeb() {
    var server=servidor+'includes/leeestadoweb.php';
    $.ajax({
        type: "POST",
        url: server,
        dataType:"json",
        success: function(data){
            var obj=Object(data);
            if (obj.valid==true){
                norepartomensaje=obj.norepartomensaje;
                portesgratis=obj.portesgratis;
                importeportesgratis=obj.importeportesgratis;
                portesgratismensaje=obj.portesgratismensaje;
                maximocarrito=obj.maximocarrito;
                reglamaximo=JSON.parse(obj.maximoproducto);
		   
                tipo_repartos=obj.tipo_repartos;
                whatsapp=obj.movil;
                idRedsys=obj.idRedsys;
                delivery=obj.delivery;
               //console.log('delivery:'+delivery); 
                tipo_seleccion_horas=obj.tipo_seleccion_horas;
                dias_vista=obj.dias_vista;
                //console.log(idRedsys);
                var nombre_comercial=obj.nombre_comercial;
                app.name=nombre_comercial;
                app.dialog.title=nombre_comercial;
                document.title = nombre_comercial;
                if (Array.isArray(obj.alias)){
                    for(x=0;x<obj.alias.length;x++){
                        tiendas.push({id:obj.id[x],alias:obj.alias[x],domicilio:obj.domicilio[x],telefono:obj.telefono[x],lat:obj.lat[x],lng:obj.lng[x],distancia:0});
                    }
                    if (obj.alias.length>0){
                        if  (window.localStorage.getItem('miPos') == undefined){
                            app.dialog.confirm('Para poder ofrecerle el restaurante más cercano vamos a solicitar su posición.','¡Atención!',function () {
                                funcionInitPos();

                            },function () {

                            });

                        }
                        else {
                            funcionInitPos();
                        }
                    }
                }
                
                if (obj.on==0){
                   //Web operativa
                    //muestragrupos();
                    fidelizacion=obj.fidelizacion;
                    window.localStorage.setItem("porcentaje_fidelizacion",encripta(obj.porcentaje));
                    por_fidelizacion=obj.porcentaje;
                    if (fidelizacion==0){
                        por_fidelizacion=0;
                        window.localStorage.setItem("porcentaje_fidelizacion",encripta(0));
                    }
                    tiempoenvio=obj.tiempoenvio;
                    cortesia=parseInt(obj.cortesia);
                    
                    integracion=obj.integracion;
                    pedidominimo=obj.pedidominimo;
                    cargainicio();
                    //console.log('Fidelizacion:'+fidelizacion);
                }
                else {
                    //Web NO operativa
                    
                    var txtMantenimiento='<div class="text-align-center"><img src="img/mantenimiento.png" width="90%" height="auto"></div>';
                    $('#pagina-inicio').html(txtMantenimiento);
                    $('#view-carrito .page-content').html(txtMantenimiento);
                    $('#view-catalog .page-content').html(txtMantenimiento);  
                    $('#buscador-productos').hide();
                    $('#view-usuario .page-content').html(txtMantenimiento);  
                }
            }
            else{
                console.log('ERROR Estado Web');
            } 
        }
        ,
        error: function (xhr, ajaxOptions, thrownError){
            console.log(xhr.status);
            console.log(thrownError);
            }
    });
}

// carga de view-nosotros
carganosotros();
function carganosotros(){ 
    $.ajax({
        type: "POST",
        url: servidor+'includes/leenosotros.php',
        dataType:"json",
        data:{isapp:isApp},
        success: function(data){
            var obj=Object(data);
            if (obj.valid==true){
                var tipo=obj.tipo;
                var texto=obj.texto;
                var id=obj.id;
                var txt='';
                for (x=0;x<id.length;x++){
                    if (tipo[x]=='1'){ //html
                        txt=txt+'<div>'+texto[x]+'</div>';
                    }
                    if (tipo[x]=='2'){ // javascript
                        var filename=servidor+'js_out/'+texto[x]+ '?v=' + Date.now();
                        var fileref = document.createElement('script');
                        fileref.setAttribute("type", "text/javascript");
                        fileref.setAttribute("src", filename);
                        if (typeof fileref != "undefined"){
                            document.getElementsByTagName("body")[0].appendChild(fileref);
                        }

                    }
                    if (tipo[x]=='3'){ // css
                        var filename=servidor+'css_out/'+texto[x]+ '?v=' + Date.now();
                        var fileref = document.createElement('link');
                        fileref.setAttribute("rel", "stylesheet");
                        fileref.setAttribute("type", "text/css");
                        fileref.setAttribute("href", filename)  ;

                        if (typeof fileref != "undefined"){
                            document.getElementsByTagName("body")[0].appendChild(fileref);
                        }

                    }
                    if (tipo[x]=='4'){ // Imagenes

                        var separados= new Array();
                        var src= new Array();
                        var prod= new Array();
                        var contenido=texto[x].split("||");
                        for (i=0;i<(contenido.length-1);i++){
                            separados[i]=contenido[i].split("##");
                        }
                        for (i=0;i<separados.length;i++){
                            src[i]=servidor+'img/upload/'+separados[i][0];
                            prod[i]=separados[i][1];
                        }       
                        var poner=new imagenesInicio(src,prod);
                        txt=txt+poner.contenido(0);
                    }
                }
                $('#nosotros-page').html(txt);

            }
            else {
                $('#contenedor-nosotros').html('Error leyendo página nosotros');    
            }
        }
    });
}

function cargainicio(){   
    $.ajax({
        type: "POST",
        url: servidor+'includes/leeinicio.php',
        dataType:"json",
        data:{isapp:isApp},
        success: function(data){
            var obj=Object(data);
            if (obj.valid==true){
                var tipo=obj.tipo;
                var texto=obj.texto;
                 var id=obj.id;
                var txt='';
                for (x=0;x<id.length;x++){
                    if (tipo[x]=='1'){ //html
                        txt=txt+'<div>'+texto[x]+'</div>';
                    }
                    if (tipo[x]=='2'){ // javascript
                        var filename=servidor+'js_out/'+texto[x]+ '?v=' + Date.now();
                        var fileref = document.createElement('script');
                        fileref.setAttribute("type", "text/javascript");
                        fileref.setAttribute("src", filename);
                        if (typeof fileref != "undefined"){
                            document.getElementsByTagName("body")[0].appendChild(fileref);
                        }

                    }
                    if (tipo[x]=='3'){ // css
                        var filename=servidor+'css_out/'+texto[x]+ '?v=' + Date.now();
                        var fileref = document.createElement('link');
                        fileref.setAttribute("rel", "stylesheet");
                        fileref.setAttribute("type", "text/css");
                        fileref.setAttribute("href", filename)  ;

                        if (typeof fileref != "undefined"){
                            document.getElementsByTagName("body")[0].appendChild(fileref);
                        }

                    }
                    if (tipo[x]=='5'){ // scroll
                        //console.log('hay destacados');

                        txt=txt+'<div class="marquee">'+
                                    '<div class="marquee-text">'+
                                    ''+texto[x]+''+//
                                    '</div>'+
                                '</div>';
                            //destacadosinicio('bloque-destacados-'+x);
                        
                    }
                    if (tipo[x]=='4'){ // Imagenes

                        var separados= new Array();
                        var src= new Array();
                        var prod= new Array();
                        var contenido=texto[x].split("||");
                        for (i=0;i<(contenido.length-1);i++){
                            separados[i]=contenido[i].split("##");
                        }
                        for (i=0;i<separados.length;i++){
                            src[i]=servidor+'img/upload/'+separados[i][0];
                            prod[i]=separados[i][1];
                            
                        }       
                        var poner=new imagenesInicio(src,prod);
                        txt=txt+poner.contenido(0);
                        
                    }
                }
                $('#pagina-inicio').html(txt);
                destacadosinicio();
            }
            else {
                $('#contenedor-inicio').html('Error leyendo página de inicio');
            }
        },
        error: function (xhr, ajaxOptions, thrownError){
            console.log(xhr.status);
            console.log(thrownError);
        }
    });
}

// destacados


function destacadosinicio(pagina='pagina-inicio',sitio='inicio'){
    //console.log('leer destacados');
    var server=servidor+'includes/leedestacados.php';
    $.ajax({
        type: "POST",
        url: server,
        dataType:"json",
        data:{sitio:sitio},
        success: function(data){
            var obj=Object(data);
            if (obj.valid==true){
                if (obj.id!=null){
                    if($("#prod-destacados-"+pagina).length == 0) {
                        if (obj.id.length>0){
                            //prod-destacados-catalog-page

                        $('#'+pagina).prepend("<p class='block-title'>Destacados</p><div id='prod-destacados-"+pagina+"'></div>");
                        var id=obj.id;
                        var producto=obj.producto;
                        var nombre=obj.nombre;
                        var cat=obj.cat;
                        var gru=obj.gru;
                        var idcat=obj.idcat;
                        var idgru=obj.idgru;
                        var imagen=obj.imagen;
                        var txt=''+
                        '<div class="swiper" style="display: flex;justify-content: center;align-items: center;">'+
                            '<div class="swiper-pagination"></div>'+
                            '<div class="swiper-wrapper">';
                        for (x=0;x<id.length;x++){
                            var lin= "'"+producto[x]+"','"+nombre[x]+"','"+idgru[x]+"','"+gru[x]+"','"+idcat[x]+"','"+cat[x]+"',' ',0";
                            var txt_gru='';
                            if (gru[x]==cat[x]){
                                txt_gru=gru[x];
                            }
                            else {
                                txt_gru=gru[x]+' - '+cat[x];
                            }
                            txt+=''+
                                '<div class="swiper-slide" onclick="navegar(\'#view-catalog\');muestraelproducto('+lin+');">'+
                                    '<img src="'+imagen[x]+'" width="200px" height="auto" style="border-radius:10px;"><br><span style="color: '+colorprimario+';" >'+nombre[x]+'</span><br><span style="color: '+colorsecundario+'; font-size: 11px;">'+txt_gru+'</span></div>';
                        }
                        txt+=''+
                            '</div>'+
                        '</div><br>';

                               //console.log('#'+bloque);

                                $('#prod-destacados-'+pagina).html(txt);
                                //$('#prod-destacados').html(txt);
                                app.swiper.create('.swiper', {
                                    allowTouchMove:true,
                                    spaceBetween: 10,

                                    //pagination: {
                                    //	  el: '.swiper-pagination',
                                    //	  type: 'bullets',
                                    //	},
                                    width:205,
                                    //loop:true,
                                    autoplay: {
                                       delay: 3000,
                                     },
                                    }
                                );

                        }

                    }
                }
            }
   
        },error: function (xhr, ajaxOptions, thrownError){
            console.log(xhr.status);
            console.log(thrownError);
        }
    });  
}

 
// TPV
var w = screen.width; 
var h = screen.height; 

//$('#iframe_tpv').css('width',w+'px');
var htpv=$('#content-tpv').css('height');
var htool=$('#tool-bar').css('height');
var hnav=$('.navbar').css('height');
var hiframe=parseInt(h)-parseInt(hnav);

$('#iframe_tpv').css('height',hiframe+'px');

// mensaje de TPV
window.onmessage=function(msg) {
    myTimeoutTarjetaActivo='no';
    var partes=msg.data.split("###");
    var idpedido=partes[0];
    var estado=partes[1];
    var importe=partes[2];
    var numero=partes[3];
    navegar('#view-catalog');
    app.toolbar.show('.toolbar-bottom');
    //$('#boton-menu-principal').show();
    $('page').css('padding-bottom','70px');
    if (estado=='OK'){  
        
        muestraMensaje('Pedido '+numero+' pagado correctamente',titulo='',subtitulo='Pago tarjeta','pedido-pagado.jpg', tiempo=5000);
        borradatoscompra();
        // sólo cuando tarjetas esta en test
        //finalizaPedido(idpedido,numero,1);
    }
    else {
        //app.dialog.alert('Pedido '+pedido+' NO se pagó');
        app.dialog.alert('Pedido '+numero+' NO se pagó y se ha cancelado',
            function () {
                // CANCELAR
                cancelaPedido(idpedido);
                $('.subnavbar').show();
                $('#search').show();
                $('.toolbar-bottom').show();
                $('#boton-menu-principal').show();
                navegar('#view-catalog');
                //muestragrupos();
               
            }
        
        );

    }
};

// lee un archivo de texto
function leetexto(titulo,archivo) {
    $.ajax({
        url: servidor+'includes/leetexto.php',
        data:{archivo:archivo},
        method: "post",
        dataType:"json",
        success: function(data){    
            var obj=Object(data);
            if (obj.valid==true){
                muestraAviso(titulo,obj.lineas);
            }
            else{
                console.log(obj.valid);
                app.dialog.alert('No se pudo leer '+titulo);
            }
        }
    });

}

// muestra aviso en popup
function muestraAviso(titulo,lineas) {
    var texto="";
    for(var x=0;x<lineas.length;x++){
        texto+=lineas[x];
    }
    var dynamicPopup = app.popup.create({
        content:  ''+
          '<div class="popup">'+
            '<div class="block page-content">'+
              '<p class="text-align-left"><a href="javascript:cierraEstePop();" class="link popup-close"><i class="icon f7-icons ">xmark</i></a></p>'+
                ' <div class="block-title block-title-medium">'+titulo+'</div>'+
                '<div class="block">'+texto+'<br></div>'+
            '</div>'+
          '</div>'
         ,
        // Events
        on: {
          open: function (popup) { 
              
              
          },
          opened: function (popup) {
          },
        }
        
    });  
    dynamicPopup.on('close', function (popup) {
      });
      dynamicPopup.on('closed', function (popup) {
      });
    dynamicPopup.open();
    
}

// muestra mensaje
function muestraMensaje(texto,titulo='',subtitulo='',imagen='',tiempo=4000){
    if (titulo==''){
        titulo=app.name;
    }
    if (imagen!=""){
        texto+='<br><br><div style="text-align:center;"><img src="'+servidor+'/img/upload/'+imagen+'" width="90%" height="auto"></div>';
    }
    //console.log(texto);
    var not2=app.notification.create({
        text: texto,
        icon: '<img src="img/icon.png">',
        title: titulo,
        //titleRightText: 'now',
        subtitle: subtitulo,
        titleRightText: 'ahora',
    
          closeTimeout:tiempo,
              on: {
                opened: function () {
                  //console.log('Notification opened')
                },
          }
    });
    not2.open(); 
    
}

// cierra popup
function cierraEstePop(){
    app.popup.close();
}

// clase imagenesInicio
class imagenesInicio {
    constructor(img, prod) {
        //console.log(img);
        this.img = img;
        this.prod = prod;
        this.indice=1;
        this.elem=makeid(5);
        //console.log(this.elem);
        if (this.indice>=(this.img.length)){
            this.indice=0;
        } 
        setInterval(
                    this.cambiaimg.bind(this),
                    5000
                );
    }  
    contenido(empieza) {
        
        var txt='<div style="text-align:center;"><img class="imagen imagen-inicio" id="imgInicio'+this.elem+'" data="'+this.prod[empieza]+'" src="'+this.img[empieza]+'" width="100%" height="auto" onclick="clicenImgInicio(this);"></div>';
        return txt;
        
       
        
    }
    cambiaimg(){
        
        $('#imgInicio'+this.elem).attr('src',this.img[this.indice]);
        $('#imgInicio'+this.elem).attr('data',this.prod[this.indice]);
        this.indice++;
        if (this.indice>=(this.img.length)){
            this.indice=0;
        }  
    }  
}

// genera id aleatoria
function makeid(length) {
    var result           = '';
    var characters       = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
    var charactersLength = characters.length;
    for ( var i = 0; i < length; i++ ) {
      result += characters.charAt(Math.floor(Math.random() * 
 charactersLength));
   }
    
   return result;
}

function encripta(texto){
    var clave="";
    var largo=0;
    var aencriptar=texto.toString();
    do {
      clave+=app.name;
      largo=clave.length;
    }
    while (largo< aencriptar.length);
    var num=new Array();
    var num2=new Array();
    var encript='';
    for (x=0;x<clave.length;x++){
        num[x]=clave.charCodeAt(x);
    }
    for (x=0;x<aencriptar.length;x++){
        num2[x]=aencriptar.substr(x).charCodeAt(0);;
    }
    
    for (x=0;x<aencriptar.length;x++){
        if(x<clave.length){
            encript+=(num[x]*num2[x])+'.';
        }
    }
    encript=encript.substring(0, encript.length - 1);

    return encript;
}

function desencripta(texto){
    var clave="";
    var largo=0;
    var decript=texto.split('.');
    do {
      clave+=app.name;
      largo=clave.length;
    }
    while (largo <decript.length);
    var num=new Array();
    var ele=0;  
    var desencript='';
    for (x=0;x<clave.length;x++){
        num[x]=clave.charCodeAt(x);
    }
    for (x=0;x<decript.length;x++){
        ele=decript[x]/num[x];
        desencript+=String.fromCharCode(ele);
    }
    return desencript; 
}

/*
if ("cookiePrimera" in localStorage) { 
   
} else {
     cookieFirst();
}
*/

function cookieFirst() {
    window.localStorage.setItem("cookiePrimera","si");
    var txtWeb="App";
    if(isApp==false){                
        txtWeb="Web";
    } 
    var txt=''+
 
        '<div class="grid grid-cols-3 grid-gap">'+
          '<div class="">'+
            '<span style="font-size:1.2em;">Esta '+txtWeb+' <b>NO</b> usa cookies.</span>'+
          '</div>'+
           '<div class="">'+
            '<button class="button button-fill button-round toast-close">Entendido</button>'+
          '</div>'+
           '<div class="">'+
            '<button class="button button-outline button-round saber-cookies toast-close">Saber más</button>'+
          '</div>'+
        '</div>';

    $('#cookie-first').html(txt);
    
    $('#cookie-first').show();
    
    $('.toast-close').on('click', function () {
        $('#cookie-first').hide();
    });
    $('.saber-cookies').on('click', function () {
        
        var txt=''+
            '<div class="popup">'+
                '<div class="page-content">'+
                    '<div class="block">'+
                        '<p style="font-size:1.2em;">Esta '+txtWeb+' <b>NO</b> usa cookies.</p>'+
                        '<p style="font-size:1.2em;">La tecnología usada es <b>localStorage</b>. localStorage se guarda en el dispositivo y no puede ser leido por nadie más que esta '+txtWeb+', es más seguro y rápido que las cookies convencionales.</p>'+
                        '<p style="font-size:1.2em;">Se usa para guardar tus preferencias de uso de esta '+txtWeb+' como puede ser los datos del carrito, tus datos de usuarios y otros elementos. </p>'+
                        '<p style="font-size:1.2em;"><b>localStorage</b> se elimina al borrar esta '+txtWeb+'. </p>'+
                        '<div style="width: 50%;margin:auto;">'+
                       
                            '<button class="button button-fill button-round ink popup-close">Entendido</button>'+
                      
                        '</div>'+
                    '</div>'+
                '</div>'+
            '</div>';
            var dynamicPopup = app.popup.create({
              content: txt
            });     
            dynamicPopup.open(); 
            
        
    });
    

}



const funcionInitPos = () => {
	if ("geolocation" in navigator) {
        
        const onUbicacionConcedida = ubicacion => {
            localStorage.setItem("miPos",'ok');
            localStorage.setItem("miPosLat",ubicacion['coords']['latitude']);
            localStorage.setItem("miPosLng",ubicacion['coords']['longitude']);
            //console.log("ubicación: ", ubicacion);
        }

        const onErrorDeUbicacion = err => {
            console.log("Error obteniendo ubicación: ", err);
            localStorage.setItem("miPos",'ko');
        }

        const opcionesDeSolicitud = {
            enableHighAccuracy: true, // Alta precisión
            maximumAge: 500, // No queremos caché
            timeout: 5000 // Esperar solo 5 segundos
        };
        // Solicitar
        navigator.geolocation.getCurrentPosition(onUbicacionConcedida, onErrorDeUbicacion, opcionesDeSolicitud);
	}
};




const gradosARadianes = (grados) => {
    return grados * Math.PI / 180;
};

const calcularDistanciaEntreDosCoordenadas = (lat1, lon1, lat2, lon2) => {
    // Convertir todas las coordenadas a radianes
    lat1 = gradosARadianes(lat1);
    lon1 = gradosARadianes(lon1);
    lat2 = gradosARadianes(lat2);
    lon2 = gradosARadianes(lon2);
    // Aplicar fórmula
    const RADIO_TIERRA_EN_KILOMETROS = 6371;
    let diferenciaEntreLongitudes = (lon2 - lon1);
    let diferenciaEntreLatitudes = (lat2 - lat1);
    let a = Math.pow(Math.sin(diferenciaEntreLatitudes / 2.0), 2) + Math.cos(lat1) * Math.cos(lat2) * Math.pow(Math.sin(diferenciaEntreLongitudes / 2.0), 2);
    let c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    return RADIO_TIERRA_EN_KILOMETROS * c;
};

function clicenImgInicio(e) {
   
    var elprod=$(e).attr('data');
    if(elprod!=""){
        navegar('#view-catalog');
        muestraproductoinicio(elprod);
        //app.searchbar.toggle();
        //alert (elprod);
    }
}


